<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/rcf8lia5mgb48sf87a4rrm8ywbo8fnmzelggfqr0xrqcnsah/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>





    <style>
        :root {
            --primary: linear-gradient(to right, #0033ff, #00ffbf); /* <-- Updated value */
            --primary-solid: #0066ff; /* <-- ADD THIS LINE */
            --accent: #00ffbf;
            --dark: #0d1b2a;
            --background: #f8f9fa;
            --text: #212529;
            --success: #28a745;
        }

         body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--background);
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            scrollbar-width: none; /* <-- ADD THIS LINE (for Firefox) */
            -ms-overflow-style: none;  /* <-- ADD THIS LINE (for IE/Edge) */
        }

        body::-webkit-scrollbar {
            display: none;
        }


        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
        }

        .header-left,
        .header-center,
        .header-right {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .header-left {
            justify-content: flex-start;
        }

        .header-center {
            justify-content: center;
        }

        .header-right {
            justify-content: flex-end;
            gap: 10px;
        }

        .header-left .logo {
            text-decoration: none;
            color: var(--text);
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
        }

        .header-center p {
            font-size: 1.1em;
            font-weight: bold;
        }

        .header-right {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .header-right input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .login-btn {
            background-image: linear-gradient(to right, #0033ff, #00ffbf);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: normal; /* Changed from bold to normal */
            font-size: 1em;
            transition: background 0.3s ease;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, #00ffbf, #0033ff);
            transform: scale(1.05);
            color: #fff !important;
        }

        main {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto; /* <-- ADD THIS LINE */
        }

        .page {
            display: none;
        }

        .excerpt {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Add this rule to constrain images within the article content area */
        #article-content img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .page.active {
            display: flex; /* <-- This is the main fix */
            flex-direction: column; /* Stack header and main vertically */
            flex-grow: 1; /* Allow the page to fill available space */
            height: 100vh;
        }
        .profile-section, .content-section, .auth-form {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .auth-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 25px;
            text-align: center;
        }

        .auth-form h2 {
            margin-top: 0;
        }

        .auth-form input {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .auth-form button {
            width: 100%;
            padding: 10px;
            /* Use the gradient here instead of the solid color */
            background-image: linear-gradient(to right, #0033ff, #00ffbf); 
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease; /* Transition all properties for a smooth hover */
        }

        /* Optional: Add a nice hover effect */
        .auth-form button:hover {
            transform: scale(1.02);
            background-image: linear-gradient(to left, #0033ff, #00ffbf);
            box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4);
        }

        .auth-form a {
            display: block;
            margin-top: 15px;
            text-decoration: none;
            font-size: 0.9em;   /* Slightly increase size for better visibility */
            transition: filter 0.3s ease; /* Add a smooth hover effect */

            /* 1. Set the background to our gradient variable */
            background: var(--primary);

            /* 2. Clip the background to the text */
            -webkit-background-clip: text;  /* For Safari/Chrome */
            background-clip: text;

            /* 3. Make the text transparent to reveal the gradient */
            color: transparent;
        }

        .auth-form a:hover {
            filter: brightness(1.2);
        }
        
        .background-animations {
            position: fixed; /* Keep it fixed in the background */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Place it BEHIND all other content */
            overflow: hidden; /* Hide anything that floats off-screen */
        }

        /* The individual floating items */
        .background-animations {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-item {
            position: absolute;
            /* FROM a solid color TO a transparent gradient */
            background-image: linear-gradient(135deg, rgba(0, 51, 255, 0.15), rgba(0, 255, 191, 0.15));
            border: 1px solid rgba(0, 102, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 102, 255, 0.1);
            animation: floatAnimation ease-in-out infinite;
        }

        @keyframes floatAnimation {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-25px) rotate(10deg);
                opacity: 1;
            }
            100% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.8;
            }
        }

        /* --- Positioning for all 15 items to fill the space --- */
        
        .logo-img {
            height: 35px; /* You can adjust this value to make the logo bigger or smaller */
            vertical-align: middle; /* Helps align it nicely with other header items */
        }

        .bg-item:nth-child(1) {
            top: 15%;
            left: 10%;
            width: 150px;
            height: 150px;
            animation-duration: 12s;
            animation-delay: -3s;
        }

        .bg-item:nth-child(2) {
            top: 20%;
            right: 15%;
            width: 80px;
            height: 80px;
            animation-duration: 9s;
        }

        .bg-item:nth-child(3) {
            bottom: 10%;
            left: 25%;
            width: 120px;
            height: 120px;
            animation-duration: 10s;
            animation-delay: -5s;
        }

        .bg-item:nth-child(4) {
            top: 65%;
            left: 5%;
            width: 60px;
            height: 60px;
            animation-duration: 15s;
        }

        .bg-item:nth-child(5) {
            bottom: 15%;
            right: 20%;
            width: 180px;
            height: 180px;
            animation-duration: 11s;
            animation-delay: -1s;
        }

        .bg-item:nth-child(6) {
            top: 5%;
            left: 40%;
            width: 70px;
            height: 70px;
            animation-duration: 13s;
        }

        .bg-item:nth-child(7) {
            bottom: 5%;
            left: 65%;
            width: 110px;
            height: 110px;
            animation-duration: 8s;
            animation-delay: -2s;
        }

        .bg-item:nth-child(8) {
            top: 50%;
            right: 5%;
            width: 90px;
            height: 90px;
            animation-duration: 10s;
        }

        /* --- NEW ITEMS to fill empty space --- */
        .bg-item:nth-child(9) {
            top: 80%;
            left: 50%;
            width: 85px;
            height: 85px;
            animation-duration: 14s;
        }

        .bg-item:nth-child(10) {
            top: 10%;
            left: 70%;
            width: 130px;
            height: 130px;
            animation-duration: 9s;
            animation-delay: -4s;
        }

        .bg-item:nth-child(11) {
            top: 40%;
            left: 20%;
            width: 55px;
            height: 55px;
            animation-duration: 12s;
        }

        .bg-item:nth-child(12) {
            bottom: 30%;
            left: 80%;
            width: 75px;
            height: 75px;
            animation-duration: 10s;
        }

        /* In index.html, add this inside the <style> tag */

        /* --- Account Type Selection Styles --- */
        .account-type-selection-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 40px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .account-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 220px;
            height: 200px;
            border: 2px solid #ddd;
            border-radius: 15px;
            background-color: #fff;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .account-type-btn i {
            font-size: 3em;
            margin-bottom: 15px;
            background: var(--primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: filter 0.3s ease;
        }

        .account-type-btn h3 {
            margin: 0 0 5px 0;
            color: var(--text);
            font-size: 1.3em;
        }

        .account-type-btn p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        .account-type-btn:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(0, 51, 255, 0.2);
            border-color: var(--primary-solid);
        }

        .account-type-btn:hover i {
            filter: brightness(1.2);
        }

        /* --- Dynamic Form Field Styling --- */
        .form-field-wrapper {
            margin-bottom: 10px;
        }
        .form-field-wrapper label {
            display: block;
            text-align: left;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Ensure inputs inside wrappers are full width */
        .form-field-wrapper input,
        .form-field-wrapper select {
            width: calc(100% - 20px); /* Match existing input styling */
            padding: 10px;
            margin: 0; /* Reset margin for wrapped inputs */
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .bg-item:nth-child(13) {
            top: 55%;
            left: 45%;
            width: 100px;
            height: 100px;
            animation-duration: 16s;
            animation-delay: -7s;
        }

        .bg-item:nth-child(14) {
            bottom: 45%;
            right: 35%;
            width: 65px;
            height: 65px;
            animation-duration: 9s;
        }

        .bg-item:nth-child(15) {
            top: 85%;
            right: 10%;
            width: 140px;
            height: 140px;
            animation-duration: 11s;
        }

        /* This new div will handle the scrolling */
        .profile-row-scroller {
            overflow-x: hidden;
            padding-bottom: 5px; /* Add a little space for the scrollbar */
        }

        .profile-row {
            display: flex;
            white-space: nowrap;
            flex-wrap: nowrap;
            padding: 15px 5px; /* Add vertical padding to make room for the glow */
        }

        /* The profile item is now back to its simpler form */
        .profile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
            text-decoration: none;
            color: #333;
            cursor: pointer;
            flex-shrink: 0;
        }

        .user-username-text {
            color: #8e8e8e; /* A lighter gray color */
            font-size: 1.1em;
            margin-top: -2px; /* Pull it closer to the full name */
            margin-bottom: 15px;
        }

        .profile-pic {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
        }


        .profile-pic.user-selected {
            border-color: var(--primary);
            border-width: 4px;
        }

        .profile-name {
            margin-top: 5px;
            font-size: 0.9em;
        }

        .profile-item.more .profile-pic::after {
            content: '...';
            font-size: 2em;
            color: #555;
            line-height: 1;
        }
        
        .profile-item.more .profile-pic {
            background-image: none; /* Remove the default avatar */
            background-color: #e0e0e0; /* Give it a gray background */
        }

        .more-link {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 0.9em;
            color: var(--primary);
            text-decoration: none;
        }

        .content-section h3 {
            margin: 0;
            margin-bottom: 10px;
        }

        .side-nav {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: 60px;
            background-color: #fff;
            border-right: 1px solid #ddd;
            display: none;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            padding-bottom: 20px;
            z-index: 10;
        }

        .nav-top, .nav-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-item {
            position: relative;
            width: 35px;            /* Reduced from 40px */
            height: 35px;           /* Reduced from 40px */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;    /* Kept margin for spacing */
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .nav-item i {
            font-size: 1.2em;       /* Reduced from 1.5em */
            transition: filter 0.3s ease, transform 0.3s ease;
            background: var(--primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .user-mention {
            font-weight: bold;
            color: var(--primary-solid); /* Uses your existing blue color */
            text-decoration: underline;
            cursor: pointer;
        }
        .user-mention:hover {
            filter: brightness(1.2); /* Adds a nice hover effect */
        }

        .nav-item:hover {
            background-color: #f0f2f5;
        }

        body.with-sidebar main,
        body.with-sidebar header {
            margin-left: 60px;
        }

        .profile-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #e74c3c; /* A nice red color */
            color: white;
            border-radius: 50%;
            padding: 1px 5px;
            font-size: 0.7em;
            font-weight: bold;
            min-width: 10px;
            text-align: center;
            line-height: 1.3;
            border: 2px solid white; /* Helps it stand out from the icon */
            transform: translate(40%, -40%); /* Nudges it to the top-right corner */
        }

        .profile-pic-large {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
        }

        h2 {
            margin: 0;
            font-size: 1.8em;
        }

        .profile-card p {
            color: #555;
            margin: 5px 0 10px;
        }

        .auth-form select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff; /* Ensures a white background */
        }

        /* --- Profile Picture Styles --- */

        /* Update the base profile pic styles */


        .nav-user-pic {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
        }

        /* Styles for the Edit Profile page uploader */
        .edit-profile-pic {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .change-photo-label {
            color: var(--primary-solid);
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .circuit-card.no-image {
            background-color: #e9ecef; /* A nice light gray */
            color: #495057;           /* A darker text color for readability */
            text-shadow: none;         /* Remove the shadow meant for images */
        }

        .circuit-card.no-image::before {
            display: none; /* This hides the dark overlay when there's no image */
        }

        .chat-button {
            background-image: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
        }

        .chat-button:hover {
            background-color: #0056b3;
        }

        .profile-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        footer {
            background-color: #fff;
            border-top: 1px solid #ddd;
            padding: 20px 0; /* Increased vertical padding */
            text-align: center;
            margin-top: 40px;
        }

        .footer-content {
            display: flex;
            flex-direction: column; /* Stack version, links, copyright vertically */
            align-items: center;
            gap: 12px; /* Vertical gap between each element */
        }

        .footer-left {
            order: -1; /* Keep version label at the top */
        }

        .version-label {
            display: inline-block;
            font-size: 0.85em;
            background: var(--primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px; /* Small spacing below version */
        }

        .footer-links {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .footer-links a {
            text-decoration: none;
            color: #555;
            font-size: 0.9em;
            transition: color 0.2s ease;
        }

        .footer-links a:hover {
            color: var(--primary-solid);
        }

        .footer-content p {
            font-size: 0.8em;
            color: #888;
            margin-top: 10px;
        }

        .profile-buttons button {
            background-image: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease; /* Add this line */
        }

        .profile-row .circuit-card {
            margin-right: 15px;
            flex-shrink: 0;
        }




        .profile-buttons button:hover {
            transform: scale(1.05); /* Increase size */
            filter: brightness(1.15); /* Brighten the gradient */
        }

        .chat-window {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 300px;
            height: 400px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .chat-input {
            position: relative; /* Needed for positioning the emoji panel */
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 1.8em; /* A little bigger */
            color: #a9a9a9;  /* Gray color */
            cursor: pointer;
            margin-right: 10px;
            transition: color 0.2s ease; /* Smooth hover effect */
        }
        .emoji-btn:hover {
            color: #333; /* Darker gray on hover */
        }
        .emoji-panel {
            position: absolute;
            bottom: 60px; /* Position it above the input bar */
            left: 35px;
            transform: translateX(-50%);
            width: 280px;
            height: 200px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            padding: 10px;
            overflow-y: auto;
        }
        .emoji-panel.hidden {
            display: none;
        }
        .emoji-panel span {
            cursor: pointer;
            font-size: 1.5em;
            text-align: center;
            transition: transform 0.1s ease;
        }
        .emoji-panel span:hover {
            transform: scale(1.2);
        }

        .chat-header {
            padding: 10px;
            background-color: var(--accent);
            color: #fff;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header span {
            font-weight: bold;
        }

        .chat-header .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
        }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #ddd;
        }

        .chat-input {
            position: relative;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #dbdbdb;
        }

        .chat-input .emoji-btn {
            background: none !important; /* Use !important to override other button styles */
            border: none !important;
            font-size: 1.8em;
            color: #a9a9a9;
            cursor: pointer;
            margin-right: 10px;
            padding: 0; /* Remove default button padding */
            transition: color 0.2s ease;
        }

        .chat-input .emoji-btn:hover {
            color: #333;
        }


        /* --- NEW Magical Follow Animation Styles --- */

        /* 1. Glowing Hover Effect for the blue 'Follow' button */
        .follow-btn:not(.following):hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px 5px rgba(0, 200, 220, 0.4);
        }

        /* 2. The temporary class for the click animation */
        .follow-btn.following-anim {
            animation: follow-click-effect 0.5s ease-in-out;
        }

        /* 3. The keyframes for the button click effect */
        @keyframes follow-click-effect {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); box-shadow: 0 0 30px var(--accent); }
            100% { transform: scale(1); }
        }

        /* 4. The star elements */
        .star {
            position: absolute;
            font-size: 1.5em;
            line-height: 1;
            pointer-events: none;
            animation: star-pop 0.8s ease-out forwards;
        }

        /* 5. The keyframes for the stars popping out */
        @keyframes star-pop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                /* Move to the random final position (set by JS) */
                transform: translate(var(--x), var(--y)) scale(1.5);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }

        .chat-message.sent .user-mention {
            color: #ffffff;
            text-decoration: underline;
        }

        #emoji-panel {
            position: absolute;
            bottom: 65px; /* Increase distance from the input bar */
            left: 5px;
            transform: translateX(80%);
            width: 280px;
            height: 200px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            padding: 10px;
            overflow-y: auto;
            z-index: 1001; /* Ensure it's above other elements */
        }

        #emoji-panel.hidden {
            display: none;
        }

        .emoji-panel span {
            cursor: pointer;
            font-size: 1.5em;
            text-align: center;
            transition: transform 0.1s ease;
            -webkit-user-select: none; /* For Safari/Chrome */
            user-select: none;
        }

        #emoji-panel span:hover {
            transform: scale(1.2);
        }

        .hidden {
            display: none !important;
        }


        .chat-input input {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .chat-input button {
            background-image: var(--primary);
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 5px;
            cursor: pointer;
        }



        /* The timestamp text */
        .message-timestamp {
            font-size: 0.7em;
            color: #8e8e8e;
            margin: 0 8px 4px;
            white-space: nowrap;
        }


        .messages-list {
            list-style: none;
            padding: 0;
        }

        .messages-list li {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }



        .messages-container {
            width: 100%;
            /* height: 100%; */
            display: flex;
            background-color: #fff;
            overflow: hidden;
        }

        .chat-list-pane {
            flex-basis: 300px; /* Fixed width for chat list */
            border-right: 1px solid #dbdbdb;
            display: flex;
            flex-direction: column;
        }


        .user-bio-text {
            color: #555;
            margin: 10px 0;
            font-style: italic;
            word-wrap: break-word; /* Helps wrap long words */
            word-break: break-all; /* Breaks text at any character to prevent overflow */
        }

        .auth-form textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            resize: vertical;
        }

        /* 2. Left Pane: The Chat List */
        .chat-list-header {
            padding: 20px;
            border-bottom: 1px solid #dbdbdb;
            text-align: center;
        }
        .chat-list-header h4 {
            margin: 0;
            font-size: 1.2em;
        }
        .chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
        }

        .new-chat-list-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
        }
        .new-chat-list-item:hover {
            background-color: #f9f9f9;
        }
        .new-chat-list-item input[type="radio"] {
            margin-right: 15px;
            /* Make the radio button larger and easier to click */
            width: 18px;
            height: 18px;
        }
        .new-chat-list-item .profile-pic {
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }

        .chat-context-separator {
            text-align: center;
            margin: 20px 0;
            font-size: 0.8em;
            font-weight: bold;
            color: #999;
            display: flex;
            align-items: center;
        }

        .chat-context-separator::before,
        .chat-context-separator::after {
            content: '';
            flex-grow: 1;
            height: 1px;
            background-color: #eee;
            margin: 0 15px;
        }

        .system-message {
            text-align: center;
            margin: 15px 0;
            font-size: 0.85em;
            font-style: italic;
            color: #888;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .chat-list-item:hover {
            background-color: #f9f9f9;
        }
        .chat-list-item.active {
            background-color: #efefef;
        }
        .chat-list-item .profile-pic {
            width: 50px; /* Smaller pic for the list */
            height: 50px;
            margin-right: 15px;
        }
        .chat-list-item .chat-info {
            flex-grow: 1;
        }
        .chat-list-item .chat-info .name {
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
        }
        .chat-list-item .chat-info .snippet {
            font-size: 0.9em;
            color: #8e8e8e;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .active-chat-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
            width: 100%;
            height: 100%;
        }


        /* 3. Right Pane: Active Chat Window */
        .active-chat-header {
            display: flex;
            align-items: center; /* This is the key fix: vertically centers items */
            padding: 10px 20px;
            border-bottom: 1px solid #dbdbdb;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .active-chat-header:hover {
            background-color: #f9f9f9;
        }

        .active-chat-header .profile-pic {
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }

        .active-chat-header p {
            margin: 0;
            font-weight: 600;
        }





        /* Modern chat input */
        .chat-input {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #dbdbdb;
        }

        .fancy-back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px; /* Space between icon and text */
            padding: 8px 16px;
            background-color: #f0f2f5; /* Light gray background */
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95em;
            border-radius: 20px; /* Rounded pill shape */
            transition: background-color 0.2s ease, transform 0.2s ease;
            border: 1px solid #e0e0e0;
        }

        .fancy-back-button:hover {
            background-color: #e4e6eb; /* Slightly darker on hover */
            transform: scale(1.03);
        }

        .fancy-back-button i {
            font-size: 0.9em;
            margin-right: 2px;
        }

        .chat-input input {
            flex-grow: 1;
            border: 1px solid #dbdbdb;
            border-radius: 20px; /* Pill shape */
            padding: 10px 15px;
            background-color: #fff;
            outline: none;
        }
        .chat-input button {
            background: none; /* No background */
            border: none;
            color: var(--primary-solid); /* Use your solid primary color */
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            margin-left: 15px;
        }
        .follow-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
        }

        .follow-btn.following {
            background-color: #e0e0e0;
            color: #333;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .profile-pic:not(.nav-user-pic).birthday-user::after,
        .profile-pic-large.birthday-user::after {
            background-image: none !important;
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: '\f1fd';
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e91e63;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            position: absolute;
            z-index: 3;
            top: auto; left: auto;
            bottom: -4px; right: -4px;
            width: 24px; height: 24px;
            font-size: 12px;
        }
        .profile-pic-large.birthday-user::after {
            bottom: -6px; right: -6px;
            width: 40px; height: 40px;
            font-size: 20px;
        }

        .lounge-cover-preview-banner {
            height: 120px; /* Make it a wide rectangle */
            background-size: cover; /* Make the image fill the banner */
            background-position: center;
        }

        /* 2. Styles for the new privacy option cards */
        .privacy-options-container {
            display: flex;
            justify-content: space-between;
            gap: 15px; /* Space between the cards */
        }

        .privacy-options-container label {
            flex: 1; /* Make each label take up equal space */
            cursor: pointer;
        }

        /* Hide the original radio button */
        .privacy-options-container input[type="radio"] {
            display: none;
        }

        .privacy-option-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            height: 100%; /* Make cards fill the label height */
        }

        .privacy-option-card:hover {
            border-color: #bbb;
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .privacy-option-card i {
            font-size: 1.8em;
            color: #555;
            margin-bottom: 10px;
        }

        .privacy-option-card h4 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
        }

        .privacy-option-card p {
            margin: 0;
            font-size: 0.85em;
            color: #777;
            line-height: 1.4;
        }

        /* Style for the SELECTED card */
        .privacy-options-container input[type="radio"]:checked + .privacy-option-card {
            border-color: var(--primary-solid);
            box-shadow: 0 0 15px rgba(0, 102, 255, 0.2);
            background-color: #f7faff;
        }

        .privacy-options-container input[type="radio"]:checked + .privacy-option-card i {
            background: var(--primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .code-input-container {
            margin: 25px 0;
        }

        #verificationCodeInput {
            font-size: 2.5em; /* Make digits large */
            letter-spacing: 15px; /* Space out the digits */
            text-align: center;
            padding-left: 15px; /* Adjust padding because of letter-spacing */
            border: 2px solid #ddd;
            border-radius: 8px;
            width: calc(100% - 44px); /* Full width minus padding/border */
            background-position: 15px 0; /* This line doesn't hurt to keep */
            box-sizing: border-box; /* Include padding/border in width */
        }

        #verificationCodeInput:focus {
            border-color: var(--primary-solid);
            box-shadow: 0 0 8px rgba(0, 102, 255, 0.3);
        }

        /* Style placeholder */
        #verificationCodeInput::placeholder {
            color: #e0e0e0;
            letter-spacing: 15px; /* Match letter spacing */
        }

        .loader {
            --background: linear-gradient(135deg, #23C4F8, #275EFE);
            --shadow: rgba(39, 94, 254, 0.28);
            --text: #6C7486;
            --page: rgba(255, 255, 255, 0.36);
            --page-fold: rgba(255, 255, 255, 0.52);
            --duration: 3s;
            width: 200px;
            height: 140px;
            position: relative;
        }

        .loader:before, .loader:after {
            --r: -6deg;
            content: "";
            position: absolute;
            bottom: 8px;
            width: 120px;
            top: 80%;
            box-shadow: 0 16px 12px var(--shadow);
            transform: rotate(var(--r));
        }

        .loader:before {
            left: 4px;
        }

        .loader:after {
            --r: 6deg;
            right: 4px;
        }

        .loader div {
            width: 100%;
            height: 100%;
            border-radius: 13px;
            position: relative;
            z-index: 1;
            perspective: 600px;
            box-shadow: 0 4px 6px var(--shadow);
            background-image: var(--background);
        }

        .loader div ul {
            margin: 0;
            padding: 0;
            list-style: none;
            position: relative;
        }

        .loader div ul li {
            --r: 180deg;
            --o: 0;
            --c: var(--page);
            position: absolute;
            top: 10px;
            left: 10px;
            transform-origin: 100% 50%;
            color: var(--c);
            opacity: var(--o);
            transform: rotateY(var(--r));
            -webkit-animation: var(--duration) ease infinite;
            animation: var(--duration) ease infinite;
        }

        .loader div ul li:nth-child(2) {
            --c: var(--page-fold);
            -webkit-animation-name: page-2;
            animation-name: page-2;
        }

        .loader div ul li:nth-child(3) {
            --c: var(--page-fold);
            -webkit-animation-name: page-3;
            animation-name: page-3;
        }

        .loader div ul li:nth-child(4) {
            --c: var(--page-fold);
            -webkit-animation-name: page-4;
            animation-name: page-4;
        }

        .loader div ul li:nth-child(5) {
            --c: var(--page-fold);
            -webkit-animation-name: page-5;
            animation-name: page-5;
        }

        .loader div ul li svg {
            width: 90px;
            height: 120px;
            display: block;
        }

        .loader div ul li:first-child {
            --r: 0deg;
            --o: 1;
        }

        .loader div ul li:last-child {
            --o: 1;
        }

        .loader span {
            display: block;
            left: 0;
            right: 0;
            top: 100%;
            margin-top: 20px;
            text-align: center;
            color: var(--text);
        }

        @keyframes page-2 {
            0% {
                transform: rotateY(180deg);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            35%, 100% {
                opacity: 0;
            }

            50%, 100% {
                transform: rotateY(0deg);
            }
            }

        @keyframes page-3 {
            15% {
                transform: rotateY(180deg);
                opacity: 0;
            }

            35% {
                opacity: 1;
            }

            50%, 100% {
                opacity: 0;
            }

            65%, 100% {
                transform: rotateY(0deg);
            }
            }

        @keyframes page-4 {
            30% {
                transform: rotateY(180deg);
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            65%, 100% {
                opacity: 0;
            }

            80%, 100% {
                transform: rotateY(0deg);
            }
            }

        @keyframes page-5 {
            45% {
                transform: rotateY(180deg);
                opacity: 0;
            }

            65% {
                opacity: 1;
            }

            80%, 100% {
                opacity: 0;
            }

            95%, 100% {
                transform: rotateY(0deg);
            }
        }
        .group {
        display: flex;
        line-height: 28px;
        align-items: center;
        position: relative;
        max-width: 350px; /* Increase width here */
        width: 100%;
        flex: 1;
        }

        .input {
            font-family: 'Lexend', sans-serif;
            width: 100%;
            padding: 0.8rem 1rem; /* Changed 0.5rem to 0.8rem to increase height */
            padding-left: 3rem;
            border-radius: 10px;
            border: 1px solid #d6d6e7;
            background-color: #f3f3f4;
            outline: none;
            color: #0d0c22;
        }

        .icon {
            position: absolute;
            left: -1.5rem; /* Corrected position */
            top: 50%;
            transform: translateY(-50%); /* Corrected transform property */
            width: 1rem;
            height: 1rem;
            fill: #b1b1b1;
            pointer-events: none;
        }

        #lounge-body .chat-message {
            /* We reduce the max-width from 75% to a more readable 60% for the wider view */
            max-width: 60%; 
        }

        /* For very large screens, a fixed max-width can look even better */
        @media (min-width: 1200px) {
            #lounge-body .chat-message {
                max-width: 700px;
            }
        }

        .input::placeholder {
        color: #9e9ea7;
        }

        .input:focus, input:hover {
        outline: none;
        border-color: rgba(234,76,137,0.4);
        background-color: #fff;
        box-shadow: 0 0 0 4px rgb(234 76 137 / 10%);
        }


        .nav-item:hover i {
            filter: brightness(1.3); /* Brighten the gradient on hover */
            transform: scale(1.15);  /* Keep the existing hover animation */
        }

        .messages-main {
            display: flex;
            justify-content: center;
            padding: 0;
            flex-grow: 1;
            overflow: hidden; /* Add this line */
        }

        /* --- Profile Stats Bar Styles --- */
        .profile-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 15px 0;
            margin: 15px 0;
            border-top: 1px solid #efefef;
            border-bottom: 1px solid #efefef;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        .stat-item span:first-child {
            font-weight: bold;
            font-size: 1.2em;
        }
        .stat-item span:last-child {
            color: #888;
            font-size: 0.9em;
        }
        .stat-item.clickable {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .stat-item.clickable:hover {
            transform: scale(1.05);
        }

        /* --- Following Modal Styles --- */
        .following-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-list-item.unread .name {
            font-weight: 900; /* Make the name extra bold */
            color: #000;       /* Make the name black for emphasis */
        }

        .chat-list-item.unread::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background-color: var(--primary-solid);
            border-radius: 50%;
        }

        .following-modal.hidden {
            display: none;
        }
        .following-modal-content {
            background-color: #fff;
            border-radius: 12px;
            width: 400px;
            max-width: 90vw;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            animation: zoomIn 0.3s ease;
        }
        .following-modal-header {
            text-align: center;
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid #dbdbdb;
            position: relative;
        }
        .close-following-modal {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            cursor: pointer;
            color: #555;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #efefef;
        }
        .setting-item-label {
            font-weight: bold;
            color: #333;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider {
            background-image: var(--primary);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* --- Animation for the toggle --- */
        input:checked + .slider {
            animation: pulse-check 0.5s ease-out;
        }
        @keyframes pulse-check {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 102, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0); }
        }
        .following-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
        }
        .following-list-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
        }
        .following-list-item:hover {
            background-color: #f9f9f9;
        }
        .following-list-item .profile-pic {
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }
        .following-list-item .user-info {
            display: flex;
            flex-direction: column;
        }
        .following-list-item .username {
            font-weight: bold;
        }
        .following-list-item .fullname {
            color: #888;
            font-size: 0.9em;
        }

        .active-chat-pane {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-grow: 1;
            overflow: hidden; /* <-- Fixes the scrolling header issue */
        }

        #chat-body,
        #lounge-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* Hides scrollbars for both */
        #chat-body::-webkit-scrollbar,
        #lounge-body::-webkit-scrollbar {
            display: none;
        }

        /* This rule for the lounge's main container no longer needs to override padding */
        #lounge-main {
            display: flex;
            flex-direction: column;
            /* The conflicting `padding: 0;` line has been removed */
        }

        .circuit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            justify-items: center; /* This centers the circles in their grid cells */
        }

        /* Base style for a message row */
        .chat-message {
            display: flex;
            flex-direction: column; /* Lays out the message and meta info vertically */
            margin-bottom: 2px;
            max-width: 75%;
        }

        .chat-message.has-reaction {
            margin-bottom: 15px; /* Adds space for the reaction below */
        }

        .chat-list-item.unread .name {
            font-weight: 900; /* Make the name extra bold */
            color: #000;       /* Make the name black for emphasis */
        }

        /* This adds the blue "unread" dot */
        .chat-list-item.unread::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background-color: var(--primary-solid);
            border-radius: 50%;
        }

        .chat-message.new-group {
            margin-top: 20px;
        }


        .chat-message.received {
            align-self: flex-start;
        }

        .char-counter {
            text-align: right;
            font-size: 0.8em;
            color: #888;
            margin-top: -5px;
            padding-right: 5px;
        }

        /* The text bubble itself */
        .chat-message p {
            padding: 10px 15px;
            border-radius: 20px;
            margin: 0;

            /* These are the crucial lines for text wrapping */
            max-width: 100%;
            overflow-wrap: break-word;
            word-break: break-all;
            min-width: 0; /* This is a key fix for flexbox containers */
        }

        .chat-message.sent p {
            background-image: var(--primary);
            color: #fff;
            border-radius: 20px 5px 20px 20px;
        }

        .chat-message.received p {
            background-color: #efefef;
            color: #000;
            border-radius: 5px 20px 20px 20px;
        }

        /* The timestamp text */
        .message-timestamp {
            font-size: 0.7em;
            color: #8e8e8e;
            margin: 0 8px 4px;
            white-space: nowrap;
        }

        .text-content-wrapper {
            /* This allows the element to shrink and wrap text properly inside a flex container */
            min-width: 0;
        }
        .text-content-wrapper .message-author {
            padding-left: 15px; /* Better than margin for layout calculations */
        }

        .create-circuit-card {
            border: 2px dashed #aab8c2;
            background-color: #f5f7fa;
            color: #555;
            text-shadow: none;
        }

        .lounge-container {
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .lounge-sidebar {
            flex-basis: 240px; /* Fixed width for the sidebar */
            flex-shrink: 0;
            background-color: #f0f2f5; /* A slightly off-white color */
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 1px solid #ddd;
        }

        .lounge-sidebar-header {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .lounge-sidebar-header h4 {
            margin: 0;
            font-size: 1.1em;
        }

        .lounge-channels-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #tos-content {
            font-family: Arial, sans-serif; /* A cleaner, more modern font */
            line-height: 1.7; /* Increases spacing between lines for readability */
            color: #333; /* A softer black for the main text */
        }

        /* Style for the main title (#) */
        #tos-content h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid;
            /* Use the primary theme gradient for the border */
            border-image: var(--primary) 1;
        }

        /* Style for section titles (##) */
        #tos-content h2 {
            font-size: 1.6em;
            font-weight: 600;
            margin-top: 40px; /* More space above each new section */
            margin-bottom: 15px;
            color: var(--primary-solid); /* Use your theme's solid blue color */
        }

        /* Style for paragraphs */
        #tos-content p {
            margin-bottom: 15px;
        }

        /* Style for bold text (**) */
        #tos-content strong {
            color: #000;
            font-weight: 600;
        }

        /* Style for italic text (*) */
        #tos-content em {
            color: #555;
            font-style: italic;
        }

        /* Style for numbered lists (1., 2.) */
        #tos-content ol {
            padding-left: 25px; /* Indent the list */
            margin-bottom: 15px;
        }

#tos-content ol li {
    margin-bottom: 8px; /* Space between list items */
}

        .context-menu {
            position: absolute;
            z-index: 3000;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            padding: 5px 0;
            animation: zoomIn 0.1s ease-out;
        }

        .context-menu-item {
            display: block;
            padding: 10px 15px;
            color: var(--text);
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
        }

        #lounge-join-overlay {
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            flex-grow: 1;
            background-color: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        #lounge-join-overlay.visible {
            display: flex; /* Show it when needed */
        }

        .join-lounge-card {
            background-color: #fff;
            padding: 40px;
            border-radius: 20px;
            /* --- THIS IS THE FIX --- */
            display: flex;             /* Activates flexbox layout */
            flex-direction: column;    /* Stacks items vertically */
            align-items: center;       /* Centers all items horizontally */
            /* --- END OF FIX --- */
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            z-index: 2;
            max-width: 450px;
            animation: fadeInScaleUp 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .join-lounge-card .privacy-icon {
            font-size: 3em;
            margin-bottom: 20px;
            background: var(--primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .join-lounge-card h3 {
            font-size: 1.8em;
            margin: 0 0 10px 0;
        }

        .join-lounge-card p {
            color: #666;
            margin: 0 0 25px 0;
            line-height: 1.6;
        }

        .join-lounge-btn {
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            align-items: center;
            border: none;
            border-radius: 50px;
            color: #fff;
            background-image: var(--primary);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .join-lounge-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 102, 255, 0.3);
        }

        @keyframes fadeInScaleUp {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .context-menu-item:hover {
            background-color: #f0f2f5;
        }

        .context-menu-item.danger {
            color: #e74c3c;
        }

        .lounge-channel-category {
            color: #666;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
            padding: 15px 10px 5px;
        }

        .image-preview-container {
            padding: 10px 20px 0 20px;
            border-top: 1px solid #dbdbdb;
            background-color: #f9f9f9;
        }

        .image-preview-box {
            position: relative;
            display: inline-block;
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 12px;
        }

        .preview-image {
            max-height: 100px;
            max-width: 200px;
            display: block;
            border-radius: 8px;
        }

        .remove-preview-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #333;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            font-weight: bold;
            line-height: 18px;
            text-align: center;
            cursor: pointer;
            z-index: 1;
        }

        .lounge-channel-item {
            padding: 8px 10px;
            margin-bottom: 3px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            transition: background-color 0.2s ease;
        }

        .lounge-channel-item:hover {
            background-color: #e4e6eb;
        }

        .lounge-channel-item.active {
            background-color: #d1d5db;
            color: #000;
        }

        .active-lounge-pane {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .create-circuit-card h4 {
            font-size: 3em;
            margin: 0;
            line-height: 1;
        }

        .circuit-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.4);
            border-radius: 50%;
            z-index: -1;
        }


        .circuit-card {
            /* Make it a circle */
            width: 150px;
            height: 150px;
            border-radius: 50%;

            /* Center the text inside */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;

            padding: 15px;
            box-sizing: border-box;
            color: #fff;
            cursor: pointer;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);

            /* For the background image */
            background-size: cover;
            background-position: center;
            position: relative;
            z-index: 1;

            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .theme-sidebar {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background-color: #fff;
            border-left: 1px solid #dbdbdb;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%); /* Start off-screen */
        }

        .theme-sidebar:not(.hidden) {
            transform: translateX(0); /* Slide in */
        }

        .theme-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dbdbdb;
        }

        .theme-sidebar-header h4 {
            margin: 0;
        }

        .theme-sidebar-header span {
            font-size: 1.5em;
            cursor: pointer;
            color: #888;
        }

        .theme-options {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .theme-option:hover {
            background-color: #f0f2f5;
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }

        /* Specific preview styles */
        .theme-apex-preview {
            background: var(--primary);
        }

        .theme-colorless-preview {
            background-color: #efefef;
        }

        /* --- THEME DEFINITIONS --- */

        /* Colorless Theme */
        #chat-body.theme-colorless {
            background-image: none;
            background-color: #ffffff; /* Plain white background */
        }

        #chat-body.theme-colorless .chat-message.sent p {
            background-image: none;
            background-color: #efefef; /* Light gray for sent messages */
            color: #000;
        }

        #chat-body.theme-colorless .chat-message.received p {
            background-color: #232013; /* A slightly darker gray for received messages */
            color: #fff
        }

        /* Add a dark overlay so the text is readable */
        .circuit-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.4);
            border-radius: 50%;
            z-index: -1;
        }

        .circuit-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .circuit-posts-grid {
            column-gap: 15px;
            padding: 20px;
            /* Default to 2 columns for a good baseline on smaller laptops/tablets */
            column-count: 2;
        }

        /* For standard desktop screens (like most laptops) */
        @media (min-width: 992px) {
            .circuit-posts-grid {
                column-count: 3;
            }
        }

        /* For large desktop screens */
        @media (min-width: 1200px) {
            .circuit-posts-grid {
                column-count: 4;
            }
        }

        /* For mobile phones */
        @media (max-width: 576px) {
            .circuit-posts-grid {
                column-count: 1;
            }
        }

        @media (max-width: 768px) {
            .circuit-posts-grid {
                column-count: 2;
            }
        }
        @media (max-width: 480px) {
            .circuit-posts-grid {
                column-count: 1;
            }
        }

        .circuit-post {
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            /* This helps with the collage effect */
            /* This tells the post not to break across columns */
            break-inside: avoid; /*  ADD THIS LINE */

            /* We add some margin-bottom to create vertical space between posts in a column */
            margin-bottom: 15px; /*  AND ADD THIS LINE */
        }

        .circuit-post img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .circuit-post-text {
            font-size: 1em;
            margin-bottom: 10px;
            flex-grow: 1;
            overflow-wrap: break-word; /*  ADD THIS LINE */
        }

        .circuit-post-author {
            font-size: 0.8em;
            text-align: right;
            margin-top: auto; /* Pushes author to the bottom */
            font-weight: bold;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .circuit-post-author .profile-pic {
            width: 20px;
            height: 20px;
            margin-left: 8px;
        }


        .card {
        width: 300px;
        position: relative;
        background: rgb(255, 255, 255);
        padding: 20px;
        }

        .card::after {
        z-index: -1;
        content: "";
        position: absolute;
        width: 50%;
        height: 10px;
        bottom: 15px;
        right: 0;
        box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.4);
        transform: rotate(5deg);
        transition: all 0.1s ease-in;
        }

        .card::before {
        z-index: -1;
        content: "";
        position: absolute;
        width: 50%;
        height: 10px;
        bottom: 15px;
        left: 0;
        box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.4);
        transform: rotate(-5deg);
        transition: all 0.1s ease-in;
        }

        .card:hover:before, .card:hover:after {
        box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.6);
        }

        .card:hover:before {
        transform: rotate(-8deg);
        }

        .card:hover:after {
        transform: rotate(8deg);
        }

        .card__img {
            position: relative;
            /* This now uses your primary theme gradient */
            background: var(--primary);
            width: 100%;
            height: 175px;
        }

        .card__span {
        cursor: pointer;
        font-size: 11px;
        position: absolute;
        background-color: white;
        top: 10px;
        left: 10px;
        padding: 3px 7px;
        box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.1s ease-in;
        user-select: none;
        }

        .card__span:hover {
        transform: translateX(5px);
        }

        .card-int {
        padding: 20px 0 0 0;
        }

        .card-int__title {
        font-weight: bold;
        font-size: 1.2rem;
        font-family: Arial, Helvetica, sans-serif;
        margin-bottom: 10px;
        }

        .create-circuit-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f0f2f5;
            border: 1px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .create-circuit-btn:hover {
            background-color: #e4e6eb;
            color: #000;
        }


        .card-int__button:active {
        box-shadow: 0px 0px 15px rgba(0, 119, 255, 0.5);
        }

        .card-int__button:hover::before {
        animation: effect_two 0.4s 1;
        left: 100%;
        }


        .card__img {
            position: relative;
            background: var(--primary);
            width: 100%;
            height: 175px;
        }

        /* This themes the "Show" button to a solid, on-brand blue */
        .card-int__button {
            cursor: pointer;
            margin: 20px 0 0 0;
            padding: 7px 20px;
            width: 100%;
            border: none;
            color: white;
            font-weight: bold;
            transition: transform 0.2s ease;
            position: relative; /* Required for the animation */
            overflow: hidden;   /* Required for the animation */
            z-index: 1;

            /* Here's the new radial gradient background */
            background: radial-gradient(circle, #4dabf7 0%, var(--primary-solid) 100%);
        }

        .card-int__button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%; /* Start it off-screen to the left */
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease; /* Controls the speed of the shine */
            z-index: -1;
        }

        /* This adds a simple hover effect to the button */
        .card-int__button:hover {
            filter: brightness(1.15);
            transform: scale(1.05);
        }

        .article-grid {
            display: grid;
            /* This creates as many 300px columns as can fit, and lets them grow */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; /* This adds space between the cards */

            /* These are from your old inline style */
            list-style: none;
            padding: 0;
        }

        .profile-pic-spacer {
            width: 35px;         /* Same width as .chat-message .profile-pic */
            margin-right: 10px;  /* Same margin as .chat-message .profile-pic */
            flex-shrink: 0;      /* Prevents the spacer from collapsing */
        }

        .tos-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .tos-container input {
            width: auto;
            margin: 0 5px 0 0;
        }

        #lounge-details-modal-description {
            white-space: normal;      /* Allows the text to wrap to new lines */
            word-wrap: break-word;    /* Breaks long words that would otherwise overflow */
            overflow-y: auto;         /* Adds a scrollbar if the content is extremely long */
            max-height: 40vh;         /* Limits the max height to 40% of the viewport height */
        }

        .tos-container a {
            font-weight: bold;
            color: var(--primary-solid);
            text-decoration: underline;
            background: none;
            -webkit-background-clip: unset;
            background-clip: unset;
            color: var(--primary-solid); /* Use a solid color for the link */
        }

        .lounge-channel-list-wrapper {
            flex-grow: 1; /* Allows this container to take up all available vertical space */
            overflow-y: auto; /* Enables vertical scrolling only when content overflows */
            min-height: 0; /* A flexbox fix to ensure shrinking works correctly */

            /* --- Hides the scrollbar across different browsers --- */
            scrollbar-width: none; /* For Firefox */
            -ms-overflow-style: none;  /* For Internet Explorer and Edge */
        }

        /* For Chrome, Safari, and other Webkit browsers */
        .lounge-channel-list-wrapper::-webkit-scrollbar {
            display: none;
        }

        /* --- Footer Styles --- */
        footer {
            display: none; /* Hidden by default, shown via JavaScript */
            background-color: #fff;
            padding: 20px 0;
            text-align: center;
            border-top: 1px solid #ddd;
            margin-top: auto; /* This is the magic that pushes it to the bottom */
            width: 100%;
            box-sizing: border-box;
        }

        body.with-sidebar footer {
            margin-left: 60px; /* Aligns with the main content when sidebar is open */
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .notification-item.unread {
            background-color: #f0f7ff; /* A very light blue */
        }
        .notification-item.unread p {
            font-weight: bold; /* Make the notification text bold */
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 10px;
        }

        .main-channel-icon {
            color: #f0b429; /* A nice gold color */
            margin-left: 6px; /* Changed from margin-right */
            font-size: 0.9em;
        }

        .footer-links a {
            color: #555;
            text-decoration: none;
            font-size: 0.9em;
            transition: color 0.2s ease;
        }

        .footer-links a:hover {
            color: var(--primary-solid);
        }

        .copyright {
            font-size: 0.8em;
            color: #888;
            margin: 0;
        }

        /* --- Report Page Styles --- */
        .report-form {
            display: flex;
            flex-direction: column;
        }

        .report-form label {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .report-form input,
        .report-form textarea,
        .report-form select {
            width: 95%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            font-family: Arial, sans-serif;
        }

        .report-form textarea {
            resize: vertical;
        }

        .report-submit-btn {
            margin-top: 20px;
            padding: 12px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background-image: var(--primary);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: filter 0.2s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .section-header h3 {
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* 1. This RESTORES the original top-right position for ALL "More" links */
        .more-link {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.9em;
            color: var(--primary);
            text-decoration: none;
        }

        /* 2. This creates a specific EXCEPTION for the Articles section link */
        .section-header .more-link {
            position: static;
        }

        /* In the <style> tag */
        .modal-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            z-index: 2002;
            transition: background-color 0.2s ease;
        }

        .chat-message p, .chat-message img {
            /* These properties are now shared */
            max-width: 100%;
            overflow-wrap: break-word;
            word-break: break-all;
            min-width: 0;
        }

        .chat-message img {
            border-radius: 15px; /* Give images rounded corners */
            display: block;      /* Prevents extra space below the image */
            max-height: 300px;   /* Stop images from being excessively tall */
            background-color: #eee; /* Shows a placeholder while image loads */
        }

        .modal-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        .modal-nav-btn.prev { left: 20px; }
        .modal-nav-btn.next { right: 20px; }

        .circuit-post {
            position: relative; /* Needed for positioning the like button */
        }
        .like-button-container {
            position: absolute;
            bottom: 10px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 15px;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease;
        }

        .lounge-channel-item {
            display: flex; /* Use flexbox for alignment */
            justify-content: space-between; /* Pushes name and button to opposite ends */
            align-items: center; /* Vertically centers them */
        }

        .channel-options-btn {
            display: none; /* Hide the button by default */
            padding: 2px 6px;
            border-radius: 5px;
            cursor: pointer;
            color: #555;
        }

        .lounge-channel-item:hover .channel-options-btn {
            display: block; /* Show the button on hover */
        }

        .channel-options-btn:hover {
            background-color: #d1d5db;
        }
        .circuit-post:hover .like-button-container {
            opacity: 1; /* Show on hover */
        }

        .chat-message img {
            cursor: pointer; /* Indicates that the image is clickable */
            transition: opacity 0.2s ease;
        }
        .chat-message img:hover {
            opacity: 0.85; /* A subtle hover effect */
        }
        #image-viewer-content {
            /* --- THIS IS THE FIX --- */
            max-width: 90vw;   /* Use max-width to constrain large images */
            max-height: 90vh;  /* Use max-height to constrain large images */
            object-fit: contain;
            /* --- END OF FIX --- */

            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            animation: zoomIn 0.3s ease;
            cursor: default;
        }
        .like-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            color: #555;
        }
        .like-button.liked {
            color: #e74c3c; /* Red when liked */
        }
        .like-count {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }

        .report-submit-btn:hover {
            filter: brightness(1.15);
        }

        .report-confirm-container {
            display: flex;
            justify-content: flex-start; /* Aligns items to the left */
            align-items: center;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .report-confirm-container input {
            width: auto;
            margin: 0 5px 0 0;
        }


        /* --- FINAL Fire Message Effect with Correct Layering & Positioning --- */

        /* The new, invisible wrapper for the bubble and its particles */
        .bubble-container {
            position: relative;
        }

        /* The bubble, on the top layer */
        .effect-fire .bubble-container p {
            position: relative;
            z-index: 2;
            overflow: visible; /* Allows bubble to have shadows/effects if needed */
            /* Keep the animated gradient */
            background: linear-gradient(45deg, #ff7e5f, #feb47b, #ffc94e, #ff7e5f);
            background-size: 300% 300%;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            animation: fire-gradient 3s ease infinite;
        }

        /* The flame particles, on the bottom layer, positioned inside the bubble-container */
        .flame-particle {
            position: absolute;
            z-index: 1;
            top: 0; /* Start at the top of the container */
            width: 10px;
            height: 20px;
            background: radial-gradient(circle, #ffee00, #ff7b00);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 0 10px #ff7b00;
            filter: blur(1px);
            animation: rise-and-fade 2s ease-in-out infinite;
        }

        .circuit-code {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(13, 27, 42, 0.8); /* Matches --dark color */
            color: #fff;
            font-size: 0.7em;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            z-index: 2; /* Ensure it's above the ::before overlay */
        }

        .notifications-list {
            list-style: none;
            padding: 0;
        }
        .notification-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .notification-item:hover {
            background-color: #f9f9f9;
        }
        .notification-item .profile-pic {
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }

        .message-actions {
            display: none; /* Hidden by default */
            align-items: center;
            gap: 4px;
        }
        /* Show buttons on hover of the entire message row */
        .chat-message:hover .message-actions {
            display: flex;
        }
        /* Style for sent vs received buttons */


        .action-btn {
            background-color: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            color: #555;
            font-size: 0.8em;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .action-btn:hover {
            background-color: #d1d1d1;
        }

        .circuit-card h4, .circuit-card p {
            width: 90%; /* Give text some padding from the circle's edge */
            white-space: nowrap; /* Prevent text from wrapping to a new line */
            overflow: hidden; /* Hide any text that goes beyond the element's width */
            text-overflow: ellipsis; /* Display "..." for the hidden/overflowed text */
            box-sizing: border-box; /* Ensures padding is included in the width calculation */
        }

        /* Dropdown menu for the 3-dot button */
        .message-options-dropdown {
            position: absolute;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 101; /* Above message bubbles */
            overflow: hidden;
            border: 1px solid #ddd;
            width: 150px;
        }
        .message-options-dropdown {
            position: absolute;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 101; /* Above message bubbles */
            overflow: hidden;
            border: 1px solid #ddd;
            width: 150px;
            opacity: 1; /* Default state is visible */
            transform: translateY(0);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            visibility: visible;
        }

        .message-options-dropdown.hidden {
            opacity: 0;
            transform: translateY(-10px); /* This makes it fade upwards when hiding */
            visibility: hidden; /* Hide it completely after the transition */
            pointer-events: none; /* Prevents clicking on the invisible menu */
        }
        .message-options-dropdown a {
            display: block;
            padding: 10px 15px;
            color: var(--text);
            text-decoration: none;
            font-size: 0.9em;
        }
        .message-options-dropdown a:hover {
            background-color: #f0f2f5;
        }

        /* Style for the reaction emoji */
        .message-reaction {
            background-color: #f0f2f5; /* Light gray background */
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 1px 6px;
            font-size: 0.8em;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .chat-message.sent .message-reaction {
            right: auto;
            left: 10px;
        }

        .message-row {
            display: flex;
            align-items: flex-end;
            width: 100%;
            gap: 8px;
        }

        /* This new container holds the reaction and timestamp below the bubble */

        .chat-message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        /* 2. This reverses the bubble and the hover-buttons within the row
              so the buttons appear on the left side of the bubble. */
        .chat-message.sent .message-row {
            flex-direction: row-reverse;
        }

        /* 3. This aligns the metadata (reaction and timestamp) to the right,
              underneath the message bubble. */
        .chat-message.sent .message-meta {
            justify-content: flex-end;
        }

        /* 4. This controls the vertical space ("pushed down" effect).
              I've increased the margin-top for a larger gap. */
        .message-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px; /* Increased for more space */
            padding: 0 10px;
        }


        /* Align the meta info correctly for sent vs received messages */
        .chat-message.received .message-meta {
            justify-content: flex-start;
        }

        /* Style for a message that has been deleted */
        .message-content.deleted {
            font-style: italic;
            color: #888;
            background-color: #f0f2f5 !important; /* Override theme colors */
            background-image: none !important;
            border: 1px dashed #ccc;
        }

        .circuit-cover-uploader {
            margin-top: 15px;
        }
        .circuit-cover-uploader label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .circuit-cover-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background-color: #f0f2f5; /* A slightly darker background */
            background-size: contain; /* Changed from 'cover' */
            background-position: center;
            background-repeat: no-repeat; /* Make sure the image doesn't tile */
            color: #888;
            font-weight: bold;
        }

        /* Keyframes for the looping rise */
        @keyframes rise-and-fade {
            0%   { transform: translateY(0) scale(0.5); opacity: 0; }
            20%  { transform: translateY(-20px) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }

        /* Keyframes for the bubble's gradient */
        @keyframes fire-gradient {
            0%   { background-position: 0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }


        /* --- FINAL & VIBRANT Rainbow Bio Effect --- */
        .rainbow-text {
            /* Make the text transparent so the background gradient shows through */
            color: transparent;
            /* Clip the background to the shape of the text */
            -webkit-background-clip: text;
            background-clip: text;

            /* Pure, vibrant rainbow colors with no dark tones */
            background-image: linear-gradient(135deg,
                #ff0000, #ff7f00, #ffff00, #00ff00,
                #0033ff, #6f00ff, #ff00ff, #ff0000);

            /* Make the gradient large to show many colors at once */
            background-size: 400% 400%;

            font-weight: bold;

            /* Call the new, more intense animation */
            animation: intense-rainbow-glow 6s linear infinite;
        }

        @keyframes intense-rainbow-glow {
            0% {
                background-position: 0% 50%;
                /* The filter property creates the powerful, light-emitting glow */
                filter: hue-rotate(0deg)
                        drop-shadow(0 0 2px #fff)
                        drop-shadow(0 0 5px #00fbff)
                        drop-shadow(0 0 10px #ff00ff);
            }
            50% {
                background-position: 200% 50%;
                filter: hue-rotate(180deg)
                        drop-shadow(0 0 2px #ff8000)
                        drop-shadow(0 0 5px #0dff00)
                        drop-shadow(0 0 10px #002aff);
            }
            100% {
                background-position: 400% 50%;
                filter: hue-rotate(360deg)
                        drop-shadow(0 0 2px #fff)
                        drop-shadow(0 0 5px #ff0000)
                        drop-shadow(0 0 10px #e5ff00);
            }
        }

        /* --- FINAL Definitive Profile Picture & Rank Styles --- */

        /* Base container for all profile pictures */
        .profile-pic, .profile-pic-large, .nav-user-pic {
            position: relative;
            border-radius: 50%;
            background-color: transparent;
            /* This is the default gray border for normal users */
            border: 2px solid #ddd;
        }

        /* The ::before element will now hold the actual avatar image */
        .profile-pic::before, .profile-pic-large::before, .nav-user-pic::before {
            content: '';
            position: absolute;
            /* Inset the image within the border */
            top: 2px; left: 2px; right: 2px; bottom: 2px;
            border-radius: 50%;
            background-color: #e0e0e0;
            /* The default avatar is the fallback here */
            background-image: var(--avatar-image, url('/api/asset/default_avatar'));
            background-size: cover;
            background-position: center;
        }

        /* --- Sizing --- */
        .profile-pic { width: 60px; height: 60px; }
        .profile-pic-large { width: 150px; height: 150px; margin: 0 auto 20px; }
        .nav-user-pic { width: 30px; height: 30px; border-width: 1px; }

        /* Inset the avatar for the smaller nav pic */
        .nav-user-pic::after { top: 1px; left: 1px; right: 1px; bottom: 1px; }

        /* --- Rank Styles --- */

        /* Remove the default border and set the gradient background for the ring */
        .rank-admin, .rank-moderator {
            border: none;
            padding: 3px; /* Creates space for the background to act as a border */
        }

        .rank-admin {
            background: conic-gradient(from 180deg at 50% 50%, #ffd700, #f0e68c, #daa520, #ffd700, #f0e68c, #daa520, #ffd700);
            animation: glistening-glow 2s ease-in-out infinite;
        }

        .rank-moderator {
            /* New gradient with higher contrast for a 'shinier' look */
            background: linear-gradient(135deg, #888, #e0e0e0, #fff, #e0e0e0, #888);
            /* Add a static silver glow to make it pop */
            box-shadow: 0 0 8px rgba(192, 192, 192, 0.7);
        }

        @keyframes glistening-glow {
            0% { box-shadow: 0 0 5px #ffd700; }
            50% { box-shadow: 0 0 20px 5px #f0e68c; }
            100% { box-shadow: 0 0 5px #ffd700; }
        }

        .rank-icon {
            font-size: 0.8em;
            margin-left: 5px;
            vertical-align: middle; /* Helps align the icon with the text */
        }

        .admin-icon {
            color: #007bff; /* Blue */
        }

        .mod-icon {
            color: #343a40; /* Dark Gray / Black */
        }

        /* --- Sidebar Hover Fix --- */
        .nav-user-pic {
            z-index: 2; /* Lifts the sidebar pic above the hover background */
        }

        /* --- Profile Page Menu Styles --- */
        .profile-menu-button {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        .profile-menu-button:hover {
            background-color: #f0f2f5;
        }

        .profile-menu-dropdown {
            position: absolute;
            top: 55px; /* Position it below the header */
            right: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .profile-menu-dropdown.hidden {
            display: none;
        }

        .profile-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9em;
            display: block;
            text-decoration: none;
            color: var(--text);
            white-space: nowrap;
        }

        .profile-menu-item:hover {
            background-color: #f0f2f5;
        }

        /* Style for the admin-only options */
        .profile-menu-item.admin-option {
            font-weight: bold;
            color: var(--primary-solid);
        }

        /* --- All Profiles Page Styles --- */
        .all-profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        /* --- User Post Grid & Instagram Hover Styles --- */

        /* This creates the 3-column grid layout */
        .user-posts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .user-post-item:hover img {
            transform: scale(1.1);
        }

        /* Creates the square shape for each post */
        .user-post-item {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
        }

        /* Makes the image fill the square perfectly */
        .user-post-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        /* The dark overlay that appears on hover */
        .post-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 50%);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            color: #fff;
            font-size: 1.1em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #lounge-body .chat-message {
            /* We reduce the max-width from 75% to a more readable 60% for the wider view */
            max-width: 60%;
        }

        /* For very large screens, a fixed max-width can look even better */
        @media (min-width: 1200px) {
            #lounge-body .chat-message {
                max-width: 700px;
            }
        }

        /* --- NEW Instagram-Style Post Modal --- */
        .modal-content {
            background-color: #fff;
            border-radius: 12px;
            max-width: 450px; /* Limit the width */
            max-height: 90vh;
            overflow: hidden; /* Hide anything that spills out */
            display: flex;
            flex-direction: column;
        }

        .form-error-message {
            color: #e74c3c; /* A clear, friendly red */
            font-size: 0.85em;
            text-align: left;
            margin-top: -5px; /* Pulls it closer to the input field */
            margin-bottom: 10px;
            padding-left: 5px;
            font-weight: bold;
        }

        /* --- Save Confirmation Message Styles --- */
        .save-success-message {
            color: var(--success);
            font-weight: bold;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-post-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #efefef;
            cursor: pointer; /* Add this */
            transition: background-color 0.2s ease; /* Add this for a smooth effect */
        }
        .modal-post-header .profile-pic {
            width: 32px;
            height: 32px;
            margin-right: 12px;
        }
        .modal-post-header .name {
            font-weight: bold;
        }

        .modal-post-header:hover {
            background-color: #f9f9f9;
        }

        .modal-post-image {
            width: 100%;
            height: auto;
        }

        .modal-post-footer {
            padding: 10px 15px;
        }

        .modal-post-actions {
            font-size: 1.5em;
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .modal-post-likes {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .modal-post-caption {
            font-size: 0.9em;
        }
        .modal-post-caption .author {
            font-weight: bold;
            margin-right: 5px;
        }

        #notification-toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-toast {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: #fff;
            font-weight: bold;
            min-width: 250px;
            animation: slideInDown 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .notification-toast.exiting {
            animation: fadeOutUp 0.4s ease-out forwards;
        }

        .notification-toast.success {
            background-color: #28a745; /* Green */
        }

        .notification-toast.error {
            background-color: #dc3545; /* Red */
        }

        .notification-toast::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification-toast.success::before {
            content: '\f00c'; /* Checkmark icon */
        }

        .notification-toast.error::before {
            content: '\f00d'; /* X-mark icon */
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        /* Show the overlay when the user hovers over the post */
        .user-post-item:hover .post-overlay {
            opacity: 1;
        }

        .post-stat i {
            margin-right: 5px;
        }
        .profile-grid-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .profile-grid-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .profile-grid-card .profile-pic {
            margin: 0 auto 15px;
        }

        .account-type-tag {
            display: inline-block;
            margin-left: 6px;
            padding: 3px 8px;
            font-size: 0.7em;
            font-weight: bold;
            border-radius: 10px;
            color: #fff;
            vertical-align: middle; /* Aligns tag nicely with text */
            line-height: 1.2;
        }

        .tag-teacher {
            background-color: #4a5568; /* Grayish Blue */
        }

        .tag-team {
            background-color: #2986CC;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #888;
            margin-top: 8px;
            padding: 0 5px;
        }

        .card-meta .views {
            font-weight: bold;
        }

        .card-meta .views i {
            margin-right: 4px;
        }

        .circuit-views {
            display: none;
            /*position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.6);
            color: #fff;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;*/
        }

        .chat-message .profile-pic {
            width: 35px;
            height: 35px;
            margin-right: 10px;
            /* This aligns the bottom of the picture with the bottom of the text bubble */
            margin-bottom: 5px;
        }

        .profile-card-name {
            font-weight: bold;
            font-size: 1.1em;
            margin: 0;
        }

        .profile-card-username {
            color: #888;
            font-size: 0.9em;
            margin: 2px 0 0 0;
        }

        /* --- Post Modal (Lightbox) Styles --- */
        .post-modal {
            position: fixed; /* Stays in one place */
            z-index: 2000; /* Make sure it's on top of everything */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85); /* Black background with opacity */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer; /* Add a pointer to indicate the background is clickable */
        }

        .profile-menu-item.danger {
            color: #e74c3c;
            font-weight: bold;
        }
        .profile-menu-item.danger:hover {
            background-color: #fff0f0;
        }


        .post-modal.hidden {
            display: none;
        }

        .modal-post-details {
            padding: 0 15px 15px 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .modal-post-details .like-button-container {
            opacity: 1;
            position: relative;
            justify-content: flex-start;
            padding-top: 10px;
            background: none;
        }

        .modal-post-details .circuit-post-text {
            text-align: left;
            margin-bottom: 20px;
            font-size: 1em;
            color: #333;
        }

        .modal-post-timestamp {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 0.8em;
            color: #888;
            border-top: none; /* Remove the old separator line */
            padding-top: 0;
            margin-top: 0;
        }

        .post-modal .modal-content .circuit-post-author {
            margin-top: 10px;
            justify-content: flex-end;
        }

        /* Update the main modal content container */
        .post-modal .modal-content {
            background-color: #fff;
            border-radius: 8px;
            width: 550px;
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
            cursor: default;
            animation: zoomIn 0.3s ease;
            padding-top: 40px; /* Gives space for the timestamp at the top */
            box-sizing: border-box; /* Ensures padding is included in the height calculation */
            overflow-y: auto;   /* <-- THIS IS THE KEY FIX */
        }

        /* Add a new style for the image within the modal */
        .modal-post-image {
            width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 15px;
            display: block; /* Fixes potential extra space below the image */
        }

        .post-modal .modal-content img {
            max-width: 100%;
            max-height: 70vh; /* Limit image height */
            border-radius: 4px;
            margin-bottom: 15px; /* Space between image and text */
        }

        .modal-content {
            max-width: 60vw; /* Max width is 60% of the viewport width */
            max-height: 90vh; /* Max height is 90% of the viewport height */
            animation: zoomIn 0.3s ease;
        }

        .post-modal .modal-content .circuit-post-author {
            color: #555; /* Dark gray for the author */
            font-weight: bold;
            font-size: 0.9em;
            width: 100%; /* Make it take full width */
            text-align: right; /* Align it to the right */
        }

        .close-modal-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
            z-index: 2001; /* Ensure it's above the modal content */
        }

        .close-modal-btn:hover {
            color: #bbb;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content img {
            width: 100%;
            height: auto;
            max-height: 70vh; /* Limit image height to avoid being too tall */
            object-fit: contain;
            border-radius: 4px;
        }

        .modal-content .circuit-post-text {
            color: #333;
            font-size: 1.2em;
            padding: 10px;
        }

        .modal-content .circuit-post-author {
            color: #ccc;
        }

        /* --- Instagram-Style Post Grid Hover --- */
        .user-post-item {
            cursor: pointer;
            overflow: hidden; /* Important for containing the overlay */
        }

        .post-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);

            /* Center the stats */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;

            color: #fff;
            font-size: 1.1em;
            font-weight: bold;

            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease-in-out;
        }

        .user-post-item:hover .post-overlay {
            opacity: 1; /* Show on hover */
        }

        .modal-search-bar-container {
            padding: 15px;
            border-bottom: 1px solid #dbdbdb;
        }

        .modal-search-bar-container .group {
            max-width: 100%; /* Ensure it fits the modal */
        }

        /* This positions the SVG icon correctly inside the modal's search bar */
        .modal-search-bar-container .icon {
            left: 1rem;
            transform: translateY(-50%) scale(0.8);
        }

        .post-stat i {
            margin-right: 5px;
        }

        .close-modal-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-modal-btn:hover {
            color: #bbb;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* --- Terminal Page Styles --- */
        .terminal-main {
            background-color: var(--dark);
            flex-grow: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        .terminal-output {
            flex-grow: 1;
            overflow-y: auto;
            color: #e0e0e0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .terminal-line {
            margin-bottom: 5px;
            white-space: pre-wrap; /* Allows text to wrap */
        }

        .terminal-line.command {
            color: #88ddff; /* Light blue for commands */
        }

        .terminal-line.success {
            color: var(--accent); /* Your theme's accent color for success */
        }

        .terminal-line.error {
            color: #ff8888; /* Light red for errors */
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
            border-top: 1px solid #334;
            padding-top: 5px;
        }

        .terminal-prompt {
            color: var(--accent);
            font-weight: bold;
            margin-right: 8px;
        }

        .terminal-input {
            flex-grow: 1;
            background: none;
            border: none;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
            outline: none;
        }

        .confirmation-modal-content {
            background-color: #fff;
            border-radius: 15px;
            width: 400px;
            max-width: 90vw;
            padding: 30px;
            text-align: center;
            animation: zoomIn 0.3s ease;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }

        .confirmation-modal-icon {
            font-size: 3em;
            color: #e67e22; /* A warning orange */
            margin-bottom: 15px;
        }

        .confirmation-modal-content h3 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }

        .confirmation-modal-content p {
            color: #666;
            margin: 0 0 25px 0;
        }

        .confirm-modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .confirm-modal-footer button {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .confirm-btn-cancel {
            background-color: #e9ecef;
            color: #495057;
        }
        .confirm-btn-cancel:hover {
            opacity: 0.9;
        }

        .confirm-btn-confirm {
            background-color: #dc3545; /* Red */
            color: #fff;
        }
        .confirm-btn-confirm:hover {
            opacity: 0.9;
        }

        .reaction-picker {
            position: absolute;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 5px;
            display: flex;
            gap: 8px;
            z-index: 102; /* Above message bubbles */
        }
        .reaction-picker span {
            cursor: pointer;
            font-size: 1.5em;
            transition: transform 0.1s ease;
        }
        .reaction-picker span:hover {
            transform: scale(1.3);
        }

        .excerpt {
        font-size: 14px;
        }



        @keyframes effect_one {
        0% {
            transform: translateX(-99%);
        }

        25% {
            transform: translateX(-90%);
        }

        50% {
            transform: translateX(-80%);
        }

        75% {
            transform: translateX(-95%);
        }

        100% {
            transform: translateX(-99%);
        }
        }

        @keyframes effect_two {
        to {
            transform: translateX(-1%);
        }

        from {
            transform: translateX(-99%);
        }


        }
    </style>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>
    <script>
        (function(){
            emailjs.init('9YeHbVpIjSJMooCnQ'); // Replace with your actual PUBLIC KEY (not service ID)
        })();
    </script>
</head>
<body>
    <div id="notification-toast-container"></div>
    <div class="background-animations">
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
        <div class="bg-item"></div>
    </div>
        <div id="account-type-selection-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('login-page')">
                    <i class="fas fa-arrow-left"></i> Back to Login
                </a>
            </div>
            <div class="header-center">
                <p>Choose Account Type</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main style="display: flex; justify-content: center; align-items: center;">
            <div class="account-type-selection-container">
                <button class="account-type-btn" onclick="prepareSignupForm('student')">
                    <i class="fas fa-user-graduate"></i>
                    <h3>Student</h3>
                    <p>For learners and seekers.</p>
                </button>
                <button class="account-type-btn" onclick="prepareSignupForm('teacher')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h3>Teacher</h3>
                    <p>For educators and teachers.</p>
                </button>
                <button class="account-type-btn" onclick="prepareSignupForm('team')">
                    <i class="fas fa-users"></i>
                    <h3>Team Account</h3>
                    <p>For school clubs, groups, or other affiliations.</p>
                </button>
            </div>
        </main>
    </div>
        <div id="confirmation-modal" class="following-modal hidden">
        <div class="confirmation-modal-content">
            <i class="fas fa-exclamation-triangle confirmation-modal-icon"></i>
            <h3 id="confirm-modal-title">Are you sure?</h3>
            <p id="confirm-modal-text">This action cannot be undone.</p>
            <div class="confirm-modal-footer">
                <button class="confirm-btn-cancel" onclick="closeConfirmationModal()">Cancel</button>
                <button id="confirm-modal-btn" class="confirm-btn-confirm">Confirm</button>
            </div>
        </div>
    </div>
    <div id="login-page" class="page active">
        <header>
            <div class="header-left">
                <div class="logo">
                    <img src="/api/asset/logo_text" alt="APEX Logo" class="logo-img">
                </div>
            </div>
            <div class="header-center">
                <p>Log in</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <div class="auth-form">
                <h2>Log in</h2>
                <input type="text" id="loginIdentifier" placeholder="Username or Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button onclick="handleLogin()">Log in</button>
                <a href="#" onclick="showPage('account-type-selection-page')">Register</a>
            </div>
        </main>
    </div>

    <div id="edit-circuit-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showCircuit(currentCircuitId)"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>Edit Circuit</p></div>
            <div class="header-right">
                <button class="login-btn" onclick="handleCreateCircuit(this)">Create</button>
            </div>
        </header>
        <main>
            <div class="auth-form">
                <input type="text" id="editCircuitTitle" placeholder="Event Title" maxlength="30">
                <input type="text" id="editCircuitHost" placeholder="Association" maxlength="20">
                <div class="circuit-cover-uploader">
                    <label for="editCircuitCoverInput">Cover Image</label>
                    <div id="editCircuitCoverPreview" class="circuit-cover-preview">
                        <span>+ Upload Image</span>
                    </div>
                    <input type="file" id="editCircuitCoverInput" accept="image/*" style="display: none;">
                </div>
            </div>
        </main>
    </div>



    <div id="signup-page" class="page">
        <main>
            <div class="auth-form">
                <h2 id="signup-form-title">Register</h2>

                <input type="text" id="signupFullName" placeholder="Full Name" required>
                <input type="text" id="signupUsername" placeholder="Username" required ...>

                <input type="date" id="signupDOB" style="display: none;" min="1850-01-01">

                <input type="text" id="signupSubject" placeholder="Primary Subject (e.g., Mathematics)" style="display: none;">

                <select id="signupSchool" required>
                    <option value="" disabled selected>Select your school</option>
                    <option value="Asia Pacific International School">Asia Pacific International School</option>
                    <option value="Branksome Hall Asia">Branksome Hall Asia</option>
                    <option value="Busan Foreign School">Busan Foreign School</option>
                    <option value="Calvin Manitoba International School">Calvin Manitoba International School</option>
                    <option value="Chadwick International">Chadwick International</option>
                    <option value="Cheongna Dalton School">Cheongna Dalton School</option>
                    <option value="Daegu International School">Daegu International School</option>
                    <option value="Global Christian Foreign School">Global Christian Foreign School</option>
                    <option value="Gyeonggi Suwon International School">Gyeonggi Suwon International School</option>
                    <option value="Gyeongnam International Foreign School">Gyeongnam International Foreign School</option>
                    <option value="International School of Busan">International School of Busan</option>
                    <option value="Korea International School">Korea International School</option>
                    <option value="Korea International School, Jeju">Korea International School, Jeju</option>
                    <option value="North London Collegiate School Jeju">North London Collegiate School Jeju</option>
                    <option value="Sejong Fayston">Sejong Fayston</option>
                    <option value="Seoul Foreign School">Seoul Foreign School</option>
                    <option value="Seoul International School">Seoul International School</option>
                    <option value="Songdo Fayston">Songdo Fayston</option>
                    <option value="St. Johnsbury Academy Jeju">St. Johnsbury Academy Jeju</option>
                    <option value="St. Paul Preparatory School">St. Paul Preparatory School</option>
                    <option value="Suji Fayston">Suji Fayston</option>
                    <option value="Taejon Christian International School">Taejon Christian International School</option>
                    <option value="Yongsan International School of Seoul">Yongsan International School of Seoul</option>
                </select>
                <input type="email" id="signupEmail" placeholder="Email Address" required>
                <input type="password" id="signupPassword" placeholder="Password" required ...>
                <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required>

                <div class="tos-container">
                    <input type="checkbox" id="signupTos" required>
                    <label for="signupTos">I agree to the <a href="#" onclick="event.preventDefault(); showTosPage();">Terms of Service</a></label>
                </div>

                <button onclick="handleSignup(this)">Register</button>
                <a href="#" onclick="showPage('login-page')">Back to log in</a>
            </div>
        </main>
    </div>

    <div id="tos-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage(previousPageId || 'login-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Terms of Service</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <div class="content-section">
                <div id="tos-content"></div>

            </div>
        </main>
    </div>

    <div id="search-results-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Search Results</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <h2 id="search-query-display" style="text-align: center;"></h2>
            <div id="search-results-container">
                </div>
        </main>
    </div>


    <div id="all-articles-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('explore-page')"><i class="fas fa-arrow-left"></i> Back to Explore</a>
            </div>
            <div class="header-center">
                <p id="all-articles-title">All Articles</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <div class="content-section">
                <ul id="all-articles-grid" class="article-grid">
                    </ul>
            </div>
        </main>
    </div>

    <div id="create-article-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('explore-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>New Article</p></div>
            <div class="header-right">
                <button class="login-btn" onclick="handleCreateArticle(this)">Publish</button>
            </div>
        </header>
        <main>
            <div class="content-section" style="max-width: 800px; margin: 0 auto;">
                <input type="text" id="articleTitleInput" placeholder="Article Title..." style="width: 100%; font-size: 1.5em; padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ddd;">
                <textarea id="tinymce-editor"></textarea>

            </div>
        </main>
    </div>

    <div id="index-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="logo" onclick="showPage('index-page')">
                    <img src="/api/asset/logo_text" alt="APEX Logo" class="logo-img">
                </a>
            </div>
            <div class="header-center">
                <p id="mainHeaderTitle">More</p>
            </div>
            <div class="header-right">
                <div class="group">
                    <svg class="icon" aria-hidden="true" viewBox="0 0 24 24"><g><path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path></g></svg>
                    <input placeholder="Search" type="search" class="input" id="main-search-input">
                </div>
                    <button class="login-btn" onclick="handleLogout()">Log out</button>
            </div>
        </header>

        <main>
            <div class="profile-section">
                <div class="profile-row-scroller">
                    <div class="profile-row" id="profile-list">
                        </div>
                </div>
                <a href="#" class="more-link" onclick="showPage('all-profiles-page')">More</a>
            </div>

            <div class="content-section">
                <h3>Trending now</h3>
                <div class="profile-row-scroller">
                    <div id="trending-now-list" class="profile-row">
                        </div>
                </div>
                <a href="#" class="more-link" onclick="showPage('all-trending-page')">More</a>
            </div>

            <div class="content-section">
                <h3>Lounges</h3>
                <div class="profile-row-scroller">
                    <div id="lounge-list-row" class="profile-row">
                        </div>
                </div>
                <a href="#" class="more-link" onclick="showPage('all-lounges-page')">More</a>
            </div>
        </main>
    </div>

    <div id="all-trending-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>Trending Content</p></div>
            <div class="header-right"></div>
        </header>
        <main>
            <div id="all-trending-container"></div>
        </main>
    </div>

    <div id="all-lounges-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>All Lounges</p></div>
            <div class="header-right"></div>
        </header>
        <main>
            <div id="all-lounges-grid" class="circuit-grid">
                </div>
        </main>
    </div>

    <div id="edit-lounge-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showLounge(currentLoungeId, document.getElementById('lounge-header-title').textContent)"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>Edit Lounge</p></div>
            <div class="header-right">
                <button class="login-btn" onclick="handleEditLounge(this)">Save Changes</button>
            </div>
        </header>
        <main>
            <div class="auth-form" style="max-width: 600px;">
                <div class="circuit-cover-uploader">
                    <label for="editLoungeCoverInput">Cover Image</label>
                    <div id="editLoungeCoverPreview" class="circuit-cover-preview lounge-cover-preview-banner">
                        <span>+ Upload Banner / Change</span>
                    </div>
                    <input type="file" id="editLoungeCoverInput" accept="image/*" style="display: none;">
                </div>

                <input type="text" id="editLoungeName" placeholder="Lounge Name" maxlength="20" style="margin-top: 15px;">
                <span id="editLoungeNameCounter" class="char-counter" style="margin-bottom: 10px;">0 / 20</span>

                <textarea id="editLoungeDescription" placeholder="A short description for your lounge..." rows="3" maxlength="600"></textarea>
                <span id="editLoungeDescCounter" class="char-counter">0 / 600</span>

                <p id="editLoungePrivacyDisplay" style="margin-top: 20px; color: #555; font-style: italic;">Privacy setting cannot be changed.</p>
            </div>
        </main>
    </div>

    <div id="create-lounge-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('all-lounges-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>New Lounge</p></div>
            <div class="header-right">
                <button class="login-btn" onclick="handleCreateLounge(this)">Create</button>
            </div>
        </header>
        <main>
            <div class="auth-form" style="max-width: 600px;"> <div class="circuit-cover-uploader">
                    <label for="loungeCoverInput">Cover Image (Optional)</label>
                    <div id="loungeCoverPreview" class="circuit-cover-preview lounge-cover-preview-banner">
                        <span>+ Upload Banner</span>
                    </div>
                    <input type="file" id="loungeCoverInput" accept="image/*" style="display: none;">
                </div>

                <input type="text" id="loungeName" placeholder="Lounge Name" maxlength="20" style="margin-top: 15px;">
                <span id="loungeNameCounter" class="char-counter" style="margin-bottom: 10px;">0 / 20</span>
                <textarea id="loungeDescription" placeholder="A short description for your lounge..." rows="3" maxlength="600"></textarea>
                <span id="loungeDescCounter" class="char-counter">0 / 600</span>
                
                <div class="form-field-wrapper" style="text-align: left; margin-top: 20px;">
                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">Privacy Settings</label>
                    <div class="privacy-options-container">
                        <label for="privacyPublic">
                            <input type="radio" id="privacyPublic" name="loungePrivacy" value="public" checked>
                            <div class="privacy-option-card">
                                <i class="fas fa-globe-americas"></i>
                                <h4>Public</h4>
                                <p>Anyone can find and join.</p>
                            </div>
                        </label>
                        <label for="privacyUnlisted">
                            <input type="radio" id="privacyUnlisted" name="loungePrivacy" value="unlisted">
                            <div class="privacy-option-card">
                                <i class="fas fa-link"></i>
                                <h4>Unlisted</h4>
                                <p>Anyone with the link can join.</p>
                            </div>
                        </label>
                        <label for="privacyPrivate">
                            <input type="radio" id="privacyPrivate" name="loungePrivacy" value="private">
                            <div class="privacy-option-card">
                                <i class="fas fa-lock"></i>
                                <h4>Private</h4>
                                <p>Only invited members can join.</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="my-lounges-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showProfile('me')"><i class="fas fa-arrow-left"></i> Back to Profile</a>
            </div>
            <div class="header-center"><p>My Lounges</p></div>
            <div class="header-right"></div>
        </header>
        <main>
            <div id="my-lounges-grid" class="circuit-grid">
                </div>
        </main>
    </div>

    <div id="my-activity-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showProfile('me')"><i class="fas fa-arrow-left"></i> Back to Profile</a>
            </div>
            <div class="header-center"><p>My Activity</p></div>
            <div class="header-right"></div>
        </header>
        <main>
            <div id="my-activity-container" style="max-width: 800px; margin: 0 auto;">
                </div>
        </main>
    </div>
    <div id="profile-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p id="profileNameHeader">Profile</p>
            </div>
            <div class="header-right">
                <div id="profile-menu-button" class="profile-menu-button">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
                <div id="profile-menu-dropdown" class="profile-menu-dropdown hidden">
                </div>
            </div>
        </header>

        <main>
            <main>
                <div class="profile-card">
                    <div class="profile-pic-large"></div>
                    <h2 id="userName">Name</h2>
                    <p id="userUsername" class="user-username-text"></p>
                    <p id="userBio" class="user-bio-text"></p>
                    <p id="userSchool">School: calvin school</p>
                    <p id="userAge">Grade: G9</p>
                    <p id="userEmail">Email: user@example.com</p>

                    <div id="profile-stats-bar" class="profile-stats" style="display: none;">
                        <div class="stat-item">
                            <span id="post-count">0</span>
                            <span>Posts</span>
                        </div>
                        <div class="stat-item">
                            <span id="follower-count">-</span>
                            <span>Followers</span>
                        </div>
                        <div id="following-stat" class="stat-item">
                            <span id="following-count">0</span>
                            <span>Following</span>
                        </div>
                    </div>
                    </div>
            </main>
        </main>
    </div>

    <div id="edit-profile-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showProfile('me')">
                    <i class="fas fa-times"></i> Back
                </a>
            </div>
            <div class="header-center">
                <p>Edit Profile</p>
            </div>
            <div class="header-right">
                <button class="login-btn" onclick="saveProfile()">Save</button>
                <span id="save-success" class="save-success-message">Saved!</span>
            </div>
        </header>
        <main>
            <div class="auth-form">
                <div class="edit-profile-pic">
                    <div id="editProfilePicPreview" class="profile-pic-large"></div>
                    <label for="profilePicInput" class="change-photo-label">Change Photo</label>
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                </div>
                <h3>Public Information</h3>
                <input type="text" id="editFullName" placeholder="Full Name">
                <input type="text" id="editUsername" placeholder="Username">
                <textarea id="editBio" placeholder="Your Bio..." rows="4" maxlength="150"></textarea>
                <div id="bioCharCounter" class="char-counter">0 / 150</div>

                <h3 style="margin-top: 30px;">Private Details</h3>
                <input type="password" id="editPassword" placeholder="New Password (optional)">
                <input type="password" id="editConfirmPassword" placeholder="Confirm New Password">

                <h3 style="margin-top: 30px;">Privacy Settings</h3>
                <div class="setting-item">
                    <span class="setting-item-label">Show birthday icon on profile</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="editShowBirthday">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-item-label">Show follower/following counts</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="editShowSocialStats">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </main>
    </div>


    <div id="messages-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Messages</p>
            </div>
            <div class="header-right">
                <i class="fas fa-edit" style="font-size: 1.5em; cursor: pointer;" onclick="showNewChatModal()"></i>
            </div>
        </header>

        <main class="messages-main">
            <div class="messages-container">

                <div class="chat-list-pane">
                    <div class="chat-list-header">
                        <h4>Chats</h4>
                    </div>
                    <ul id="chat-list" class="chat-list">
                        </ul>
                </div>

                <div class="active-chat-pane">
                    <div id="active-chat-header" class="active-chat-header"></div>

                    <div id="chat-body" class="chat-body">
                        <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; color:#8e8e8e;">
                            <i class="fas fa-paper-plane" style="font-size:4em; margin-bottom:15px;"></i>
                            <h3 style="margin:0; font-size:1.4em;">Your Messages</h3>
                            <p>Select a message to chat</p>
                        </div>
                    </div>

                    <div id="theme-sidebar" class="theme-sidebar hidden">
                        <div class="theme-sidebar-header">
                            <h4>Customize Chat</h4>
                            <span onclick="closeThemeSidebar()">&times;</span>
                        </div>
                        <div class="theme-options">
                            <div class="theme-option" onclick="setChatTheme('apex')">
                                <div class="theme-preview theme-apex-preview"></div>
                                <span>Apex</span>
                            </div>
                            <div class="theme-option" onclick="setChatTheme('colorless')">
                                <div class="theme-preview theme-colorless-preview"></div>
                                <span>Colorless</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="dm-image-preview-container" class="image-preview-container hidden"></div>

                    <div class="chat-input">
                        <button id="attach-btn" class="emoji-btn" onclick="document.getElementById('image-upload-input').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="image-upload-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <button id="emoji-btn" class="emoji-btn"><i class="fas fa-smile"></i></button>
                        <input type="text" id="main-chat-input-field" placeholder="Message..." autocomplete="off" />
                        <button onclick="sendMessage()">Send</button> 

                    </div>

                    <div id="emoji-panel" class="emoji-panel hidden"></div>
                </div> </div> </main>
    </div>

    <nav class="side-nav">
        <div class="nav-top">
            <a href="#" class="nav-item" onclick="showPage('index-page')"><i class="fas fa-home"></i></a>
            <a href="#" class="nav-item" onclick="showMessagesHome()"><i class="fas fa-envelope"></i><span id="message-notification-badge" class="notification-badge" style="display: none;"></span></a>
            <a href="#" class="nav-item" onclick="showPage('explore-page')"><i class="fas fa-compass"></i></a>
            <a href="#" class="nav-item" onclick="showPage('notifications-page')"><i class="fas fa-bell"></i><span id="general-notification-badge" class="notification-badge" style="display: none;"></span></a>
            <a href="#" id="terminal-nav-btn" class="nav-item" onclick="showPage('terminal-page')" style="display: none;"><i class="fas fa-terminal"></i></a>
        </div>
        <div class="nav-bottom">
            <a href="#" class="nav-item" onclick="showProfile('me')">
                <div class="profile-pic nav-user-pic" data-user-pic-id="me"></div>
            </a>
            <a href="#" class="nav-item" onclick="showReportPage(null, null)"><i class="fas fa-bullhorn"></i></a>
        </div>
    </nav>

    <div id="chat-window" class="chat-window">
        <div class="chat-header">
            <span id="chat-recipient-name"></span>
            <button class="close-btn" onclick="closeChat()">x</button>
        </div>
        <div id="popup-chat-body" class="chat-body">
            </div>
        <div class="chat-input">
            <input type="text" id="chat-input-field" placeholder="Message..." autocomplete="off">
            <button onclick="sendMessage({text: document.getElementById('main-chat-input-field').value})">Send</button>

        </div>
    </div>

    <div id="all-profiles-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back to Home</a>
            </div>
            <div class="header-center">
                <p>All Profiles</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <div id="all-profiles-grid" class="all-profiles-grid">
                </div>
        </main>
    </div>
    <div id="all-circuits-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('explore-page')">
                    <i class="fas fa-arrow-left"></i> Back to Explore
                </a>
            </div>
            <div class="header-center"><p>All Circuits</p></div>
            <div class="header-right"></div>
        </header>
        <main>
            <div id="all-circuits-grid" class="circuit-grid">
                </div>
        </main>
    </div>
    <div id="lounge-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p id="lounge-header-title">The Lounge</p></div>

            <div class="header-right"></div>
            
        </header>
        
        <main class="messages-main"> <div class="lounge-container">
                <div class="lounge-sidebar">
                    <div class="lounge-sidebar-header">
                        <h4 id="lounge-sidebar-title">Lounge Name</h4>
                    </div>
                    <div class="lounge-channel-category">Chats</div>

                    <div class="lounge-channel-list-wrapper">
                        <ul id="lounge-channels-list" class="lounge-channels-list">
                            </ul>
                    </div>

                </div>

                <div class="active-lounge-pane">

                    <div id="lounge-join-overlay">
                        <div class="join-lounge-card">
                            <i id="join-lounge-privacy-icon" class="fas fa-globe-americas privacy-icon"></i>
                            <h3 id="join-lounge-title">You found a new Lounge!</h3>
                            <p id="join-lounge-description">Join this Lounge to view channels, see messages, and chat with other members.</p>
                            <button id="join-lounge-btn" class="join-lounge-btn" onclick="handleJoinLounge()">
                                <i class="fas fa-sign-in-alt"></i> Join Lounge
                            </button>
                        </div>
                    </div>

                    <div id="lounge-body" class="chat-body">
                        </div>

                    <div id="lounge-image-preview-container" class="image-preview-container hidden"></div>

                    <div id="lounge-input" class="chat-input">
                        <button class="emoji-btn" onclick="document.getElementById('lounge-image-upload-input').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="lounge-image-upload-input" accept="image/*" style="display: none;" onchange="handleLoungeImageUpload(event)">
                        <button id="lounge-emoji-btn" class="emoji-btn"><i class="fas fa-smile"></i></button>
                        <input type="text" id="lounge-input-field" placeholder="Message in #general" autocomplete="off" />
                        <button onclick="sendLoungeMessage()">Send</button> 
                        <div id="lounge-emoji-panel" class="emoji-panel hidden"></div>
                    </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000'
        let apiToken = null;
        let socket = null;
        let newLoungeCoverUrl = null;
        let previousPageId = 'login-page';
        let unreadSenders = new Set();
        let unreadNotificationCount = 0;
        let currentLoungeMessages = [];
        let newCircuitCoverUrl = '';
        let followingList = []; // This will store the IDs of users you follow
        let postCreationContext = { type: null, id: null };
        let currentCircuitPosts = [];
        let currentLoungeId = null;
        let dmImagePreviewUrl = null;
        let reportEvidenceImageUrl = null;
        let loungeImagePreviewUrl = null;
        let pendingSignupData = null; // To hold signup info during verification
        let generatedVerificationCode = null; // To store the code we send
        const profileData = {
            me: {
                name: '',
                username: '',
                email: '',
                school: '',
                dob: '',
                grade: null,
                bio: '',
                profilePicUrl: '',
                rank: 'user', // Default rank
                blockedUsers: []
            }
        };




        const postData = {
            'post1': {
                userId: 'user1',
                imageUrl: 'https://picsum.photos/id/1015/500/500',
                caption: 'Exploring the city!',
                likes: 142,
                comments: 15,
                isLiked: false
            },
            'post2': {
                userId: 'user1',
                imageUrl: 'pug.png', // Changed from the https://picsum.photos link
                caption: 'My new puppy!',
                likes: 301,
                comments: 42,
                isLiked: true
            },


            'post3': {
                userId: 'user2',
                imageUrl: 'https://picsum.photos/id/1043/500/500',
                caption: 'Coffee time.',
                likes: 88,
                comments: 9,
                isLiked: false
            }
        };

        const truncate = (text, len) => {
            if (!text) return '';
            return text.length > len ? text.substring(0, len) + '...' : text;
        };

        let messageHistory = {};
        let currentChatRecipient = null;
        let loggedIn = false;
        let verificationCodeSent = false;
        let currentCircuitId = null;
        let currentCircuitDetails = null;
        let currentUserLoungeRole = null; // Add this new global variable
        let allCircuitsData = [];
        let newPostImageUrl = '';

        // Replace your initializeEventListeners function with this corrected version
        function initializeEventListeners() {
            // --- Login Form ---
            const loginForm = document.querySelector('#login-page .auth-form');
            if (loginForm) {
                loginForm.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        handleLogin();
                    }
                });
            }

            // --- Signup Form ---
            const signupForm = document.querySelector('#signup-page .auth-form');
            if (signupForm) {
                signupForm.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        handleSignup();
                    }
                });
            }

            // --- Direct Message Input ---
            const chatInput = document.getElementById('main-chat-input-field');
            if (chatInput) {
                chatInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        sendMessage({ text: chatInput.value });
                    }
                });
                // UPDATED: Use the new paste handler for DMs
                chatInput.addEventListener('paste', (event) => handleImagePaste(event, 'dm'));
            }

            // --- Lounge Chat Input ---
            const loungeInput = document.getElementById('lounge-input-field');
            if (loungeInput) {
                loungeInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        sendLoungeMessage({text: loungeInput.value});
                    }
                });
                // NEW: Use the new paste handler for Lounges
                loungeInput.addEventListener('paste', (event) => handleImagePaste(event, 'lounge'));
            }

            // --- Search Input ---
            const searchInput = document.getElementById('main-search-input');
            if (searchInput) {
                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        handleSearch(searchInput.value);
                    }
                });
            }
            
            // --- Terminal Input ---
            const terminalInput = document.getElementById('terminal-input');
            if (terminalInput) {
                terminalInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        handleTerminalCommand();
                    }
                });
            }

            // --- Menu Closing Logic (unchanged) ---
            const menuButton = document.getElementById('profile-menu-button');
            const menuDropdown = document.getElementById('profile-menu-dropdown');
            if (menuButton && menuDropdown) {
                menuButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    menuDropdown.classList.toggle('hidden');
                });
            }

            document.addEventListener('click', (event) => { // Added event parameter
                closeAllPopups(event); // Pass event to popups if needed

                // --- Safely close menus ---
                const profileMenuDropdown = document.getElementById('profile-menu-dropdown');
                const profileMenuButton = document.getElementById('profile-menu-button');
                // Check if profileMenuDropdown exists AND the click was outside both the button and dropdown
                if (profileMenuDropdown && !profileMenuDropdown.classList.contains('hidden') &&
                    (!profileMenuButton || !profileMenuButton.contains(event.target)) &&
                    !profileMenuDropdown.contains(event.target)) {
                    profileMenuDropdown.classList.add('hidden');
                }

                const chatMenuDropdown = document.getElementById('chat-menu-dropdown');
                const chatMenuButton = document.getElementById('chat-menu-button');
                 // Check if chatMenuDropdown exists AND the click was outside both the button and dropdown
                if (chatMenuDropdown && !chatMenuDropdown.classList.contains('hidden') &&
                    (!chatMenuButton || !chatMenuButton.contains(event.target)) &&
                    !chatMenuDropdown.contains(event.target)) {
                    chatMenuDropdown.classList.add('hidden');
                }

                // --- Safely close theme sidebar ---
                const themeSidebar = document.getElementById('theme-sidebar');
                if (themeSidebar && !themeSidebar.classList.contains('hidden') && !themeSidebar.contains(event.target)) {
                     // Optionally check if the click was also outside the button that opens it
                     const themeOpenButton = document.querySelector('[onclick*="openThemeSidebar"]'); // Find the button
                     if (!themeOpenButton || !themeOpenButton.contains(event.target)) {
                         closeThemeSidebar();
                     }
                }

                // --- Close Modals on background click ---
                if (event.target.classList.contains('following-modal')) {
                    // Close specific modals by checking their visibility or content
                    closeFollowingModal(); // Assumes this checks if it's open
                    closeLoungeMembersModal();
                    closeLoungeDetailsModal();
                    closeCircuitDetailsModal();
                    closeNewChatModal();
                    closeInviteUserModal();
                    closeCreateChannelModal();
                    closeConfirmationModal(); // Added confirmation modal
                    // Add other modals here
                }
            });

            // --- Post Modal Closing Logic (unchanged) ---
            const postModal = document.getElementById('post-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');

            closeModalBtn.addEventListener('click', closePostModal);

            postModal.addEventListener('click', (event) => {
                if (event.target === postModal) {
                    closePostModal();
                }
            });
        }

        const EMOJI_LIST = [
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', ''
        ];


        let reactionTooltipTimer = null; // To manage the hover delay

        function showReactionTooltip(event, messageId, emoji) {
            hideReactionTooltip(); // Clear any existing timer/tooltip

            reactionTooltipTimer = setTimeout(() => {
                fetch(`${API_BASE_URL}/api/dm/message/${messageId}/reaction/${encodeURIComponent(emoji)}`, {
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                })
                .then(response => response.json())
                .then(usernames => {
                    if (usernames.length === 0) return;

                    const tooltip = document.createElement('div');
                    tooltip.id = 'reaction-tooltip';
                    tooltip.style.position = 'absolute';
                    tooltip.style.backgroundColor = 'rgba(0,0,0,0.8)';
                    tooltip.style.color = 'white';
                    tooltip.style.padding = '5px 10px';
                    tooltip.style.borderRadius = '5px';
                    tooltip.style.zIndex = '3000';
                    tooltip.textContent = usernames.join(', ');
                    document.body.appendChild(tooltip);

                    // --- THIS IS THE NEW BOUNDARY CHECK LOGIC ---
                    const tooltipRect = tooltip.getBoundingClientRect();
                    let idealTop = event.pageY - tooltipRect.height - 5; // Position above cursor
                    let idealLeft = event.pageX - (tooltipRect.width / 2); // Center on cursor

                    const screenEdgeMargin = 10;

                    // Check left boundary
                    if (idealLeft < screenEdgeMargin) {
                        idealLeft = screenEdgeMargin;
                    }
                    // Check right boundary
                    if (idealLeft + tooltipRect.width > window.innerWidth - screenEdgeMargin) {
                        idealLeft = window.innerWidth - tooltipRect.width - screenEdgeMargin;
                    }
                    // Check top boundary
                    if (idealTop < screenEdgeMargin) {
                        idealTop = event.pageY + 15; // Move below cursor if it's off the top
                    }
                    // --- END OF NEW LOGIC ---

                    tooltip.style.left = `${idealLeft}px`;
                    tooltip.style.top = `${idealTop}px`;
                });
            }, 1000); // 1-second delay
        }

        function hideReactionTooltip() {
            clearTimeout(reactionTooltipTimer);
            const tooltip = document.getElementById('reaction-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

        function showReactionPicker(event, messageId) {
            event.stopPropagation();
            const pickerId = `picker-dm-${messageId}`;
            const existingPicker = document.getElementById(pickerId);

            // First, close all other pickers
            document.querySelectorAll('.reaction-picker').forEach(p => {
                if (p.id !== pickerId) p.remove();
            });

            // If the picker for this specific message already exists, remove it and stop.
            if (existingPicker) {
                existingPicker.remove();
                return;
            }

            // Otherwise, create the new picker
            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            picker.id = pickerId; // Give it a unique ID

            const commonReactions = ['', '', '', '', '', ''];
            commonReactions.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.onclick = () => sendReaction(messageId, emoji);
                picker.appendChild(span);
            });

            document.body.appendChild(picker);

            // Positioning logic (unchanged)
            const buttonRect = event.target.getBoundingClientRect();
            const pickerRect = picker.getBoundingClientRect();
            const screenEdgeMargin = 10;
            const pickerTop = buttonRect.top + window.scrollY - pickerRect.height - 10;
            let idealPickerLeft = buttonRect.left + window.scrollX + (buttonRect.width / 2) - (pickerRect.width / 2);
            if (idealPickerLeft < screenEdgeMargin) idealPickerLeft = screenEdgeMargin;
            if (idealPickerLeft + pickerRect.width > window.innerWidth - screenEdgeMargin) {
                idealPickerLeft = window.innerWidth - pickerRect.width - screenEdgeMargin;
            }
            picker.style.top = `${pickerTop}px`;
            picker.style.left = `${idealPickerLeft}px`;
        }

        /**
         * Sends the chosen reaction to the server.
         */
        function sendReaction(messageId, emoji) {
            // --- THIS IS THE FIX ---
            // Instantly hide any tooltips the moment a reaction is clicked.
            hideReactionTooltip();
            // --- END OF FIX ---

            fetch(`${API_BASE_URL}/api/dm/message/${messageId}/react`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ emoji: emoji })
            });
            // Clean up the picker after reacting
            const existingPicker = document.querySelector('.reaction-picker');
            if (existingPicker) existingPicker.remove();
        }

        /**
         * Cancels (removes) a reaction from a message.
         */


        function fetchAndRenderTrending() {
            const container = document.getElementById('trending-now-list');
            container.innerHTML = '<p style="padding-left: 15px;">Loading trending content...</p>';

            fetch(`${API_BASE_URL}/api/trending?limit=7`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(items => {
                    // --- THIS IS THE MAIN CHANGE ---
                    // Filter the items to ONLY include circuits and lounges for the index page.
                    const filteredItems = items.filter(item => item.type === 'circuit' || item.type === 'lounge');
                    // --- END CHANGE ---

                    container.innerHTML = ''; // Clear loading message
                    if (filteredItems.length === 0) {
                        container.innerHTML = '<p style="padding-left: 15px;">Nothing is trending right now.</p>';
                        return;
                    }

                    // Now iterate over the *filtered* items
                    filteredItems.forEach(item => {
                        if (item.type === 'circuit') {
                            const card = document.createElement('div');
                            card.className = 'circuit-card';
                            card.onclick = () => showCircuit(item.id, item.title, item.hostSchool);
                            if (item.coverImage) {
                                card.style.backgroundImage = `url(${item.coverImage})`;
                            } else {
                                card.classList.add('no-image');
                            }
                            card.innerHTML = `
                                <h4>${truncate(item.title, 10)}</h4>
                                <p>${truncate(item.hostSchool, 10)}</p>
                                <div class="circuit-views"><i class="fas fa-eye"></i> ${item.daily_views}</div>
                            `;
                            container.appendChild(card);
                        }
                        // ---  ADD THIS ENTIRE BLOCK  ---
                        else if (item.type === 'lounge') {
                            const card = document.createElement('div');
                            card.className = 'circuit-card'; // Reuse the same circular card style
                            card.onclick = () => showLounge(item.id, item.name);
                            if (item.cover_image) {
                                card.style.backgroundImage = `url(${item.cover_image})`;
                            } else {
                                card.classList.add('no-image');
                            }
                            card.innerHTML = `
                                <h4>${truncate(item.name, 10)}</h4>
                                <p>${truncate(item.description, 15)}</p>
                                <div class="circuit-views"><i class="fas fa-eye"></i> ${item.daily_views}</div>
                            `;
                            container.appendChild(card);
                        }
                        // ---  END OF NEW BLOCK  ---
                    });
                })
                .catch(error => {
                    console.error("Error fetching trending content:", error);
                    container.innerHTML = '<p style="padding-left: 15px; color: red;">Could not load trending content.</p>';
                });
        }

        function openCircuitDetailsModal() {
            const menu = document.getElementById('circuit-menu-dropdown');
            if (menu) menu.classList.add('hidden');

            if (!currentCircuitDetails) return;

            const modal = document.getElementById('circuit-details-modal');
            const body = document.getElementById('circuit-details-body');

            // This is now much simpler because the backend does the work for us.
            const viewsToday = currentCircuitDetails.daily_views || 0;

            body.innerHTML = `
                <p><strong>Title:</strong> ${currentCircuitDetails.title}</p>
                <p><strong>Affiliation:</strong> ${currentCircuitDetails.hostSchool}</p>
                <p><strong>Code:</strong> ${currentCircuitDetails.code}</p>
                <p><strong>Daily Views:</strong> ${viewsToday}</p>
            `;
            modal.classList.remove('hidden');
        }

        function closeCircuitDetailsModal() {
            document.getElementById('circuit-details-modal').classList.add('hidden');
        }

        function handleSearch(query) {
            if (!query.trim()) return;

            const resultsContainer = document.getElementById('search-results-container');
            const queryDisplay = document.getElementById('search-query-display');

            showPage('search-results-page');
            queryDisplay.textContent = `Results for "${query}"`;
            resultsContainer.innerHTML = '<p style="text-align:center;">Searching...</p>';
            document.getElementById('main-search-input').value = query;

            fetch(`${API_BASE_URL}/api/search?q=${encodeURIComponent(query)}`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultsContainer.innerHTML = `<p style="color: red; text-align:center;">Error: ${data.error}</p>`;
                } else {
                    renderSearchResults(data, query);
                }
            })
            .catch(error => {
                console.error('Search failed:', error);
                resultsContainer.innerHTML = '<p style="color: red; text-align:center;">Could not perform search.</p>';
            });
        }

        function renderSearchResults(data, query) {
            const container = document.getElementById('search-results-container');
            container.innerHTML = '';
            let contentFound = false;

            if (data.users && data.users.length > 0) {
                contentFound = true;
                const section = document.createElement('div');
                section.className = 'content-section';
                let html = '<h3>Users</h3><div class="all-profiles-grid">';
                data.users.forEach(user => {
                    // --- FIX #1: Store the user data locally so the picture can be found ---
                    if (!profileData[user.username]) {
                        profileData[user.username] = { name: user.fullName, profilePicUrl: user.profile_pic, ...user };
                    }
                    // --- END FIX #1 ---
                    
                    html += `
                        <div class="profile-grid-card" onclick="showProfile('${user.username}')">
                            <div class="profile-pic" data-user-pic-id="${user.username}"></div>
                            <p class="profile-card-name">${user.fullName} ${getRankIcon(user.rank)}</p>
                            <p class="profile-card-username">@${user.username}</p>
                        </div>`;
                    // The setTimeout is now redundant but safe to keep
                    setTimeout(() => updateProfilePictures(user.username), 0);
                });
                html += '</div>';
                section.innerHTML = html;
                container.appendChild(section);
            }

            if (data.circuits && data.circuits.length > 0) {
                contentFound = true;
                const section = document.createElement('div');
                section.className = 'content-section';
                let html = '<h3>Circuits</h3><div class="circuit-grid">';
                data.circuits.forEach(c => {
                    // --- FIX #2: Correctly build the card with a background image or 'no-image' class ---
                    let cardClass = 'circuit-card';
                    let cardStyle = '';
                    if (c.coverImage) {
                        cardStyle = `style="background-image: url(${c.coverImage})"`;
                    } else {
                        cardClass += ' no-image';
                    }
                    html += `<div class="${cardClass}" ${cardStyle} onclick="showCircuit(${c.id},'${c.title.replace(/'/g, "\\'")}', '${c.hostSchool.replace(/'/g, "\\'")}');"><h4>${c.title}</h4><p>${c.hostSchool}</p></div>`;
                    // --- END FIX #2 ---
                });
                html += '</div>';
                section.innerHTML = html;
                container.appendChild(section);
            }

            if (data.lounges && data.lounges.length > 0) {
                contentFound = true;
                const section = document.createElement('div');
                section.className = 'content-section';
                let html = '<h3>Lounges</h3><div class="circuit-grid">';
                data.lounges.forEach(l => {
                    // --- FIX #3: Add the same logic for lounge cover images ---
                    let cardClass = 'circuit-card';
                    let cardStyle = '';
                    if (l.cover_image) {
                        cardStyle = `style="background-image: url(${l.cover_image})"`;
                    } else {
                        cardClass += ' no-image';
                    }
                    html += `<div class="${cardClass}" ${cardStyle} onclick="showLounge(${l.id},'${l.name.replace(/'/g, "\\'")}');"><h4>${l.name}</h4><p>${truncate(l.description, 20)}</p></div>`;
                    // --- END FIX #3 ---
                });
                html += '</div>';
                section.innerHTML = html;
                container.appendChild(section);
            }

            if (data.articles && data.articles.length > 0) {
                // ... (article rendering is unchanged and correct) ...
                contentFound = true;
                const section = document.createElement('div');
                section.className = 'content-section';
                let html = '<h3>Articles</h3><div class="article-grid">';
                data.articles.forEach(a => {
                    html += `
                        <div class="card">
                            <div class="card__img"><span class="card__span">${a.schoolTag}</span></div>
                            <div class="card-int">
                                <p class="card-int__title">${a.title}</p>
                                <p class="excerpt">by ${a.author}</p>
                                <button class="card-int__button" onclick="showArticle(${a.id})">Read</button>
                            </div>
                        </div>`;
                });
                html += '</div>';
                section.innerHTML = html;
                container.appendChild(section);
            }

            if (!contentFound) {
                container.innerHTML = `<p style="text-align:center; color:#555;">No results found for "${query}".</p>`;
            }
        }

        function initializeEmojiPicker() {
            // We target elements specifically within the messages page
            const messagesPage = document.getElementById('messages-page');
            if (!messagesPage) return;

            const emojiBtn = messagesPage.querySelector('#emoji-btn');
            const emojiPanel = messagesPage.querySelector('#emoji-panel');
            const messageInput = messagesPage.querySelector('#main-chat-input-field');

            // Make sure all elements were found before proceeding
            if (!emojiBtn || !emojiPanel || !messageInput) return;

            // Clear any old emojis before populating
            emojiPanel.innerHTML = '';

            // Populate the panel
            EMOJI_LIST.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.onclick = () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                };
                emojiPanel.appendChild(span);
            });

            // Toggle the panel when the button is clicked
            emojiBtn.onclick = (event) => {
                event.stopPropagation();
                emojiPanel.classList.toggle('hidden');
            };

            // Add a listener to the whole page to close the panel
            document.addEventListener('click', (event) => {
                // This function will now handle closing all menus and modals when the user clicks away.

                // 1. Close all context menus (right-click menus)
                // We check if the click was outside the menu itself before removing it.
                document.querySelectorAll('.context-menu').forEach(menu => {
                    if (!menu.contains(event.target)) {
                        menu.remove();
                    }
                });

                // 2. Close the lounge header dropdown menu
                const loungeMenu = document.getElementById('lounge-menu-dropdown');
                const loungeMenuBtn = document.querySelector('#lounge-page .profile-menu-button');
                if (loungeMenu && !loungeMenu.classList.contains('hidden')) {
                    // Close if the click is outside the menu AND outside its button
                    if (!loungeMenu.contains(event.target) && !loungeMenuBtn.contains(event.target)) {
                        loungeMenu.classList.add('hidden');
                    }
                }
                
                // 3. Close the profile page dropdown menu (if it exists)
                const profileMenu = document.getElementById('profile-menu-dropdown');
                const profileMenuBtn = document.querySelector('#profile-page .profile-menu-button');
                if (profileMenu && !profileMenu.classList.contains('hidden')) {
                    if (!profileMenu.contains(event.target) && profileMenuBtn && !profileMenuBtn.contains(event.target)) {
                        profileMenu.classList.add('hidden');
                    }
                }

                // 4. Close Modals if the click is on the dark background overlay
                if (event.target.classList.contains('following-modal')) {
                    closeLoungeMembersModal();
                    closeLoungeDetailsModal();
                    closeCircuitDetailsModal();
                    // Add any other modals here in the future
                }
            });
        }

        function showCreateChannelModal() {
            document.getElementById('create-channel-modal').classList.remove('hidden');
        }

        function closeCreateChannelModal() {
            document.getElementById('create-channel-modal').classList.add('hidden');
            document.getElementById('new-channel-name').value = '';
        }

        function handleCreateChannel() {
            const name = document.getElementById('new-channel-name').value;
            const permission = document.querySelector('input[name="channel-permission"]:checked').value;

            if (!name.trim()) {
                alert('Please enter a channel name.');
                return;
            }

            fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}/channels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ name: name, permission_level: permission })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 201) {
                    closeCreateChannelModal();
                    // Refresh the entire lounge view to show the new channel
                    showLounge(currentLoungeId, document.getElementById('lounge-header-title').textContent);
                } else {
                    alert('Error: ' + body.error);
                }
            });
        }

        function showAllCircuitsPage() {
            // --- THIS IS THE FIX: We now add the "New Circuit" button to this page's header ---
            const headerRight = document.querySelector('#all-circuits-page .header-right');
            headerRight.innerHTML = `
                <button class="login-btn" onclick="showCreateCircuitPage()">New Circuit</button>
            `;
            // --- END OF FIX ---

            renderAllCircuitsGrid(); // This function will now only render the grid of circuits
            showPage('all-circuits-page');
        }

        function renderAllCircuitsGrid() {
            const grid = document.getElementById('all-circuits-grid');
            grid.innerHTML = '';

            // --- THIS IS THE FIX ---
            // Create and add the "+ New Circuit" button first.
            const createCard = document.createElement('div');
            createCard.className = 'circuit-card create-circuit-card';
            createCard.onclick = () => showCreateCircuitPage();
            createCard.innerHTML = `<h4>+</h4><p>New Circuit</p>`;
            grid.appendChild(createCard);
            // --- END OF FIX ---

            // This function now renders the circuits from the server AFTER the button.
            allCircuitsData.forEach(circuit => {
                const card = document.createElement('div');
                card.className = 'circuit-card';
                card.onclick = () => showCircuit(circuit.id, circuit.title, circuit.hostSchool);
                if (circuit.coverImage) {
                    card.style.backgroundImage = `url(${circuit.coverImage})`;
                } else {
                    card.classList.add('no-image');
                }
                card.innerHTML = `
                    <h4>${circuit.title}</h4>
                    <p>${circuit.hostSchool}</p>
                `;
                grid.appendChild(card);
            });
        }

        function toggleMessageOptions(event, messageId) {
            event.stopPropagation();
            // Close any other open dropdowns first
            document.querySelectorAll('.message-options-dropdown').forEach(d => d.classList.add('hidden'));

            const dropdown = document.getElementById(`options-dropdown-${messageId}`);
            dropdown.classList.toggle('hidden');

            // Position the dropdown correctly next to the button
            const buttonRect = event.target.getBoundingClientRect();
            dropdown.style.top = `${buttonRect.bottom + 5}px`;
            dropdown.style.left = `${buttonRect.left - dropdown.offsetWidth + buttonRect.width}px`;
        }

        function copyMessage(messageId) {
            const textElement = document.getElementById(`message-text-${messageId}`);
            if (textElement) {
                navigator.clipboard.writeText(textElement.textContent)
                    .then(() => alert('Message copied!'))
                    .catch(err => console.error('Failed to copy text: ', err));
            }
            // Close all dropdowns after action
            document.querySelectorAll('.message-options-dropdown').forEach(d => d.classList.add('hidden'));
        }

        function deleteMessage(messageId) {
            if (confirm('Are you sure you want to delete this message?')) {
                fetch(`${API_BASE_URL}/api/dm/message/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                });
            }
            document.querySelectorAll('.message-options-dropdown').forEach(d => d.classList.add('hidden'));
        }



        function showEditUI(messageId) {
            const contentDiv = document.getElementById(`message-content-${messageId}`);
            const text = contentDiv.querySelector('p').textContent;

            contentDiv.innerHTML = `
                <input type="text" id="edit-input-${messageId}" value="${text}" style="width: 80%;" />
                <button onclick="saveEdit(${messageId})">Save</button>
                <button onclick="cancelEdit(${messageId}, '${text}')">Cancel</button>
            `;
            document.querySelectorAll('.message-options-dropdown').forEach(d => d.classList.add('hidden'));
        }

        function saveEdit(messageId) {
            const newText = document.getElementById(`edit-input-${messageId}`).value.trim();
            if (!newText) return;

            fetch(`${API_BASE_URL}/api/dm/message/${messageId}/edit`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ new_text: newText })
            });
        }

        function cancelEdit(messageId, originalText) {
            // This is just a UI function, it doesn't need to call the server.
            const contentDiv = document.getElementById(`message-content-${messageId}`);
            contentDiv.innerHTML = `<p id="message-text-${messageId}">${originalText}</p>`;
        }

        function fetchAndRenderLounges() {
            fetch(`${API_BASE_URL}/api/lounges`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
            .then(response => response.json())
            .then(lounges => {
                allLoungesData = lounges;
                const row = document.getElementById('lounge-list-row');
                row.innerHTML = '';

                const createCard = document.createElement('div');
                createCard.className = 'circuit-card create-circuit-card';
                createCard.onclick = () => showCreateLoungePage();
                createCard.innerHTML = `<h4>+</h4><p>New Lounge</p>`;
                row.appendChild(createCard);

                lounges.slice(0, 7).forEach(lounge => {
                    const card = document.createElement('div');
                    card.className = 'circuit-card';
                    card.onclick = () => showLounge(lounge.id, lounge.name);
                    
                    if (lounge.cover_image) {
                        card.style.backgroundImage = `url(${lounge.cover_image})`;
                    } else {
                        card.classList.add('no-image');
                    }
                    
                    let privacyIcon = ''; // (privacy icon logic is unchanged)
                    if (lounge.privacy === 'private') {
                        privacyIcon = '<i class="fas fa-lock" style="position: absolute; top: 10px; right: 10px; color: white; text-shadow: 1px 1px 2px black; font-size: 0.8em;"></i>';
                    } else if (lounge.privacy === 'unlisted') {
                        privacyIcon = '<i class="fas fa-link" style="position: absolute; top: 10px; right: 10px; color: white; text-shadow: 1px 1px 2px black; font-size: 0.8em;"></i>';
                    }
                    
                    // --- THIS PART IS UPDATED ---
                    card.innerHTML = `
                        <h4>${truncate(lounge.name, 10)}</h4> 
                        <p>${truncate(lounge.description, 15)}</p>
                        ${privacyIcon}
                    `;
                    // --- END UPDATE ---
                    row.appendChild(card);
                });
            });
        }

        function fetchAndRenderMyLounges() {
            const row = document.getElementById('explore-my-lounges-list');
            row.innerHTML = '<p style="padding-left: 15px;">Loading your lounges...</p>';

            // This uses the /api/me/lounges endpoint we created previously
            fetch(`${API_BASE_URL}/api/me/lounges`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
            .then(response => response.json())
            .then(lounges => {
                row.innerHTML = ''; // Clear loading message

                if (!lounges || lounges.length === 0) {
                    row.innerHTML = '<p style="padding-left: 15px; color: #888;">You haven\'t joined any lounges yet.</p>';
                    return;
                }

                // This rendering logic is identical to the home page for a consistent look
                lounges.slice(0, 8).forEach(lounge => {
                    const card = document.createElement('div');
                    card.className = 'circuit-card';
                    card.onclick = () => showLounge(lounge.id, lounge.name);
                    
                    if (lounge.cover_image) {
                        card.style.backgroundImage = `url(${lounge.cover_image})`;
                    } else {
                        card.classList.add('no-image');
                    }
                    
                    let privacyIcon = '';
                    if (lounge.privacy === 'private') {
                        privacyIcon = '<i class="fas fa-lock" style="position: absolute; top: 10px; right: 10px; color: white; text-shadow: 1px 1px 2px black; font-size: 0.8em;"></i>';
                    } else if (lounge.privacy === 'unlisted') {
                        privacyIcon = '<i class="fas fa-link" style="position: absolute; top: 10px; right: 10px; color: white; text-shadow: 1px 1px 2px black; font-size: 0.8em;"></i>';
                    }
                    
                    card.innerHTML = `
                        <h4>${truncate(lounge.name, 10)}</h4> 
                        <p>${truncate(lounge.description, 15)}</p>
                        ${privacyIcon}
                    `;
                    row.appendChild(card);
                });
            });
        }

        function linkifyUsernames(text) {
            if (!text) return '';
            // Regex to find @ followed by 3-20 valid username characters
            const usernameRegex = /@([a-z0-9!._*-]{3,20})/g;

            return text.replace(usernameRegex, (fullMatch, username) => {
                // We add event.stopPropagation() to prevent clicks from bubbling up
                // to a parent element (like a clickable post).
                return `<a class="user-mention" onclick="event.stopPropagation(); showProfile('${username}')">${fullMatch}</a>`;
            });
        }

        // Add this new function to handle creating a lounge
        function handleCreateLounge(button) {
            button.disabled = true;
            button.textContent = 'Creating...';

            const name = document.getElementById('loungeName').value.trim();
            const description = document.getElementById('loungeDescription').value.trim();
            const privacy = document.querySelector('input[name="loungePrivacy"]:checked').value;
            const coverImage = newLoungeCoverUrl;

            if (!name) {
                showToast('Lounge name is required.', 'error');
                button.disabled = false;
                button.textContent = 'Create';
                return;
            }
            // Other validations...

            fetch(`${API_BASE_URL}/api/lounges`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ name: name, description: description, privacy: privacy, coverImage: coverImage })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 201) {
                    showToast('Lounge created successfully!', 'success');
                    showPage('index-page');
                } else {
                    showToast(body.error || 'Could not create lounge.', 'error');
                }
            })
            .catch(error => {
                console.error("Error creating lounge:", error);
                showToast("An unexpected error occurred.", 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Create';
            });
        }

        function renderLoungeChannels(channels) {
            const list = document.getElementById('lounge-channels-list');
            const categoryHeader = document.querySelector('.lounge-channel-category');
            list.innerHTML = '';

            if (currentUserLoungeRole === 'owner' || currentUserLoungeRole === 'moderator') {
                categoryHeader.innerHTML = 'Chats <i class="fas fa-plus" style="cursor: pointer; float: right;" onclick="showCreateChannelModal()"></i>';
            } else {
                categoryHeader.textContent = 'Chats';
            }

            channels.forEach(channel => {
                const li = document.createElement('li');
                li.className = 'lounge-channel-item';
                li.id = `channel-item-${channel.id}`;
                li.onclick = () => loadLoungeChannel(channel);

                const channelNameSpan = document.createElement('span');
                let iconHtml = '';
                
                if (channel.is_main) {
                    iconHtml += '<i class="fas fa-star main-channel-icon"></i>';
                }

                let prefixIcon = '';
                if (channel.permission_level === 'mods_only_chat') {
                    prefixIcon = '<i class="fas fa-lock" style="margin-right: 8px; color: #888;"></i>';
                } else if (channel.permission_level === 'mods_only_view') {
                    prefixIcon = '<i class="fas fa-user-shield" style="margin-right: 8px; color: #888;"></i>';
                }
                
                // ---  THIS IS THE FIX  ---
                // The iconHtml variable is now at the end.
                channelNameSpan.innerHTML = `${prefixIcon}# ${channel.name} ${iconHtml}`;
                // ---  END OF FIX  ---
                
                li.appendChild(channelNameSpan);
                
                const menuBtn = document.createElement('i');
                menuBtn.className = 'fas fa-ellipsis-v channel-options-btn';
                menuBtn.onclick = (event) => openChannelContextMenu(event, channel);
                li.appendChild(menuBtn);

                list.appendChild(li);
            });
        }

        function loadLoungeChannel(channel) {
            // Destructure the channel object to get the properties we need
            const { id, name, permission_level } = channel;

            if (currentLoungeChannelId && socket) {
                socket.emit('leave_lounge_channel', { channel_id: currentLoungeChannelId });
            }
            currentLoungeChannelId = id;
            if (socket) {
                socket.emit('join_lounge_channel', { channel_id: currentLoungeChannelId });
            }

            // Update UI to show which channel is active
            document.querySelectorAll('.lounge-channel-item').forEach(item => item.classList.remove('active'));
            const channelElement = document.getElementById(`channel-item-${id}`);
            if (channelElement) {
                channelElement.classList.add('active');
            }

            const inputField = document.getElementById('lounge-input-field');
            inputField.placeholder = `Message in #${name}`;

            // Disable the input field based on channel permissions and user role
            if (permission_level === 'mods_only_chat' && currentUserLoungeRole === 'member') {
                inputField.disabled = true;
                inputField.placeholder = 'Only moderators can send messages here.';
            } else {
                inputField.disabled = false;
            }

            const chatBody = document.getElementById('lounge-body');
            chatBody.innerHTML = '<p style="text-align:center; color:#888;">Loading history...</p>';

            // Fetch and render the messages for the selected channel
            fetch(`${API_BASE_URL}/api/lounge/channel/${id}/messages`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(messages => {
                currentLoungeMessages = messages;
                renderLoungeMessages(currentLoungeMessages);
            });
        }

        // Add this new function to handle image uploads in lounges
        function handleLoungeImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            processImage(file)
                .then(base64Image => {
                    showImagePreview(base64Image, 'lounge'); // Show Lounge preview
                })
                .catch(err => console.error("Lounge image processing failed:", err));
            event.target.value = null;
        }

        // Replace your existing sendLoungeMessage function
        function sendLoungeMessage() {
            const inputField = document.getElementById('lounge-input-field');
            const text = inputField.value.trim();
            const image = loungeImagePreviewUrl; // Get the image from our preview state

            if ((!text && !image) || !currentLoungeChannelId) return;

            socket.emit('send_lounge_message', {
                text: text,
                image: image,
                channel_id: currentLoungeChannelId
            });

            inputField.value = ''; // Clear the input field
            removeImagePreview('lounge'); // Clean up the preview UI
        }
        let currentLoungeChannelId = null;

        function handleJoinLounge() {
            if (!currentLoungeId) return;
            const joinButton = document.getElementById('join-lounge-btn');
            joinButton.disabled = true;
            joinButton.innerHTML = 'Joining...';

            fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}/join`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    showToast(`Welcome to the lounge!`, 'success');
                    const loungeName = document.getElementById('lounge-header-title').textContent;
                    showLounge(currentLoungeId, loungeName);
                } else {
                    showToast(body.error || 'Could not join the lounge.', 'error');
                    joinButton.disabled = false;
                    joinButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Join Lounge';
                }
            });
        }

        let editLoungeCoverUrl = null;

        function showEditLoungePage(loungeId) {
            console.log(`[Debug] Showing edit page for lounge ID: ${loungeId}`);
            // Fetch the current lounge details to populate the form
            fetch(`${API_BASE_URL}/api/lounge/${loungeId}/details`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(lounge => {
                if (lounge.error) {
                    showToast(lounge.error, 'error');
                    return;
                }

                // Populate form fields
                const nameInput = document.getElementById('editLoungeName');
                const descInput = document.getElementById('editLoungeDescription');
                const nameCounter = document.getElementById('editLoungeNameCounter');
                const descCounter = document.getElementById('editLoungeDescCounter');
                const privacyDisplay = document.getElementById('editLoungePrivacyDisplay');
                const preview = document.getElementById('editLoungeCoverPreview');
                const fileInput = document.getElementById('editLoungeCoverInput');

                nameInput.value = lounge.name;
                descInput.value = lounge.description || '';
                nameCounter.textContent = `${lounge.name.length} / 20`;
                descCounter.textContent = `${(lounge.description || '').length} / 600`;
                privacyDisplay.textContent = `Privacy setting (${lounge.privacy}) cannot be changed.`;

                // Set up image preview and uploader
                editLoungeCoverUrl = lounge.cover_image; // Start with the current image URL
                if (lounge.cover_image) {
                    preview.style.backgroundImage = `url(${lounge.cover_image})`;
                    preview.innerHTML = '';
                } else {
                    preview.style.backgroundImage = 'none';
                    preview.innerHTML = '<span>+ Upload Banner</span>';
                }

                // Add character counters (similar to create lounge)
                nameInput.oninput = () => nameCounter.textContent = `${nameInput.value.length} / 20`;
                descInput.oninput = () => descCounter.textContent = `${descInput.value.length} / 600`;

                // Set up file input handling
                preview.onclick = () => fileInput.click();
                fileInput.value = null; // Clear any previous selection
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) { // Allow removing the image
                        editLoungeCoverUrl = null;
                        preview.style.backgroundImage = 'none';
                        preview.innerHTML = '<span>+ Upload Banner</span>';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        editLoungeCoverUrl = e.target.result; // Store the new Base64 URL
                        preview.style.backgroundImage = `url(${editLoungeCoverUrl})`;
                        preview.innerHTML = '';
                    };
                    reader.readAsDataURL(file);
                };

                // Finally, show the page
                showPage('edit-lounge-page');

            })
            .catch(error => {
                console.error("Error fetching lounge details for edit:", error);
                showToast("Could not load lounge details.", 'error');
            });
        }

        function handleEditLounge(button) {
            button.disabled = true;
            button.textContent = 'Saving...';

            const name = document.getElementById('editLoungeName').value.trim();
            const description = document.getElementById('editLoungeDescription').value.trim();
            // editLoungeCoverUrl holds either the original URL, a new Base64 URL, or null if removed
            const coverImage = editLoungeCoverUrl;

            if (!name) {
                showToast('Lounge name is required.', 'error');
                button.disabled = false;
                button.textContent = 'Save Changes';
                return;
            }
            // Add other validations if needed (lengths are handled by backend now)

            fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}`, { // Use currentLoungeId
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ name: name, description: description, coverImage: coverImage })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.ok) {
                    showToast('Lounge updated successfully!', 'success');
                    // Update local cache if necessary (e.g., allLoungesData)
                    const index = allLoungesData.findIndex(l => l.id === currentLoungeId);
                    if (index > -1) {
                        allLoungesData[index].name = body.lounge.name;
                        allLoungesData[index].description = body.lounge.description;
                        allLoungesData[index].cover_image = body.lounge.cover_image;
                    }
                    // Go back to the updated lounge page
                    showLounge(currentLoungeId, body.lounge.name);
                } else {
                    showToast(body.error || 'Could not update lounge.', 'error');
                }
            })
            .catch(error => {
                console.error("Error updating lounge:", error);
                showToast("An unexpected error occurred.", 'error');
            })
            .finally(() => {
                 // Ensure button is re-enabled only if still on the edit page
                if (document.getElementById('edit-lounge-page').classList.contains('active')) {
                    button.disabled = false;
                    button.textContent = 'Save Changes';
                }
            });
        }

        // Add this new function to show a specific lounge's chat
        function showLounge(loungeId, loungeName) {
            
            fetch(`${API_BASE_URL}/api/lounge/${loungeId}/view`, { method: 'POST', headers: { 'Authorization': `Bearer ${apiToken}` } });
            if (currentLoungeChannelId && socket) {
                socket.emit('leave_lounge_channel', { channel_id: currentLoungeChannelId });
            }
            currentLoungeId = loungeId;
            currentLoungeChannelId = null;

            const chatBody = document.getElementById('lounge-body');
            const chatInput = document.getElementById('lounge-input');
            const joinOverlay = document.getElementById('lounge-join-overlay');
            const loungeSidebar = document.querySelector('.lounge-sidebar');

            const joinButton = document.getElementById('join-lounge-btn');
            if (joinButton) {
                joinButton.disabled = false;
                joinButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Join Lounge';
            }

            chatBody.addEventListener('scroll', closeAllPopups);

            chatBody.style.display = 'none';
            chatInput.style.display = 'none';
            joinOverlay.classList.remove('visible');

            document.getElementById('lounge-header-title').textContent = loungeName;
            document.getElementById('lounge-sidebar-title').textContent = loungeName;
            document.getElementById('lounge-channels-list').innerHTML = '<li>Loading...</li>';

            showPage('lounge-page');
            initializeLoungeEmojiPicker();

            fetch(`${API_BASE_URL}/api/lounge/${loungeId}/channels`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(data => {
                const headerRight = document.querySelector('#lounge-page .header-right');
                headerRight.innerHTML = ''; // Clear any old buttons

                // Step 1: Add the new Invite button, but only for owners and moderators
                if (data.user_role === 'owner' || data.user_role === 'moderator') {
                    const inviteBtn = document.createElement('div');
                    inviteBtn.className = 'profile-menu-button';
                    inviteBtn.innerHTML = '<i class="fas fa-user-plus"></i>'; // Group icon
                    inviteBtn.onclick = showInviteUserModal;
                    headerRight.appendChild(inviteBtn);
                }

                // Step 2: Always add the three-dot menu button
                const menuBtn = document.createElement('div');
                menuBtn.className = 'profile-menu-button';
                menuBtn.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
                menuBtn.onclick = toggleLoungeMenu; // This function already exists
                headerRight.appendChild(menuBtn);

                // Step 3: Always add the (initially hidden) dropdown menu itself
                const menuDropdown = document.createElement('div');
                menuDropdown.id = 'lounge-menu-dropdown';
                menuDropdown.className = 'profile-menu-dropdown hidden';
                headerRight.appendChild(menuDropdown);
                if (data.is_member) {
                    chatBody.style.display = 'flex';
                    chatInput.style.display = 'flex';
                    joinOverlay.classList.remove('visible');
                    loungeSidebar.style.display = 'flex';

                    currentUserLoungeRole = data.user_role;
                    renderLoungeChannels(data.channels);

                    if (data.channels.length > 0) {
                        // ---  THIS IS THE FIX  ---
                        // We now pass the entire first channel object, not just its id and name.
                        loadLoungeChannel(data.channels[0]);
                        // ---  END OF FIX  ---
                    } else {
                        chatBody.innerHTML = '<p style="text-align:center;color:#888;">No channels have been created yet.</p>';
                    }
                } else {
                    chatBody.style.display = 'none';
                    chatInput.style.display = 'none';
                    joinOverlay.classList.add('visible');
                    loungeSidebar.style.display = 'none';

                    const loungeDetails = allLoungesData.find(l => l.id === loungeId);
                    if (loungeDetails) {
                        // --- THIS IS THE FIX ---
                        const joinTitle = document.getElementById('join-lounge-title');
                        const joinDesc = document.getElementById('join-lounge-description');
                        const joinIcon = document.getElementById('join-lounge-privacy-icon');
                        const joinBtn = document.getElementById('join-lounge-btn');

                        if (loungeDetails.privacy === 'private') {
                            // If the lounge is private, show a "Request Access" button.
                            joinTitle.textContent = `"${loungeDetails.name}" is Private`;
                            joinDesc.textContent = 'This lounge is private. You can request access from the owner.';
                            joinIcon.className = 'fas fa-lock privacy-icon';
                            joinBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Request Access'; // <-- THIS IS THE FIX
                            joinBtn.onclick = handleRequestLoungeAccess;
                            joinBtn.style.display = 'block';
                            joinBtn.disabled = false;
                        } else {
                            // Otherwise (public or unlisted), show the normal join screen.
                            joinTitle.textContent = `You found the "${loungeDetails.name}" Lounge!`;
                            joinDesc.textContent = loungeDetails.description || 'Join this Lounge to view channels, see messages, and chat with other members.';
                            joinIcon.className = loungeDetails.privacy === 'unlisted' ? 'fas fa-link privacy-icon' : 'fas fa-globe-americas privacy-icon';
                            joinBtn.style.display = 'block'; // Ensure the join button is visible
                        }
                        // --- END OF FIX ---
                    }
                }
            });
        }

        // Add this new function inside your <script> tag

        function showNewChatModal() {
            const modal = document.getElementById('new-chat-modal');
            const userList = document.getElementById('new-chat-user-list');
            const startBtn = document.getElementById('start-chat-btn');

            modal.classList.remove('hidden');
            startBtn.disabled = true; // Disable button until a user is selected
            userList.innerHTML = '<li>Loading users...</li>';

            fetch(`${API_BASE_URL}/api/users/for-chat`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(users => {
                userList.innerHTML = '';
                if (users.length === 0) {
                    userList.innerHTML = '<li>No other users to message.</li>';
                    return;
                }

                users.forEach(user => {
                    const li = document.createElement('li');
                    // We use a <label> to make the whole row clickable
                    li.innerHTML = `
                        <label class="new-chat-list-item">
                            <input type="radio" name="chat-recipient" value="${user.username}">
                            <div class="profile-pic" data-user-pic-id="${user.username}"></div>
                            <div class="user-info">
                                <span class="username">${user.fullName}</span>
                                <span class="fullname" style="color: #888;">@${user.username}</span>
                            </div>
                        </label>
                    `;
                    userList.appendChild(li);

                    // Store user data locally and update their picture
                    if (!profileData[user.username]) {
                        profileData[user.username] = { name: user.fullName, ...user };
                    }
                    updateProfilePictures(user.username);
                });

                // Add an event listener to enable the button on selection
                userList.addEventListener('change', () => {
                    startBtn.disabled = false;
                });
            });
        }

        function closeNewChatModal() {
            document.getElementById('new-chat-modal').classList.add('hidden');
        }

        function initiateChat() {
            const selectedRadio = document.querySelector('input[name="chat-recipient"]:checked');
            if (!selectedRadio) {
                alert("Please select a user to start a chat with.");
                return;
            }
            const username = selectedRadio.value;

            // If a chat with this user doesn't exist locally, create an empty one.
            if (!messageHistory[username]) {
                messageHistory[username] = [];
            }

            // Open the chat (whether it was new or existing)
            openChat(username);

            // Close the modal
            closeNewChatModal();
        }

    

        function showCreateLoungePage() {
            // --- ADD LIVE CHARACTER COUNTERS ---
            const nameInput = document.getElementById('loungeName');
            const descInput = document.getElementById('loungeDescription');
            const nameCounter = document.getElementById('loungeNameCounter');
            const descCounter = document.getElementById('loungeDescCounter');

            nameInput.oninput = () => nameCounter.textContent = `${nameInput.value.length} / 20`;
            descInput.oninput = () => descCounter.textContent = `${descInput.value.length} / 600`;
            // --- END ADDITION ---

            nameInput.value = '';
            descInput.value = '';
            nameCounter.textContent = '0 / 20'; // Reset counters
            descCounter.textContent = '0 / 600';

            document.getElementById('loungeCoverInput').value = null;
            document.getElementById('privacyPublic').checked = true;

            const preview = document.getElementById('loungeCoverPreview');
            preview.style.backgroundImage = 'none';
            preview.innerHTML = '<span>+ Upload Banner</span>';
            newLoungeCoverUrl = null; // Changed from '' to null for consistency

            preview.onclick = () => document.getElementById('loungeCoverInput').click();
            document.getElementById('loungeCoverInput').onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    preview.style.backgroundImage = `url(${imageUrl})`;
                    preview.innerHTML = '';
                    newLoungeCoverUrl = imageUrl;
                };
                reader.readAsDataURL(file);
            };
            showPage('create-lounge-page');
        }

        function handleLogout() {
             fetch(`${API_BASE_URL}/api/logout`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiToken}`
                }
            }).finally(() => {
                if (socket) {
                    socket.disconnect(); // <-- ADD THIS LINE
                    socket = null;       // <-- AND THIS LINE
                }
                localStorage.removeItem('apiToken');
                // Whether the server call succeeds or fails, clear the client-side session.
                apiToken = null;
                loggedIn = false;
                profileData.me = {}; // Clear user data
                showPage('login-page');
            });
        }

        function handleVerifyCode(verifyButton) {
            const enteredCode = document.getElementById('verificationCodeInput').value.trim();

            if (enteredCode.length !== 6) {
                showToast('Please enter the 6-digit code.', 'error');
                return;
            }

            // ADD DEBUG LOGS HERE
            console.log("[Debug] Entered Code:", enteredCode);
            console.log("[Debug] Expected Code:", generatedVerificationCode);
            console.log("[Debug] Pending Signup Data before fetch:", pendingSignupData);

            if (enteredCode === generatedVerificationCode) {
                // Code is correct, proceed with server-side signup
                console.log("[Debug] Verification code MATCHES. Preparing to call /api/signup..."); // <-- ADD THIS
                verifyButton.disabled = true;
                verifyButton.textContent = 'Verifying...';

                if (!pendingSignupData) {
                    console.error("[Debug] ERROR: pendingSignupData is missing!"); // <-- ADD THIS
                    showToast('Signup data lost. Please go back and try again.', 'error');
                    verifyButton.disabled = false;
                    verifyButton.textContent = 'Verify Code';
                    return;
                }

                // ADD A LOG RIGHT BEFORE FETCH
                console.log("[Debug] Sending fetch request to /api/signup with data:", JSON.stringify(pendingSignupData)); // <-- ADD THIS

                fetch(`${API_BASE_URL}/api/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pendingSignupData), // Use the stored data
                })
                .then(response => { // ADD response logging
                    console.log("[Debug] Received response from /api/signup:", response.status, response.statusText);
                    return response.json().then(data => ({ status: response.status, body: data }));
                })
                .then(({ status, body }) => {
                    console.log("[Debug] Parsed response body:", body); // ADD body logging
                    if (status === 200 && body.ok) {
                        showToast('Verification successful! Account created.', 'success');
                        pendingSignupData = null; // Clear temporary data
                        generatedVerificationCode = null;
                        showPage('login-page'); // Redirect to login
                    } else {
                        showToast(body.error || 'Signup failed after verification.', 'error');
                        // Optionally redirect back to signup page on server error
                        // showPage('signup-page');
                    }
                })
                .catch(error => {
                    console.error('[Debug] Fetch to /api/signup FAILED:', error); // <-- ADD THIS
                    showToast('An error occurred during final signup. Please try again.', 'error');
                })
                .finally(() => {
                    console.log("[Debug] Fetch finally block executed."); // <-- ADD THIS
                    if (document.getElementById('verify-page').classList.contains('active')) {
                        verifyButton.disabled = false;
                        verifyButton.textContent = 'Verify Code';
                    }
                });

            } else {
                // Code is incorrect
                console.log("[Debug] Verification code MISMATCH."); // <-- ADD THIS
                showToast('Incorrect verification code.', 'error');
                document.getElementById('verificationCodeInput').value = ''; // Clear input
            }
        }

        function checkForSavedSession() {
            const savedToken = localStorage.getItem('apiToken');
            if (savedToken) {
                console.log("Found saved token. Verifying session...");
                apiToken = savedToken;

                // Verify the token by fetching the user's profile
                fetch(`${API_BASE_URL}/api/me`, {
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Invalid token');
                    }
                    return response.json();
                })
                .then(userData => {
                    // Token is valid, log the user in
                    loggedIn = true;
                    populateProfileData(userData);
                    fetchConversations();
                    initializeSocket();
                    fetchNotifications();
                    showPage('index-page');
                })
                .catch(error => {
                    // Token is invalid or expired, clear it and show the login page
                    console.error("Session verification failed:", error);
                    localStorage.removeItem('apiToken');
                    apiToken = null;
                    showPage('login-page'); // Show login page if token is bad
                });
            } else {
                // No saved token, show the login page as usual
                showPage('login-page');
            }
        }



        function fetchAndRenderProfiles() {
            fetch(`${API_BASE_URL}/api/users`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(users => {
                users.forEach(user => {
                    profileData[user.username] = {
                        ...(profileData[user.username] || {}),
                        name: user.fullName,
                        username: user.username,
                        rank: user.rank,
                        profilePicUrl: user.profile_pic,
                        account_type: user.account_type,
                        "is_birthday": user.is_birthday //  ADD THIS LINE
                    };
                });
                renderProfiles();
            }).catch(error => console.error("Error fetching user list:", error));
        }

        function showMessagesHome() {
            currentChatRecipient = null; // Clear the active chat recipient
            showPage('messages-page');   // Then show the messages page
        }

        function fetchAndRenderCircuits() {
            fetch(`${API_BASE_URL}/api/circuits`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(circuits => {
                allCircuitsData = circuits; // Store the data globally
                renderExploreCircuits(circuits); // Render the single row on the Explore page
            })
            .catch(error => console.error("Error fetching circuits:", error));
        }

        function fetchMyProfile() {
            if (!apiToken) return;

            fetch(`${API_BASE_URL}/api/me`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiToken}` // Use the token to authenticate
                }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    profileData.me.email = body.email;
                    profileData.me.name = body.fullName; // Use fullName for name
                    profileData.me.username = body.username;
                    profileData.me.school = body.school;
                    profileData.me.dob = body.dob;
                    profileData.me.bio = body.bio;
                    profileData.me.provider = body.provider;
                    profileData.me.rank = body.rank;
                    profileData.me.profilePicUrl = body.profile_pic; //  ADD THIS LINE
                    followingList = body.following || [];
                    fetchConversations();

                    profileData.me.grade = inferGradeFromEmail(body.email);

                    showPage('index-page');
                    updateProfilePictures('me');
                } else {
                    alert('Error fetching profile: ' + (body.error || 'Unknown error.'));
                    handleLogout();
                }
            })
            .catch(err => {
                console.error("Error fetching profile:", err);
                alert("Could not connect to the server to get your profile.");
            });
        }


        function updateProfilePictures(userKey) {
            const user = profileData[userKey];
            if (!user) {
                console.warn(`updateProfilePictures called for unknown userKey: ${userKey}`);
                return;
            }

            const profilePicUrl = user.profilePicUrl || user.profile_pic;
            const rank = user.rank;
            const pictureElements = document.querySelectorAll(`[data-user-pic-id="${userKey}"]`);

            pictureElements.forEach(picElement => {
                if (profilePicUrl) {
                    picElement.style.setProperty('--avatar-image', `url(${profilePicUrl})`);
                } else {
                    // This correctly removes the variable so the CSS fallback to the default avatar works.
                    picElement.style.removeProperty('--avatar-image');
                }

                picElement.classList.remove('rank-admin', 'rank-moderator');
                if (rank === 'admin') {
                    picElement.classList.add('rank-admin');
                } else if (rank === 'moderator') {
                    picElement.classList.add('rank-moderator');
                }

                picElement.classList.toggle('birthday-user', user.is_birthday === true && user.show_birthday === true);

            });
        }

        function showValidationError(inputId, message) {
            const inputElement = document.getElementById(inputId);
            if (!inputElement) return;

            // Remove any old error message first
            hideValidationError(inputId);

            const errorElement = document.createElement('div');
            errorElement.className = 'form-error-message';
            errorElement.id = `error-${inputId}`;
            errorElement.textContent = message;

            // Insert after the input's direct parent if it's a special container, otherwise after the input itself
            const parentContainer = inputElement.closest('.form-field-wrapper, .tos-container');
            if (parentContainer) {
                parentContainer.insertAdjacentElement('afterend', errorElement);
            } else {
                inputElement.insertAdjacentElement('afterend', errorElement);
            }
        }

        /**
         * Hides the validation error message for a specific input field.
         * @param {string} inputId The ID of the input element.
         */
        function hideValidationError(inputId) {
            const errorElement = document.getElementById(`error-${inputId}`);
            if (errorElement) {
                errorElement.remove();
            }
        }

        /**
         * Clears all validation messages within a given form or page.
         * @param {string} containerId The ID of the parent container (e.g., 'signup-page').
         */
        function clearAllValidationErrors(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.querySelectorAll('.form-error-message').forEach(el => el.remove());
            }
        }

        function handleLogin() {
            clearAllValidationErrors('login-page');
            const identifier = document.getElementById('loginIdentifier').value;
            const password = document.getElementById('loginPassword').value;

            if (!identifier || !password) {
                showValidationError('loginPassword', 'Please enter your username/email and password.');
                return;
            }

            fetch(`${API_BASE_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: identifier, password: password }),
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.token && body.user) {
                    localStorage.setItem('apiToken', body.token);
                    apiToken = body.token;
                    loggedIn = true;
                    populateProfileData(body.user);
                    fetchConversations();
                    initializeSocket();
                    fetchNotifications();
                    showPage('index-page');
                } else {
                    const error = body.error || 'Login failed.';
                    showValidationError('loginPassword', error);
                }
            })
            .catch(error => {
                console.error('Login failed:', error);
                alert('The server is down for the moment. Please try again later.');
            });
        }

        function formatPostTimestamp(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            // Example format: Oct 19, 2025, 10:30 PM
            return date.toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: 'numeric', minute: '2-digit', hour12: true
            });
        }

        function formatDateSeparator(dateString) {
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            const messageDate = new Date(dateString);

            if (messageDate.toDateString() === today.toDateString()) {
                return 'Today';
            }
            if (messageDate.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            }
            
            // Fallback for older dates
            return messageDate.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function resendVerificationCode() {
            if (!pendingSignupData || !pendingSignupData.email) {
                showToast('Could not retrieve email to resend code. Please go back.', 'error');
                return;
            }
            // Reuse the sendVerificationCode function
            showToast('Resending verification code...', 'success'); // Give user feedback
            sendVerificationCode(pendingSignupData.email, pendingSignupData.fullName, null); // Pass null for button as we're not on signup page
        }

        function populateProfileData(userData) {
            profileData.me.email = userData.email;
            profileData.me.name = userData.fullName;
            profileData.me.username = userData.username;
            profileData.me.school = userData.school;
            profileData.me.dob = userData.dob;
            profileData.me.bio = userData.bio;
            profileData.me.provider = userData.provider;
            profileData.me.rank = userData.rank;
            profileData.me.profilePicUrl = userData.profile_pic;
            followingList = userData.following || [];

            // Perform grade inference immediately after getting data
            profileData.me.grade = inferGradeFromEmail(userData.email);

            // Update profile pictures in UI elements (like sidebar)
            updateProfilePictures('me');
        }

        function fetchConversations() {
            fetch(`${API_BASE_URL}/api/dm/conversations`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(convos => {
                messageHistory = {}; // Clear old local history
                unreadSenders.clear(); // Clear old unread state

                convos.forEach(convo => {
                    const username = convo.other_user.username;

                    if (!profileData[username]) {
                        profileData[username] = {
                            name: convo.other_user.fullName,
                            ...convo.other_user
                        };
                    }
                    profileData[username].lastMessage = convo.last_message;

                    // --- THIS IS THE NEW LOGIC ---
                    // If the server told us there are unread messages, add to our set
                    if (convo.unread_count > 0) {
                        unreadSenders.add(username);
                    }
                    // --- END NEW LOGIC ---

                    if (!messageHistory[username]) {
                        messageHistory[username] = [];
                    }
                    messageHistory[username].push({
                        sender: 'them',
                        text: convo.last_message,
                        time: new Date(convo.timestamp)
                    });
                });

                updateNotificationBadge(); // Update the badge with the initial count
                renderChatList(); // Render the list, which will now show bolding
            })
            .catch(error => console.error("Could not fetch conversations:", error));
        }

        

        function sendVerificationCode(email, name, signupButton) {
            generatedVerificationCode = Math.floor(100000 + Math.random() * 900000).toString(); // Generate 6-digit code
            console.log("Generated Verification Code:", generatedVerificationCode); // For testing

            // --- THIS IS THE FIX ---
            const templateParams = {
                email: email, // Use 'email' to match your EmailJS template
                to_name: name || 'User',
                verification_code: generatedVerificationCode
            };
            // --- END OF FIX ---

            // Use your NEW Service ID and Template ID for Verification
            const serviceID = 'service_2x7d4jf';
            const templateID = 'template_kxxodjk'; // Corrected ID

            // Show loading state on the signup button while sending
            if (signupButton) {
                signupButton.textContent = 'Sending Code...';
                signupButton.disabled = true;
            }

            emailjs.send(serviceID, templateID, templateParams)
                .then(function(response) {
                    console.log('Verification Email SUCCESS!', response.status, response.text);
                    document.getElementById('verify-email-display').textContent = email; // Show email on verify page
                    showPage('verify-page'); // Go to verification page
                }, function(error) {
                    console.error('FAILED to send verification email...', error);
                    // Display the specific error from EmailJS
                    showToast(`Failed to send verification email. Error: ${error.text || 'Check console.'}`, 'error');
                    // Re-enable the signup button if sending fails
                    if (signupButton) {
                        signupButton.disabled = false;
                        signupButton.textContent = 'Register';
                    }
                });
        }

        function verifyCode() {
            const enteredCode = document.getElementById('verificationCode').value.trim();

            if (!enteredCode) {
                alert('Please enter a code to continue.');
                return;
            }

            // For now, we accept any code and treat it as a success.
            alert('Verification successful! Please log in with your new account.');
            showPage('login-page');
        }

        function renderProfiles() {
            const profileList = document.getElementById('profile-list');
            profileList.innerHTML = '';

            // Filter out 'me', system accounts, and your own username from the list
            const userKeys = Object.keys(profileData).filter(key =>
                key !== 'me' && key !== 'ANNOUNCEMENTS' && key !== profileData.me.username
            );

            // Now, slice the filtered list to get the first 7 users
            userKeys.slice(0, 7).forEach(key => {
                const user = profileData[key];
                if (!user || !user.name) return;

                const profileItem = document.createElement('a');
                profileItem.className = 'profile-item';
                profileItem.onclick = () => showProfile(key);

                let displayName = user.name;
                if (displayName.length > 7) {
                    displayName = displayName.substring(0, 7) + "...";
                }

                profileItem.innerHTML = `
                    <div class="profile-pic" data-user-pic-id="${key}"></div>
                    <p class="profile-name">${displayName} ${getRankIcon(user.rank)}</p>
                `;

                profileList.appendChild(profileItem);
                updateProfilePictures(key);
            });
        }

        function openImageViewer(imageUrl) {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('image-viewer-content');
            
            img.src = imageUrl;
            modal.classList.remove('hidden');

            // Optional: Add Escape key functionality to close the modal
            window.addEventListener('keydown', handleEscKey);
        }

        function closeImageViewer() {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('image-viewer-content');

            modal.classList.add('hidden');
            img.src = ''; // Clear the image source
            window.removeEventListener('keydown', handleEscKey);
        }

        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeImageViewer();
            }
        }

        function showInviteUserModal() {
            const modal = document.getElementById('invite-lounge-member-modal');
            const userList = document.getElementById('invite-user-list');
            const searchInput = document.getElementById('invite-user-search');
            const sendBtn = document.getElementById('send-invite-btn');

            // This function will now fetch users from our new, specialized endpoint
            const fetchAndRenderInvitees = (query = '') => {
                userList.innerHTML = '<li>Searching...</li>';
                
                // The URL now includes the search query 'q'
                const fetchUrl = `${API_BASE_URL}/api/lounge/${currentLoungeId}/potential-invitees?q=${encodeURIComponent(query)}`;

                fetch(fetchUrl, { headers: { 'Authorization': `Bearer ${apiToken}` } })
                .then(response => response.json())
                .then(users => {
                    userList.innerHTML = ''; // Clear "Searching..." message
                    if (users.length === 0) {
                        userList.innerHTML = `<li>No users found matching "${query}".</li>`;
                        return;
                    }

                    users.forEach(user => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <label class="new-chat-list-item">
                                <input type="radio" name="invite-recipient" value="${user.username}">
                                <div class="profile-pic" data-user-pic-id="${user.username}"></div>
                                <div class="user-info">
                                    <span class="username">${user.fullName}</span>
                                    <span class="fullname" style="color: #888;">@${user.username}</span>
                                </div>
                            </label>
                        `;
                        userList.appendChild(li);
                        // We still need to populate profile data locally to render pictures correctly
                        if (!profileData[user.username]) {
                            profileData[user.username] = { name: user.fullName, ...user };
                        }
                        updateProfilePictures(user.username);
                    });
                })
                .catch(error => {
                    console.error("Failed to load potential invitees:", error);
                    userList.innerHTML = '<li>Error loading users.</li>'; // This is the error you were seeing
                });
            };

            // --- Set up the modal ---
            modal.classList.remove('hidden');
            sendBtn.disabled = true;
            searchInput.value = '';
            
            // The search input now triggers a new fetch every time you type
            searchInput.onkeyup = () => fetchAndRenderInvitees(searchInput.value);
            
            // When a user is selected, enable the send button
            userList.onchange = () => sendBtn.disabled = false;
            
            // Perform the initial fetch to populate the list
            fetchAndRenderInvitees();
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('notification-toast-container');
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            // Set a timeout to remove the toast
            setTimeout(() => {
                toast.classList.add('exiting');
                // Wait for the exit animation to finish before removing from the DOM
                setTimeout(() => {
                    toast.remove();
                }, 400); // This duration should match the CSS animation time
            }, 4000); // The toast will be visible for 4 seconds
        }

        function closeInviteUserModal() {
            document.getElementById('invite-lounge-member-modal').classList.add('hidden');
        }

        function handleSendLoungeInvite() {
            const selectedRadio = document.querySelector('input[name="invite-recipient"]:checked');
            if (!selectedRadio) return;

            const username = selectedRadio.value;
            fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}/invite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ username: username })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    showToast(body.message, 'success');
                    closeInviteUserModal();
                } else {
                    showToast(body.error, 'error');
                }
            });
        }

        function respondToInvite(notificationId, action, buttonContainer) {
            fetch(`${API_BASE_URL}/api/notification/${notificationId}/respond`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    // Replace buttons with a confirmation message
                    buttonContainer.innerHTML = `<p style="font-style: italic; color: #555;">Invitation ${action}ed.</p>`;
                } else {
                    alert('Error: ' + (data.error || 'Could not respond to invite.'));
                }
            });
        }

        function getRankIcon(rank) {
            if (rank === 'admin') {
                // Blue checkmark for admins
                return '<i class="fas fa-check-circle rank-icon admin-icon"></i>';
            }
            if (rank === 'moderator') {
                // Black gear for moderators
                return '<i class="fas fa-cog rank-icon mod-icon"></i>';
            }
            return ''; // Return nothing for regular users
        }

        function editProfile() {
            // Populate the form with the current user's data
            document.getElementById('editFullName').value = profileData.me.name;
            document.getElementById('editUsername').value = profileData.me.username;

            const bioTextarea = document.getElementById('editBio');
            const charCounter = document.getElementById('bioCharCounter');

            bioTextarea.value = profileData.me.bio;
            charCounter.textContent = `${bioTextarea.value.length} / 150`;
            bioTextarea.oninput = () => {
                const currentLength = bioTextarea.value.length;
                charCounter.textContent = `${currentLength} / 150`;
            };

            document.getElementById('editShowBirthday').checked = profileData.me.show_birthday;
            document.getElementById('editShowSocialStats').checked = profileData.me.show_social_stats;

            const preview = document.getElementById('editProfilePicPreview');
            // --- THIS IS THE FIX ---
            // Instead of setting the background image directly, we now set the
            // CSS variable that the ::before pseudo-element uses.
            if (profileData.me.profilePicUrl) {
                preview.style.setProperty('--avatar-image', `url(${profileData.me.profilePicUrl})`);
            } else {
                // If there's no picture, remove the variable to let the CSS fallback work.
                preview.style.removeProperty('--avatar-image');
            }

            const fileInput = document.getElementById('profilePicInput');
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    // For the preview, we also set the CSS variable.
                    preview.style.setProperty('--avatar-image', `url(${imageUrl})`);
                    // We store the Base64 URL to be sent to the server on save
                    profileData.me.profilePicUrl = imageUrl;
                };
                reader.readAsDataURL(file);
            };
            // --- END OF FIX ---

            showPage('edit-profile-page');
        }

        // Replace your existing saveProfile function with this one

        // Replace your existing saveProfile function with this one
        function saveProfile() {
            const successMessage = document.getElementById('save-success');
            successMessage.style.opacity = '0'; // Hide it initially
            clearAllValidationErrors('edit-profile-page'); // Clear old errors

            const fullName = document.getElementById('editFullName').value;
            const username = document.getElementById('editUsername').value;
            const bio = document.getElementById('editBio').value;
            const profilePicData = profileData.me.profilePicUrl;
            const showBirthday = document.getElementById('editShowBirthday').checked;
            const showSocialStats = document.getElementById('editShowSocialStats').checked;

            fetch(`${API_BASE_URL}/api/profile`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiToken}`
                },
                body: JSON.stringify({
                    fullName: fullName,
                    username: username,
                    bio: bio,
                    profilePic: profilePicData,
                    showBirthday: showBirthday,
                    showSocialStats: showSocialStats
                })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.ok) {
                    // Show "Saved!" message and fade it out
                    successMessage.style.opacity = '1';
                    setTimeout(() => {
                        successMessage.style.opacity = '0';
                    }, 2000); // Hide after 2 seconds

                    profileData.me.name = body.user.fullName;
                    profileData.me.username = body.user.username;
                    profileData.me.bio = body.user.bio;
                    profileData.me.profilePicUrl = body.user.profile_pic;
                    // Note: We don't need to navigate away, the user can see it's saved.
                } else {
                    const error = body.error || 'Could not save profile.';
                     if (error.includes('Username')) {
                        showValidationError('editUsername', error);
                    } else {
                        showValidationError('editConfirmPassword', error); // Show general error at bottom
                    }
                }
            })
            .catch(err => {
                console.error('Error updating profile:', err);
                alert('An error occurred while saving. Please try again.');
            });
        }

        function blockUser(userIdToBlock) {
            if (!profileData.me.blockedUsers) {
                profileData.me.blockedUsers = [];
            }
            if (profileData.me.blockedUsers.includes(userIdToBlock)) {
                alert('This user is already blocked.');
                return;
            }
            profileData.me.blockedUsers.push(userIdToBlock);
            alert(`${profileData[userIdToBlock].name} has been blocked.`);
            document.getElementById('profile-menu-dropdown').classList.add('hidden');
        }

        function openChat(username) {
            currentChatRecipient = username;
            if (unreadSenders.has(username)) {
                unreadSenders.delete(username);
                updateNotificationBadge();
            }
            renderChatList();
            showPage('messages-page');
        }

        function initializeSocket() {
            // Disconnect any existing socket to prevent duplicate connections
            if (socket) {
                socket.disconnect();
            }

            // Connect to the server, passing the auth token in the query
            socket = io.connect(API_BASE_URL, {
                query: { token: apiToken }
            });

            socket.on('connect', () => {
                console.log('Socket.IO connected successfully!');
            });

            // This is the magic part: Listen for the 'dm_received' event from the server
            socket.on('dm_received', (data) => {
                const senderUsername = data.from;

                if (!messageHistory[senderUsername]) messageHistory[senderUsername] = [];
                messageHistory[senderUsername].push({
                    id: data.id,
                    sender: senderUsername,
                    text: data.message,
                    image: data.image,
                    time: new Date(data.created_at)
                });

                if (profileData[senderUsername]) {
                    profileData[senderUsername].lastMessage = data.message ? data.message : 'Sent an image.';
                }

                const messagesPage = document.getElementById('messages-page');
                const isViewingChat = messagesPage.classList.contains('active') && currentChatRecipient === senderUsername;

                if (!isViewingChat) {
                    unreadSenders.add(senderUsername);
                    updateNotificationBadge();
                }

                renderChatList();

                if (isViewingChat) {
                    renderChatMessages();
                }
            });
            socket.on('new_notification', () => {
                // When the server tells us there's a new notification, refetch our list
                fetchNotifications();
            });
            socket.on('new_lounge_message', (msg) => {
                if (msg.channel_id === currentLoungeChannelId) {
                        currentLoungeMessages.push(msg); // Add new message to our list
                        renderLoungeMessages(currentLoungeMessages); // Re-render the whole list
                    }
            });

            socket.on('message_updated', (data) => {
                // We only care about the conversation we are currently looking at
                if (!messageHistory[currentChatRecipient]) return;

                const msgToUpdate = messageHistory[currentChatRecipient].find(m => m.id === data.message_id);
                if (msgToUpdate) {
                    // --- THIS IS THE FIX ---
                    // The server will send different keys depending on the update type
                    if (data.is_deleted) {
                        msgToUpdate.is_deleted = true;
                        msgToUpdate.text = null;
                        msgToUpdate.image = null;
                        msgToUpdate.reactions = {}; // Clear reactions on delete
                    }
                    if (data.text) {
                        msgToUpdate.text = data.text;
                    }
                    // This is the key change for the new reaction system
                    if (data.reactions !== undefined) {
                        msgToUpdate.reactions = data.reactions;
                    }
                    // --- END OF FIX ---
                    renderChatMessages(true); // Re-render to show changes
                }
            });
            socket.on('lounge_message_updated', (data) => {
                const msgToUpdate = currentLoungeMessages.find(m => m.id === data.message_id);
                if (msgToUpdate) {
                    if (data.reactions !== undefined) {
                        msgToUpdate.reactions = data.reactions;
                    }
                    // Add other update types here in the future if needed (e.g., edit, delete)
                    renderLoungeMessages(currentLoungeMessages, true); // Re-render with scroll preservation
                }
            });
        }

        function renderActiveChat() {
            if (!currentChatRecipient) return;
            const user = profileData[currentChatRecipient];
            if (!user) {
                console.error("No profile data found for recipient:", currentChatRecipient);
                return;
            }

            const header = document.getElementById('active-chat-header');
            const chatBody = document.getElementById('chat-body');

            chatBody.addEventListener('scroll', closeAllPopups);

            header.innerHTML = `
                <a href="#" class="active-chat-link" onclick="showProfile('${currentChatRecipient}')">
                    <div class="profile-pic" data-user-pic-id="${currentChatRecipient}"></div>
                    <p>${user.name}</p>
                </a>
                <div id="chat-menu-container" style="margin-left: auto; position: relative;">
                    <div id="chat-menu-button" class="profile-menu-button" onclick="toggleChatMenu(event)">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div id="chat-menu-dropdown" class="profile-menu-dropdown hidden">
                        <a href="#" class="profile-menu-item" onclick="openThemeSidebar(event)">Customize Chat</a>
                    </div>
                </div>
            `;
            updateProfilePictures(currentChatRecipient);
            chatBody.innerHTML = '<p style="text-align:center; color:#888;">Loading messages...</p>';
            renderChatList();

            // ... rest of the function is the same ...
            fetch(`${API_BASE_URL}/api/dm/history/${currentChatRecipient}`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(data => {
                const chatBody = document.getElementById('chat-body');
                chatBody.innerHTML = ''; // Clear loading message

                if (data.conversation_start) {
                    const startMarker = document.createElement('div');
                    startMarker.className = 'chat-context-separator'; // Re-use the same style
                    const startDate = formatDateSeparator(data.conversation_start.timestamp);
                    startMarker.textContent = `${data.conversation_start.starter_name} started this chat on ${startDate}`;
                    chatBody.appendChild(startMarker);
                }
                messageHistory[currentChatRecipient] = data.messages.map(msg => ({
                    ...msg, time: new Date(msg.time)
                }));

                applyChatTheme(data.theme);
                renderChatMessages();
            })
            .catch(error => {
                console.error("Error fetching chat history:", error);
                chatBody.innerHTML = '<p style="text-align:center; color:red;">Could not load messages.</p>';
            });
        }

        function prepareSignupForm(type) {
            console.log(`[Debug] prepareSignupForm called with type: ${type}`); // <-- ADD THIS LOG

            currentSignupType = type;

            // Get form elements
            const fullNameInput = document.getElementById('signupFullName');
            const usernameInput = document.getElementById('signupUsername');
            const schoolSelect = document.getElementById('signupSchool');
            const emailInput = document.getElementById('signupEmail');
            const passwordInput = document.getElementById('signupPassword');
            const confirmPasswordInput = document.getElementById('signupConfirmPassword');
            const tosCheckbox = document.getElementById('signupTos');
            const dobInput = document.getElementById('signupDOB');
            const subjectInput = document.getElementById('signupSubject');
            const formTitle = document.getElementById('signup-form-title');

            // --- Clear Fields Block (Keep this) ---
            fullNameInput.value = '';
            usernameInput.value = '';
            schoolSelect.value = '';
            emailInput.value = '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            tosCheckbox.checked = false;
            dobInput.value = '';
            subjectInput.value = '';
            clearAllValidationErrors('signup-page');
            // --- End Clearing Block ---

            // Reset dynamic field visibility first
            subjectInput.style.display = 'none';
            dobInput.style.display = 'none';

            // Configure form based on selected type
            if (type === 'student') {
                formTitle.textContent = 'Register as Student';
                fullNameInput.placeholder = 'Full Name';
                dobInput.style.display = 'block';
            } else if (type === 'teacher') {
                formTitle.textContent = 'Register as Teacher';
                fullNameInput.placeholder = 'Full Name';
                dobInput.style.display = 'block';
                subjectInput.style.display = 'block';
            } else if (type === 'team') {
                formTitle.textContent = 'Register Team Account';
                fullNameInput.placeholder = 'Team Name';
            }

            // --- Reset the button state (Keep this) ---
            const signupButton = document.querySelector('#signup-page button[onclick^="handleSignup"]');
            if (signupButton) {
                signupButton.disabled = false;
                signupButton.textContent = 'Register';
            }
            // --- END button reset ---

            console.log("[Debug] prepareSignupForm finished setup. Calling showPage('signup-page')..."); // <-- ADD THIS LOG
            showPage('signup-page');
        }

        function processImage(file, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    reject('Not an image file.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to WebP format for efficiency
                        resolve(canvas.toDataURL('image/webp', 0.85));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        /**
         * Handles when a user selects an image from the file input.
         */
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            processImage(file)
                .then(base64Image => {
                    showImagePreview(base64Image, 'dm'); // Show DM preview
                })
                .catch(err => console.error("Image processing failed:", err));
            event.target.value = null;
        }

        /**
         * Handles when a user pastes content into the chat input.
         */
        function handleImagePaste(event, contextType) {
            const items = event.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const file = items[i].getAsFile();

                    // We found an image. Process it and show it in the preview area.
                    processImage(file)
                        .then(base64Image => {
                            // This now uses your existing preview function for the correct context
                            showImagePreview(base64Image, contextType);
                        })
                        .catch(err => console.error("Pasted image processing failed:", err));

                    event.preventDefault(); // Stop the browser from pasting the raw file object
                    return; // Exit after handling the image
                }
            }
        }

        function updateGeneralNotificationBadge() {
            const badge = document.getElementById('general-notification-badge');
            if (!badge) return;

            if (unreadNotificationCount > 0) {
                badge.style.display = 'block';
                badge.textContent = unreadNotificationCount > 99 ? '99+' : unreadNotificationCount;
            } else {
                badge.style.display = 'none';
            }
        }

        function showMyLoungesPage() {
            const grid = document.getElementById('my-lounges-grid');
            grid.innerHTML = '<p>Loading your lounges...</p>';
            showPage('my-lounges-page');

            fetch(`${API_BASE_URL}/api/me/lounges`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
            .then(response => response.json())
            .then(lounges => {
                grid.innerHTML = ''; // Clear loading message
                if (lounges.length === 0) {
                    grid.innerHTML = '<p>You are not a member of any lounges yet.</p>';
                    return;
                }
                // Reuse the same card style as other lounge/circuit lists
                lounges.forEach(lounge => {
                    let cardClass = 'circuit-card';
                    let cardStyle = '';
                    if (lounge.cover_image) {
                        cardStyle = `style="background-image: url(${lounge.cover_image})"`;
                    } else {
                        cardClass += ' no-image';
                    }
                    const card = document.createElement('div');
                    card.className = cardClass;
                    card.setAttribute('style', cardStyle.replace('style=', '').replace(/"/g, ''));
                    card.onclick = () => showLounge(lounge.id, lounge.name);
                    card.innerHTML = `
                        <h4>${truncate(lounge.name, 10)}</h4>
                        <p>${truncate(lounge.description, 15)}</p>
                    `;
                    grid.appendChild(card);
                });
            });
        }

        function showMyActivityPage() {
            const container = document.getElementById('my-activity-container');
            container.innerHTML = '<p>Loading your recent activity...</p>';
            showPage('my-activity-page');

            // This fetch will now succeed and get all the data
            fetch(`${API_BASE_URL}/api/me/activity`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
            .then(response => response.json())
            .then(data => {
                container.innerHTML = ''; // Clear loading message
                let html = '';
                let activityFound = false;

                // Render Recent Posts
                if (data.posts && data.posts.length > 0) {
                    activityFound = true;
                    html += '<div class="content-section"><h3>My Recent Posts</h3>';
                    data.posts.forEach(p => {
                        html += `<div class="following-list-item" style="align-items: flex-start;">
                                    <i class="fas fa-comment" style="margin-top: 5px; margin-right: 15px; color: #555;"></i>
                                    <div><p style="margin:0;">You posted in <strong>${p.circuit_title}</strong>: "${truncate(p.text, 50)}"</p>
                                    <span class="message-timestamp">${formatTimestamp(new Date(p.timestamp))}</span></div>
                                </div>`;
                    });
                    html += '</div>';
                }
                
                // Render Recent Likes
                if (data.likes && data.likes.length > 0) {
                    activityFound = true;
                    html += '<div class="content-section"><h3>My Recent Likes</h3>';
                    data.likes.forEach(l => {
                        html += `<div class="following-list-item" style="align-items: flex-start;">
                                    <i class="fas fa-heart" style="margin-top: 5px; margin-right: 15px; color: #e74c3c;"></i>
                                    <div><p style="margin:0;">You liked a post by <strong>${l.original_author}</strong> in <strong>${l.circuit_title}</strong></p>
                                    <span class="message-timestamp">${formatTimestamp(new Date(l.timestamp))}</span></div>
                                </div>`;
                    });
                    html += '</div>';
                }

                // --- THIS IS THE MISSING SECTION ---
                // Render Created Circuits
                if (data.circuits && data.circuits.length > 0) {
                    activityFound = true;
                    html += '<div class="content-section"><h3>Circuits I Created</h3>';
                    data.circuits.forEach(c => {
                        html += `<div class="following-list-item" style="align-items: flex-start; cursor:pointer;" onclick="showCircuit(${c.id},'${c.title}','${c.host_school}')">
                                    <i class="fas fa-sitemap" style="margin-top: 5px; margin-right: 15px; color: #27ae60;"></i>
                                    <div><p style="margin:0;">You created the circuit: <strong>${c.title}</strong></p></div>
                                </div>`;
                    });
                    html += '</div>';
                }
                // --- END OF MISSING SECTION ---

                // Render Owned Lounges
                if (data.lounges && data.lounges.length > 0) {
                    activityFound = true;
                    html += '<div class="content-section"><h3>Lounges I Own</h3>';
                    data.lounges.forEach(l => {
                        html += `<div class="following-list-item" style="align-items: flex-start; cursor:pointer;" onclick="showLounge(${l.id}, '${l.name}')">
                                    <i class="fas fa-users" style="margin-top: 5px; margin-right: 15px; color: #3498db;"></i>
                                    <div><p style="margin:0;">You created the lounge: <strong>${l.name}</strong></p>
                                    <span class="message-timestamp">${formatTimestamp(new Date(l.timestamp))}</span></div>
                                </div>`;
                    });
                    html += '</div>';
                }

                container.innerHTML = html;
                if (!activityFound) {
                    container.innerHTML = '<p>No recent activity found.</p>';
                }
            });
        }
        function showProfile(username) {
            const isMe = (username === 'me' || username === profileData.me.username);
            const userKey = isMe ? 'me' : username;
            const user = profileData[userKey];

            if (!user) {
                console.error("Could not find profile data for:", userKey);
                return;
            }

            showPage('profile-page');

            // Find all the elements we need to update
            const bioElement = document.getElementById('userBio');
            const schoolElement = document.getElementById('userSchool');
            const emailElement = document.getElementById('userEmail');
            const gradeElement = document.getElementById('userAge');
            const mainPic = document.querySelector('#profile-page .profile-pic-large');
            const statsBar = document.getElementById('profile-stats-bar');

            // Hide stats bar by default while we load data
            statsBar.style.display = 'none';

            // Set initial content before fetching full details
            mainPic.setAttribute('data-user-pic-id', userKey);
            document.getElementById('profileNameHeader').innerHTML = `${user.username || user.name} ${getRankIcon(user.rank)}`;
            document.getElementById('userName').innerHTML = `${user.name} ${getRankIcon(user.rank)}`;
            document.getElementById('userUsername').textContent = `@${user.username}`;
            updateProfilePictures(userKey);

            bioElement.textContent = 'Loading...';
            schoolElement.textContent = 'School: Loading...';
            emailElement.textContent = 'Email: Loading...';
            gradeElement.textContent = '';

            const endpoint = isMe ? `${API_BASE_URL}/api/me` : `${API_BASE_URL}/api/user/${username}`;
            fetch(endpoint, { headers: { 'Authorization': `Bearer ${apiToken}` } })
            .then(response => response.json())
            .then(fullProfile => {
                // Store full profile data locally
                profileData[userKey] = { ...user, ...fullProfile };
                profileData[userKey].profilePicUrl = fullProfile.profile_pic;
                updateProfilePictures(userKey);

                // Update Name, Bio, School, Email, etc.
                const tagHtml = getAccountTypeTag(fullProfile.account_type);
                document.getElementById('userName').innerHTML = `${fullProfile.fullName} ${getRankIcon(fullProfile.rank)} ${tagHtml}`;

                let bioText = fullProfile.bio || '';
                if (bioText.trim().startsWith('//rainbow ')) {
                    const rainbowContent = bioText.substring(10);
                    bioElement.innerHTML = linkifyUsernames(rainbowContent);
                    bioElement.classList.add('rainbow-text');
                } else {
                    bioElement.innerHTML = linkifyUsernames(bioText);
                    bioElement.classList.remove('rainbow-text');
                }
                bioElement.style.display = bioText.trim() ? 'block' : 'none';

                schoolElement.textContent = `School: ${fullProfile.school || 'Not specified'}`;
                emailElement.textContent = `Email: ${fullProfile.email}`;

                if (fullProfile.account_type === 'student') {
                    gradeElement.textContent = `Grade: ${fullProfile.grade || 'N/A'}`;
                    gradeElement.style.display = 'block';
                } else if (fullProfile.account_type === 'teacher') {
                    gradeElement.textContent = `Subject: ${fullProfile.subject || 'N/A'}`;
                    gradeElement.style.display = 'block';
                } else {
                    gradeElement.style.display = 'none';
                }

                // --- NEW: Birthday Icon Privacy Check ---
                // Check both if it's their birthday AND if they allow it to be shown
                if (fullProfile.is_birthday && fullProfile.show_birthday) {
                    mainPic.classList.add('birthday-user');
                } else {
                    mainPic.classList.remove('birthday-user');
                }

                // --- NEW: Stats Bar Privacy Check ---
                if (fullProfile.show_social_stats) {
                    statsBar.style.display = 'flex'; // Show the bar now that we have data
                    document.getElementById('post-count').textContent = fullProfile.post_count || 0;
                    document.getElementById('follower-count').textContent = fullProfile.follower_count || 0;
                    const followingStat = document.getElementById('following-stat');

                    if (isMe) {
                        // If it's my profile, show my following count and make it clickable
                        document.getElementById('following-count').textContent = followingList.length;
                        followingStat.classList.add('clickable');
                        followingStat.onclick = () => openFollowingModal();
                    } else {
                        // If it's someone else's profile, show a dash and make it unclickable
                        document.getElementById('following-count').textContent = '-';
                        followingStat.classList.remove('clickable');
                        followingStat.onclick = null;
                    }
                } else {
                    // If they've hidden their stats, hide the whole bar
                    statsBar.style.display = 'none';
                }
            })
            .catch(err => console.error("Failed to fetch full profile:", err));

            // Logic for buttons and menus
            const headerRight = document.querySelector('#profile-page .header-right');
            headerRight.innerHTML = ''; // Clear old buttons/menu

            if (isMe) {
                const menuButton = document.createElement('div');
                menuButton.className = 'profile-menu-button';
                menuButton.innerHTML = `<i class="fas fa-ellipsis-v"></i>`;

                const menuDropdown = document.createElement('div');
                menuDropdown.className = 'profile-menu-dropdown hidden';
                menuDropdown.id = 'profile-menu-dropdown';
                menuDropdown.innerHTML = `
                    <a href="#" class="profile-menu-item" onclick="editProfile()">Edit Profile</a>
                    <hr class="context-menu-divider">
                    <a href="#" class="profile-menu-item" onclick="showMyActivityPage()">My Activity</a>
                    <a href="#" class="profile-menu-item" onclick="showMyLoungesPage()">My Lounges</a>
                `;

                headerRight.appendChild(menuButton);
                headerRight.appendChild(menuDropdown);

                menuButton.onclick = (event) => {
                    event.stopPropagation();
                    menuDropdown.classList.toggle('hidden');
                };

            } else {
                const menuButton = document.createElement('div');
                menuButton.className = 'profile-menu-button';
                menuButton.innerHTML = `<i class="fas fa-ellipsis-v"></i>`;
                const menuDropdown = document.createElement('div');
                menuDropdown.className = 'profile-menu-dropdown hidden';
                menuDropdown.id = 'profile-menu-dropdown';
                menuDropdown.innerHTML = `
                    <a href="#" class="profile-menu-item" onclick="showReportPage('user', '${userKey}')">Report User</a>
                    <a href="#" class="profile-menu-item" onclick="blockUser('${userKey}')">Block User</a>`;
                if (profileData.me.rank === 'admin') {
                    menuDropdown.innerHTML += `
                        <hr style="margin: 5px 0; border-color: #eee;">
                        <a href="#" class="profile-menu-item admin-option" onclick="handleRankChange('${userKey}', 'admin')">Make Admin</a>
                        <a href="#" class="profile-menu-item admin-option" onclick="handleRankChange('${userKey}', 'moderator')">Make Moderator</a>
                        <a href="#" class="profile-menu-item admin-option" onclick="handleRankChange('${userKey}', 'user')">Make User</a>`;
                }
                headerRight.appendChild(menuButton);
                headerRight.appendChild(menuDropdown);
                menuButton.onclick = (event) => {
                    event.stopPropagation();
                    menuDropdown.classList.toggle('hidden');
                };
            }

            const card = document.querySelector('#profile-page .profile-card');
            const oldButtons = card.querySelector('.profile-buttons');
            if (oldButtons) oldButtons.remove();
            if (!isMe) {
                const isFollowing = followingList.includes(userKey);
                const buttonText = isFollowing ? 'Following' : 'Follow';
                const buttonClass = isFollowing ? 'follow-btn following' : 'follow-btn';
                const buttonsHTML = `<div class="profile-buttons"><button onclick="openChat('${userKey}')">Message</button><button class="${buttonClass}" onclick="toggleFollow(this, '${userKey}')">${buttonText}</button></div>`;
                card.insertAdjacentHTML('beforeend', buttonsHTML);
            }
        }


        function formatTimestamp(date) {
            // Ensure we're working with a valid Date object
            if (!(date instanceof Date) || isNaN(date)) {
                return '';
            }

            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMinutes < 3) {
                return 'Just now';
            }
            if (diffHours < 1) {
                return `${diffMinutes} minutes ago`;
            }
            if (diffDays < 1) {
                return `${diffHours} hours ago`;
            }
            if (diffDays < 7) {
                return `${diffDays} days ago`;
            }

            // If it's 7 days or more, show the date like "on Sep 12"
            return date.toLocaleDateString([], {
                month: 'short',
                day: 'numeric'
            });
        }

        function handleRankChange(username, newRank) {
            // Hide the menu first
            document.getElementById('profile-menu-dropdown').classList.add('hidden');

            // Confirm the action with the admin
            if (!confirm(`Are you sure you want to change ${username}'s rank to ${newRank}?`)) {
                return;
            }

            fetch(`${API_BASE_URL}/api/user/${username}/rank`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiToken}`
                },
                body: JSON.stringify({ rank: newRank })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.ok) {
                    alert(body.message);
                    // Update the local data to match
                    if (profileData[username]) {
                        profileData[username].rank = newRank;
                    }
                    // Reload the profile to show the new rank and halo instantly
                    showProfile(username);
                } else {
                    alert('Error: ' + (body.error || 'Could not change rank.'));
                }
            })
            .catch(error => {
                console.error("Rank change error:", error);
                alert("An error occurred. Please try again.");
            });
        }

        function initializeLoungeEmojiPicker() {
            const emojiBtn = document.getElementById('lounge-emoji-btn');
            const emojiPanel = document.getElementById('lounge-emoji-panel');
            const messageInput = document.getElementById('lounge-input-field');
            if (!emojiBtn || !emojiPanel || !messageInput) return;

            emojiPanel.innerHTML = '';
            EMOJI_LIST.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.onclick = () => { messageInput.value += emoji; messageInput.focus(); };
                emojiPanel.appendChild(span);
            });

            emojiBtn.onclick = (event) => { event.stopPropagation(); emojiPanel.classList.toggle('hidden'); };
        }

        function showLoungeReactionPicker(event, messageId) {
            event.stopPropagation();
            const pickerId = `picker-lounge-${messageId}`;
            const existingPicker = document.getElementById(pickerId);

            // First, close all other pickers
            document.querySelectorAll('.reaction-picker').forEach(p => {
                if (p.id !== pickerId) p.remove();
            });

            // If the picker for this specific message already exists, remove it and stop.
            if (existingPicker) {
                existingPicker.remove();
                return;
            }

            // Otherwise, create the new picker
            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            picker.id = pickerId; // Give it a unique ID

            ['', '', '', '', '', ''].forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.onclick = () => sendLoungeReaction(messageId, emoji);
                picker.appendChild(span);
            });

            document.body.appendChild(picker);

            // Positioning logic (unchanged)
            const buttonRect = event.target.getBoundingClientRect();
            const pickerRect = picker.getBoundingClientRect();
            const screenEdgeMargin = 10;
            const pickerTop = buttonRect.top + window.scrollY - pickerRect.height - 10;
            let idealPickerLeft = buttonRect.left + window.scrollX + (buttonRect.width / 2) - (pickerRect.width / 2);
            if (idealPickerLeft < screenEdgeMargin) idealPickerLeft = screenEdgeMargin;
            else if (idealPickerLeft + pickerRect.width > window.innerWidth - screenEdgeMargin) {
                idealPickerLeft = window.innerWidth - pickerRect.width - screenEdgeMargin;
            }
            picker.style.top = `${pickerTop}px`;
            picker.style.left = `${idealPickerLeft}px`;
        }

        function sendLoungeReaction(messageId, emoji) {
            socket.emit('react_to_lounge_message', { message_id: messageId, emoji: emoji });
            document.querySelectorAll('.reaction-picker').forEach(p => p.remove());
        }

        function showLoungeReactionTooltip(event, messageId, emoji) {
            // This logic can be shared with DMs, but we point to the lounge API endpoint
            hideReactionTooltip();
            reactionTooltipTimer = setTimeout(() => {
                fetch(`${API_BASE_URL}/api/lounge/message/${messageId}/reaction/${encodeURIComponent(emoji)}`, {
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                })
                .then(response => response.json())
                .then(usernames => {
                    if (usernames.length === 0) return;
                    const tooltip = document.createElement('div');
                    tooltip.id = 'reaction-tooltip';
                    tooltip.textContent = usernames.join(', ');
                    // Positioning logic... (reusing from existing tooltip logic)
                    document.body.appendChild(tooltip);
                    tooltip.style.left = `${event.pageX - tooltip.offsetWidth / 2}px`;
                    tooltip.style.top = `${event.pageY - tooltip.offsetHeight - 5}px`;
                });
            }, 500);
        }

        function toggleFollow(button, username) {
            const isFollowing = followingList.includes(username);
            const endpoint = isFollowing ? 'unfollow' : 'follow';

            // Send the request to the correct server endpoint
            fetch(`${API_BASE_URL}/api/user/${username}/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiToken}`
                }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.ok) {
                    // If the server action was successful, update the button and local data
                    if (isFollowing) {
                        // --- Unfollow successful ---
                        followingList = followingList.filter(u => u !== username);
                        button.textContent = 'Follow';
                        button.classList.remove('following');
                    } else {
                        // --- Follow successful ---
                        followingList.push(username);
                        button.textContent = 'Following';
                        button.classList.add('following');

                        // Trigger the button click animation
                        button.classList.add('following-anim');
                        setTimeout(() => {
                            button.classList.remove('following-anim');
                        }, 500);

                        // Trigger the star burst animation
                        const buttonContainer = button.parentElement;
                        for (let i = 0; i < 15; i++) {
                            const star = document.createElement('span');
                            star.className = 'star';
                            star.textContent = '';

                            star.style.top = `${button.offsetTop + button.offsetHeight / 2}px`;
                            star.style.left = `${button.offsetLeft + button.offsetWidth / 2}px`;

                            const x = (Math.random() - 0.5) * 300;
                            const y = (Math.random() - 0.5) * 300;
                            star.style.setProperty('--x', `${x}px`);
                            star.style.setProperty('--y', `${y}px`);

                            star.style.color = Math.random() > 0.5 ? 'var(--accent)' : '#275EFE';
                            star.style.animationDelay = `${Math.random() * 0.2}s`;

                            buttonContainer.appendChild(star);
                        }

                        // Clean up the star elements after the animation
                        setTimeout(() => {
                            buttonContainer.querySelectorAll('.star').forEach(s => s.remove());
                        }, 1000);
                    }
                } else {
                    alert('Error: ' + (body.error || 'Could not complete action.'));
                }
            })
            .catch(error => {
                console.error("Follow/unfollow error:", error);
                alert("An error occurred. Please try again.");
            });
        }

        let quillEditor = null; // To hold the editor instance

        function initializeQuillEditor() {
            // This still clears the title input for a fresh start.
            document.getElementById('articleTitleInput').value = '';

            // Check if an editor instance already exists for our textarea
            const existingEditor = tinymce.get('tinymce-editor');

            if (existingEditor) {
                // BUG FIX #1: If the editor exists, just clear its content.
                existingEditor.setContent('');
            } else {
                // If it's the first time loading, initialize the editor.
                tinymce.init({
                    selector: '#tinymce-editor',
                    plugins: 'image lists link autolink autoresize',
                    toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | link image',
                    height: 500,
                    menubar: false,
                    autoresize_bottom_margin: 20,
                    object_resizing: 'img',
                    images_file_types: 'jpg,jpeg,png,webp,gif',
                    powerpaste_word_import: 'clean',
                    powerpaste_html_import: 'clean',

                    // BUG FIX #2: This line removes the "p" from the status bar.
                    elementpath: false
                });
            }
        }


        function handleCreateArticle(button) {
            button.disabled = true;
            button.textContent = 'Publishing...';

            const title = document.getElementById('articleTitleInput').value.trim();
            const content = tinymce.activeEditor.getContent();

            if (!title) {
                showToast('Please enter a title for the article.', 'error');
                button.disabled = false;
                button.textContent = 'Publish';
                return;
            }
            if (!content) {
                showToast('Please add some content to the article.', 'error');
                button.disabled = false;
                button.textContent = 'Publish';
                return;
            }

            fetch(`${API_BASE_URL}/api/articles`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiToken}`
                },
                body: JSON.stringify({ title: title, content: content })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 201) {
                    showToast('Article published successfully!', 'success');
                    showPage('explore-page');
                } else {
                    showToast('Error: ' + (body.error || 'Could not create article.'), 'error');
                }
            })
            .catch(error => {
                console.error("Error creating article:", error);
                showToast("An unexpected error occurred.", 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Publish';
            });
        }



        function fetchNotifications(renderList = false) {
            if (!apiToken) return; // Don't fetch if not logged in

            fetch(`${API_BASE_URL}/api/notifications`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(notifications => {
                // Count how many are unread to update the badge
                unreadNotificationCount = notifications.filter(n => !n.is_read).length;
                updateGeneralNotificationBadge();

                // If requested, render the list on the page
                if (renderList) {
                    renderNotifications(notifications);
                }
            })
            .catch(error => console.error("Error fetching notifications:", error));
        }

        /**
         * Takes a list of notification objects and renders them into the HTML list.
         */
        function renderNotifications(notifications) {
            const list = document.getElementById('notifications-list');
            list.innerHTML = '';

            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<li>No new notifications.</li>';
                return;
            }

            notifications.forEach(notif => {
                const item = document.createElement('li');
                item.className = 'notification-item';
                if (!notif.is_read) {
                    item.classList.add('unread');
                }

                if (notif.reference_type === 'post' && notif.reference_details) {
                    item.onclick = () => navigateToPost(notif.reference_details);
                } else if (notif.actor_username) {
                    item.onclick = () => showProfile(notif.actor_username);
                }

                const messageHtml = notif.message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // --- NEW: Add buttons for actionable invites ---
                let actionButtons = '';
                if (notif.actionable) {
                    actionButtons = `
                        <div class="notification-actions" style="margin-top: 10px; display: flex; gap: 10px;">
                            <button class="login-btn" style="padding: 5px 10px;" onclick="event.stopPropagation(); respondToInvite(${notif.id}, 'accept', this.parentElement)">Accept</button>
                            <button class="login-btn" style="background: #888;" onclick="event.stopPropagation(); respondToInvite(${notif.id}, 'decline', this.parentElement)">Decline</button>
                        </div>`;
                } else if (notif.event_type === 'lounge_invite' && notif.status !== 'pending') {
                    actionButtons = `<p style="font-style: italic; color: #555; margin-top: 10px;">Invitation ${notif.status}.</p>`;
                }else if (notif.event_type === 'lounge_access_request' && notif.status !== 'pending') {
                    actionButtons = `<p style="font-style: italic; color: #555; margin-top: 10px;">Request ${notif.status}.</p>`;
                }
                // --- END NEW ---

                item.innerHTML = `
                    <div class="profile-pic" data-user-pic-id="${notif.actor_username}"></div>
                    <div class="notification-text">
                        <p>${messageHtml}</p>
                        <span class="message-timestamp">${formatTimestamp(new Date(notif.timestamp))}</span>
                        ${actionButtons}
                    </div>
                `;
                list.appendChild(item);

                if (notif.actor_username) {
                    updateProfilePictures(notif.actor_username);
                }
            });
        }

        function updateLiveTimestamps() {
            // Find all the timestamp elements we tagged
            const timestampElements = document.querySelectorAll('[data-timestamp]');

            timestampElements.forEach(el => {
                // Get the original, full timestamp from the data-tag
                const originalTime = new Date(el.dataset.timestamp);
                // Recalculate the "time ago" text and update the element
                el.textContent = formatTimestamp(originalTime);
            });
        }

        let currentSignupType = 'student';

        // New function to prepare and show the dynamic signup form

        function showPage(pageId) {
            console.log(`[Debug] showPage called with pageId: ${pageId}`); // Keep this debug log

            const currentPage = document.querySelector('.page.active');
            if (currentPage && currentPage.id !== pageId) {
                previousPageId = currentPage.id; // Keep track of where we came from
            }
            closeAllPopups(); // Close any open menus/pickers

            // --- Page Switching ---
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const newPage = document.getElementById(pageId);
            if (newPage) {
                newPage.classList.add('active');
            } else {
                console.error(`Page with ID '${pageId}' not found.`);
                // Fallback to login page if requested page doesn't exist
                document.getElementById('login-page').classList.add('active');
                pageId = 'login-page'; // Update pageId for subsequent logic
            }


            if (pageId === 'login-page') {
                loggedIn = false; // Update login status if navigating to login
            }

            // --- Reset SIGNUP Page Elements ---
            if (pageId === 'signup-page') {
                // Find button specifically within the signup page
                const signupButton = document.querySelector('#signup-page button[onclick^="handleSignup"]');
                if (signupButton) {
                    signupButton.disabled = false;
                    signupButton.textContent = 'Register';
                }
                 // If you navigate TO the signup page, clear potentially pending data
                 // pendingSignupData = null; // Optional: Decide if you want this behavior
                 // generatedVerificationCode = null;
            }
            // --- END SIGNUP Reset ---

            // --- Reset VERIFY Page Elements ---
            if (pageId === 'verify-page') {
                const verificationInput = document.getElementById('verificationCodeInput');
                // Find button specifically within the verify page
                const verifyButton = document.querySelector('#verify-page button[onclick^="handleVerifyCode"]');

                if (verificationInput) {
                    verificationInput.value = ''; // Clear the input field
                }
                if (verifyButton) {
                    verifyButton.disabled = false; // Enable the button
                    verifyButton.textContent = 'Verify Code'; // Reset button text
                }
                // Also, update the email display based on potentially stored pending data
                const emailDisplay = document.getElementById('verify-email-display');
                if (emailDisplay && pendingSignupData && pendingSignupData.email) {
                    emailDisplay.textContent = pendingSignupData.email;
                } else if (emailDisplay) {
                     emailDisplay.textContent = 'your email'; // Default if no data
                }
            }
            // --- END VERIFY Reset ---

            // --- Layout and UI Control ---
            const sideNav = document.querySelector('.side-nav');
            const footer = document.querySelector('footer');
            const terminalBtn = document.getElementById('terminal-nav-btn');
            const mainHeader = document.getElementById('mainHeaderTitle'); // Assumes this ID exists in index-page header
            const isAuthPage = ['login-page', 'signup-page', 'account-type-selection-page', 'verify-page', 'tos-page'].includes(pageId);

            if (isAuthPage) {
                // Hide sidebar and footer on authentication-related pages
                sideNav.style.display = 'none';
                footer.style.display = 'none';
                document.body.classList.remove('with-sidebar'); // Remove sidebar margin
                if (mainHeader) mainHeader.textContent = 'Log in'; // Reset header text if applicable
            } else {
                // Show sidebar and potentially footer on main app pages
                sideNav.style.display = 'flex';
                document.body.classList.add('with-sidebar'); // Add margin for sidebar

                // Hide footer on pages that use the full height (like chat, terminal, lounge)
                if (['messages-page', 'terminal-page', 'lounge-page'].includes(pageId)) {
                    footer.style.display = 'none';
                } else {
                    footer.style.display = 'block'; // Show footer on other main pages
                }

                // Show terminal button only for admins/mods
                const userRank = profileData.me.rank;
                if (terminalBtn) {
                    terminalBtn.style.display = (userRank === 'admin' || userRank === 'moderator') ? 'flex' : 'none';
                }

                // Update the main header title (e.g., in index-page) with username and rank
                if (mainHeader && profileData.me && (profileData.me.username || profileData.me.name)) {
                    mainHeader.innerHTML = `${profileData.me.username || profileData.me.name} ${getRankIcon(profileData.me.rank)}`;
                }
            }

            // --- Page-Specific Data Loading / Initialization ---
            // (This section triggers data fetching or setup when specific pages are shown)
            if (pageId === 'index-page') {
                fetchAndRenderProfiles();
                fetchAndRenderLounges();
                fetchAndRenderTrending();
            } else if (pageId === 'all-profiles-page') {
                renderAllProfiles();
            } else if (pageId === 'messages-page') {
                renderChatList(); // Always render the list when showing messages page
                updateNotificationBadge(); // Update message badge count
                if (currentChatRecipient) {
                    renderActiveChat(); // Render the active chat if one is selected
                } else {
                    // Reset the active chat pane if no chat is selected
                    document.getElementById('active-chat-header').innerHTML = '';
                    document.getElementById('chat-body').innerHTML = '<div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; color:#8e8e8e;"><i class="fas fa-paper-plane" style="font-size:4em; margin-bottom:15px;"></i><h3 style="margin:0; font-size:1.4em;">Your Messages</h3><p>Select a message to chat.</p></div>';
                    // Ensure theme sidebar is hidden
                    closeThemeSidebar();
                }
            } else if (pageId === 'explore-page') {
                fetchAndRenderMyLounges(); // Load user's lounges
                renderArticles(); // Load articles
                fetchAndRenderCircuits(); // Load circuits
                // Show/hide 'Create Article' button based on rank
                const createArticleBtn = document.getElementById('create-article-btn');
                if (createArticleBtn) { // Check if element exists
                    if (profileData.me.rank === 'admin' || profileData.me.rank === 'moderator') {
                        createArticleBtn.style.display = 'inline-block';
                    } else {
                        createArticleBtn.style.display = 'none';
                    }
                }
            } else if (pageId === 'notifications-page') {
                fetchNotifications(true); // Fetch and render the notifications list
                // Mark all as read when the page is opened
                fetch(`${API_BASE_URL}/api/notifications/mark-all-read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                }).then(() => {
                    unreadNotificationCount = 0; // Reset local counter
                    updateGeneralNotificationBadge(); // Update UI badge
                });
            } else if (pageId === 'all-lounges-page') {
                renderAllLoungesGrid(); // Render the grid of all available lounges
            } else if (pageId === 'all-trending-page') {
                renderAllTrending(); // Render the full list of trending items
            } else if (pageId === 'create-article-page') {
                initializeQuillEditor(); // Set up the rich text editor
            }
            // Add other 'else if' blocks here for other pages that need specific actions on load
        }

        // In html.html, replace BOTH old sendMessage functions with this one

        
        function sendMessage() {
            const inputField = document.getElementById('main-chat-input-field');
            const text = inputField.value.trim();
            const image = dmImagePreviewUrl; // Get the image from our preview state
            
            if (!currentChatRecipient || (!text && !image)) return;
            
            const tempId = `temp_${Date.now()}`;
            
            // Optimistic UI update
            if (!messageHistory[currentChatRecipient]) messageHistory[currentChatRecipient] = [];
            messageHistory[currentChatRecipient].push({ id: tempId, sender: 'me', text: text, image: image, time: new Date() });
            
            inputField.value = ''; // Clear the input field
            renderChatMessages();
            removeImagePreview('dm'); // Clean up the preview UI
            
            profileData[currentChatRecipient].lastMessage = text ? `You: ${text}` : 'You sent an image.';
            renderChatList();

            // Send the complete data to the server
            fetch(`${API_BASE_URL}/api/dm/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ to_username: currentChatRecipient, message: text, image: image })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    const sentMessage = messageHistory[currentChatRecipient].find(m => m.id === tempId);
                    if (sentMessage) sentMessage.id = data.dm_id;
                    renderChatMessages(true);
                } else {
                    alert('Error: ' + (data.error || 'Could not send message.'));
                    messageHistory[currentChatRecipient] = messageHistory[currentChatRecipient].filter(m => m.id !== tempId);
                    renderChatMessages();
                }
            });
        }



        // This is the one and only RENDERCHATLIST function.
        function renderChatList() {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';

            const sortedChats = Object.keys(messageHistory).sort((a, b) => {
                if (!messageHistory[a] || messageHistory[a].length === 0) return 1;
                if (!messageHistory[b] || messageHistory[b].length === 0) return -1;
                const lastMsgA = messageHistory[a][messageHistory[a].length - 1];
                const lastMsgB = messageHistory[b][messageHistory[b].length - 1];
                return lastMsgB.time - lastMsgA.time;
            });

            sortedChats.forEach(key => {
                if (key === 'me' || key === profileData.me.username || key === 'ANNOUNCEMENTS') return;
                const user = profileData[key];
                if (!user) return;
                const li = document.createElement('li');
                li.className = 'chat-list-item';

                if (unreadSenders.has(key)) {
                    li.classList.add('unread');
                }
                if (key === currentChatRecipient) {
                    li.classList.add('active');
                }

                const tagHtml = getAccountTypeTag(user.account_type);
                li.innerHTML = `
                    <div class="profile-pic" data-user-pic-id="${key}"></div>
                    <div class="chat-info">
                        <span class="name">${user.name} ${getRankIcon(user.rank)} ${tagHtml}</span>
                        <p class="snippet">${user.lastMessage || 'Started a chat'}</p>
                    </div>
                `;
                li.onclick = () => openChat(key);
                chatList.appendChild(li);
                updateProfilePictures(key);
            });
        }

        function inferGradeFromEmail(email) {
            if (!email) return null;

            //  THIS IS THE ONLY LINE THAT CHANGED. It now finds the number anywhere.
            const yearMatch = email.match(/\b(20\d{2}|\d{2})\b/);

            if (!yearMatch) return null; // Exit if no year is found in the email

            let gradYearStr = yearMatch[1];
            if (gradYearStr.length === 2) {
                gradYearStr = '20' + gradYearStr; // Convert '29' to '2029'
            }
            const gradYear = parseInt(gradYearStr);

            // --- School Year Logic (this part is already correct) ---
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // January is 0, August is 7

            // The school year turnover is in August.
            const seniorGraduationYear = (currentMonth >= 7) ? currentYear + 1 : currentYear;

            // Calculate the grade
            const grade = 12 - (gradYear - seniorGraduationYear);

            // Return the formatted grade (e.g., "G9")
            return (grade > 0 && grade <= 12) ? `G${grade}` : null;
        }

        function renderAllTrending() {
            const container = document.getElementById('all-trending-container');
            container.innerHTML = '<p>Loading...</p>';

            // Fetch up to 50 trending items using the new limit parameter
            fetch(`${API_BASE_URL}/api/trending?limit=50`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
                .then(response => response.json())
                .then(items => {
                    container.innerHTML = ''; // Clear loading message

                    const articles = items.filter(item => item.type === 'article');
                    const circuits = items.filter(item => item.type === 'circuit');

                    if (articles.length > 0) {
                        const section = document.createElement('div');
                        section.className = 'content-section';
                        section.innerHTML = '<h3>Trending Articles</h3><div id="trending-articles-grid" class="article-grid"></div>';
                        container.appendChild(section);
                        renderArticleCards(articles, 'trending-articles-grid');
                    }

                    if (circuits.length > 0) {
                        const section = document.createElement('div');
                        section.className = 'content-section';
                        section.innerHTML = '<h3>Trending Circuits</h3><div id="trending-circuits-grid" class="circuit-grid"></div>';
                        container.appendChild(section);
                        const grid = section.querySelector('#trending-circuits-grid');
                        circuits.forEach(c => {
                            const card = document.createElement('div');
                            card.className = 'circuit-card';
                            card.onclick = () => showCircuit(c.id, c.title, c.hostSchool);
                            if (c.coverImage) card.style.backgroundImage = `url(${c.coverImage})`;
                            else card.classList.add('no-image');
                            card.innerHTML = `<h4>${c.title}</h4><p>${c.hostSchool}</p>`;
                            grid.appendChild(card);
                        });
                    }
                });
        }

        function renderAllLoungesGrid() {
            fetch(`${API_BASE_URL}/api/lounges`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
            .then(response => response.json())
            .then(lounges => {
                const grid = document.getElementById('all-lounges-grid');
                grid.innerHTML = '';

                const createCard = document.createElement('div');
                createCard.className = 'circuit-card create-circuit-card';
                createCard.onclick = () => showCreateLoungePage();
                createCard.innerHTML = `<h4>+</h4><p>New Lounge</p>`;
                grid.appendChild(createCard);

                lounges.forEach(lounge => {
                    const card = document.createElement('div');
                    card.className = 'circuit-card';
                    card.onclick = () => showLounge(lounge.id, lounge.name);
                    
                    if (lounge.cover_image) {
                        card.style.backgroundImage = `url(${lounge.cover_image})`;
                    } else {
                        card.classList.add('no-image');
                    }
                    
                    let privacyIcon = ''; // (privacy icon logic is unchanged)
                    if (lounge.privacy === 'private') {
                        privacyIcon = '<i class="fas fa-lock" style="position: absolute; top: 10px; right: 10px; color: white; text-shadow: 1px 1px 2px black; font-size: 0.8em;"></i>';
                    } else if (lounge.privacy === 'unlisted') {
                        privacyIcon = '<i class="fas fa-link" style="position: absolute; top: 10px; right: 10px; color: white; text-shadow: 1px 1px 2px black; font-size: 0.8em;"></i>';
                    }
                    
                    // --- THIS PART IS UPDATED ---
                    card.innerHTML = `
                        <h4>${truncate(lounge.name, 10)}</h4>
                        <p>${truncate(lounge.description, 15)}</p>
                        ${privacyIcon}
                    `;
                    // --- END UPDATE ---
                    grid.appendChild(card);
                });
            });
        }

        function showTosPage() {
            fetch('/terms.txt')
                .then(response => response.text())
                .then(text => {
                    document.getElementById('tos-content').innerHTML = text;

                    showPage('tos-page');
                })
                .catch(error => {
                    console.error('Error fetching terms:', error);
                    alert('Could not load the Terms of Service. Please ensure terms.txt is in the same folder as the HTML file.');
                });
        }

        function toggleChatMenu(event) {
            event.stopPropagation();
            document.getElementById('chat-menu-dropdown').classList.toggle('hidden');
        }

        function openThemeSidebar(event) {
            event.stopPropagation(); // <-- ADD THIS LINE to stop the click from closing the menu
            document.getElementById('chat-menu-dropdown').classList.add('hidden');
            document.getElementById('theme-sidebar').classList.remove('hidden');
        }

        function closeThemeSidebar() {
            document.getElementById('theme-sidebar').classList.add('hidden');
        }

        function resetReportUploader() {
            const preview = document.getElementById('reportEvidencePreview');
            const fileInput = document.getElementById('reportEvidenceInput');
            preview.style.backgroundImage = 'none';
            preview.innerHTML = '<span>+ Upload Image</span>';
            fileInput.value = null;
            reportEvidenceImageUrl = null;
        }

        function applyChatTheme(themeName) {
            const chatBody = document.getElementById('chat-body');
            // Remove all possible theme classes first
            chatBody.classList.remove('theme-apex', 'theme-colorless');
            // Add the specific theme class
            chatBody.classList.add(`theme-${themeName || 'apex'}`);
        }

        function setChatTheme(themeName) {
            if (!currentChatRecipient) return;

            fetch(`${API_BASE_URL}/api/dm/conversation/${currentChatRecipient}/theme`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiToken}`
                },
                body: JSON.stringify({ theme: themeName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    applyChatTheme(themeName);
                } else {
                    alert('Could not set theme.');
                }
            });
        }

        function renderChatMessages(preserveScroll = false) {
            const chatBody = document.getElementById('chat-body');
            const currentScrollPosition = chatBody.scrollTop;
            chatBody.innerHTML = '';
            const msgs = messageHistory[currentChatRecipient] || [];
            let lastMessageDate = null; // <-- THIS LINE WAS ALSO MISSING HERE.

            msgs.forEach((msg, index) => {
                // --- DATE SEPARATOR LOGIC (Now works correctly) ---
                const currentMessageDate = new Date(msg.time).toDateString();
                if (currentMessageDate !== lastMessageDate) {
                    const separator = document.createElement('div');
                    separator.className = 'chat-context-separator';
                    separator.textContent = formatDateSeparator(msg.time);
                    chatBody.appendChild(separator);
                    lastMessageDate = currentMessageDate;
                }

                // --- REGULAR DM LOGIC (Will now execute correctly) ---
                const prevMsg = msgs[index - 1];
                const isNewGroup = !prevMsg || (msg.sender !== prevMsg.sender) || ((new Date(msg.time) - new Date(prevMsg.time)) / (1000 * 60) > 3);

                const msgEl = document.createElement('div');
                msgEl.id = `message-${msg.id}`;
                const senderClass = msg.sender === 'me' ? 'sent' : 'received';
                msgEl.className = `chat-message ${senderClass} ${isNewGroup ? 'new-group' : ''}`;

                const messageRow = document.createElement('div');
                messageRow.className = 'message-row';

                const bubbleContainer = document.createElement('div');
                bubbleContainer.className = 'bubble-container';
                bubbleContainer.addEventListener('dblclick', () => sendReaction(msg.id, ''));

                let bubbleContent = '';
                if (msg.is_deleted) {
                    bubbleContent = `<div id="message-content-${msg.id}" class="message-content deleted"><p>Message deleted by user</p></div>`;
                } else if (msg.image) {
                    bubbleContent = `<div id="message-content-${msg.id}" class="message-content"><img src="${msg.image}" alt="User image" onclick="openImageViewer('${msg.image}')"></div>`;
                } else if (msg.text) {
                    bubbleContent = `<div id="message-content-${msg.id}" class="message-content"><p id="message-text-${msg.id}">${linkifyUsernames(msg.text)}</p></div>`;
                }
                bubbleContainer.innerHTML = bubbleContent;
                messageRow.appendChild(bubbleContainer);

                if (!msg.is_deleted) {
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'message-actions';
                    const reactBtn = document.createElement('button');
                    reactBtn.className = 'action-btn';
                    reactBtn.innerHTML = `<i class="fas fa-smile"></i>`;
                    reactBtn.addEventListener('click', (event) => showReactionPicker(event, msg.id));
                    actionsContainer.appendChild(reactBtn);
                    messageRow.appendChild(actionsContainer);
                }

                const metaContainer = document.createElement('div');
                metaContainer.className = 'message-meta';

                // --- THIS IS THE NEW REACTION RENDERING LOGIC ---
                if (msg.reactions && Object.keys(msg.reactions).length > 0 && !msg.is_deleted) {
                    const reactionsContainer = document.createElement('div');
                    reactionsContainer.className = 'reactions-container'; // A wrapper for all reaction bubbles
                    reactionsContainer.style.display = 'flex';
                    reactionsContainer.style.gap = '4px';

                    for (const [emoji, count] of Object.entries(msg.reactions)) {
                        const reactionEl = document.createElement('div');
                        reactionEl.className = 'message-reaction';
                        // Show count only if it's more than 1
                        reactionEl.textContent = `${emoji} ${count > 1 ? count : ''}`.trim();
                        reactionEl.addEventListener('click', () => sendReaction(msg.id, emoji));

                        // Add the hover events for the tooltip
                        reactionEl.addEventListener('mouseover', (event) => showReactionTooltip(event, msg.id, emoji));
                        reactionEl.addEventListener('mouseout', hideReactionTooltip);
                        reactionsContainer.appendChild(reactionEl);
                    }
                    metaContainer.appendChild(reactionsContainer);
                }
                // --- END OF NEW LOGIC ---

                const lastInGroup = !msgs[index + 1] || (msgs[index + 1].sender !== msg.sender) || ((new Date(msgs[index + 1].time) - new Date(msg.time)) / (1000 * 60) > 3);
                if (lastInGroup) {
                    const timestampEl = document.createElement('span');
                    timestampEl.className = 'message-timestamp';
                    timestampEl.dataset.timestamp = new Date(msg.time).toISOString();
                    timestampEl.textContent = formatTimestamp(new Date(msg.time));
                    metaContainer.appendChild(timestampEl);
                }

                msgEl.appendChild(messageRow);
                if (metaContainer.hasChildNodes()) {
                    msgEl.appendChild(metaContainer);
                }
                chatBody.appendChild(msgEl);
            });

            if (preserveScroll) {
                chatBody.scrollTop = currentScrollPosition;
            } else {
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        function handleSignup(button) {
            button.disabled = true;
            button.textContent = 'Processing...';

            // 1. Clear previous errors
            clearAllValidationErrors('signup-page');
            let isValid = true;

            // 2. Gather all form inputs
            const fullName = document.getElementById('signupFullName').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const school = document.getElementById('signupSchool').value;
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const tosCheckbox = document.getElementById('signupTos');
            const dobInput = document.getElementById('signupDOB');
            const subjectInput = document.getElementById('signupSubject');

            // 3. Perform Client-Side Validations
            if (!fullName) {
                showValidationError('signupFullName', 'Full name is required.');
                isValid = false;
            }
            // Updated username validation (lowercase, specific chars, 3-20 length)
            if (!/^[a-z0-9!._*-]{3,20}$/.test(username)) {
                showValidationError('signupUsername', 'Username must be 3-20 lowercase letters, numbers, or !._-*');
                isValid = false;
            }
            if (!school) {
                showValidationError('signupSchool', 'Please select your school.');
                isValid = false;
            }
            // Basic email format check
            if (!email || !/\S+@\S+\.\S+/.test(email)) {
                showValidationError('signupEmail', 'A valid email is required.');
                isValid = false;
            }
            if (password.length < 5) {
                showValidationError('signupPassword', 'Password must be at least 5 characters.');
                isValid = false;
            }
            if (password !== confirmPassword) {
                showValidationError('signupConfirmPassword', 'Passwords do not match.');
                isValid = false;
            }
            if (!tosCheckbox.checked) {
                showValidationError('signupTos', 'You must agree to the Terms of Service.');
                isValid = false;
            }

            // 4. Prepare payload (base info)
            const payload = {
                full_name: fullName,           // CHANGED KEY NAME
                username: username,
                school: school,
                email: email,
                password: password,
                account_type: currentSignupType // CHANGED KEY NAME
            };

            // 5. Add type-specific fields & validations using snake_case
            if (currentSignupType === 'student' || currentSignupType === 'teacher') {
                const dobValue = dobInput.value;
                payload.dob = dobValue; // 'dob' is already snake_case, no change needed
                if (!dobValue) {
                    showValidationError('signupDOB', 'Date of Birth is required.');
                    isValid = false;
                } else {
                    const yearPart = dobValue.split('-')[0];
                    if (yearPart && yearPart.length > 4) {
                        showValidationError('signupDOB', 'Please enter a valid 4-digit year.');
                        isValid = false;
                    }
                }
            }
            if (currentSignupType === 'teacher') {
                payload.subject = subjectInput.value.trim(); // 'subject' is already snake_case
                if (!payload.subject) {
                    showValidationError('signupSubject', 'Primary subject is required.');
                    isValid = false;
                }
            }

            // 6. Stop if validation failed (Keep this part)
            if (!isValid) {
                button.disabled = false;
                button.textContent = 'Register';
                return;
            }

            // 7. Store data and trigger verification email (Keep this part)
            pendingSignupData = payload; // Store the CORRECTLY FORMATTED data
            sendVerificationCode(email, fullName, button); // Call the function to send the code
        }

        function renderArticleCards(articles, containerId) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = ''; // Clear previous content
            
            if (articles.length === 0) {
                grid.innerHTML = '<li>No articles found.</li>';
                return;
            }
            
            articles.forEach(article => {
                const card = document.createElement('div');
                card.className = 'card';
                // This HTML now has the updated "by Author" text and a clickable school tag
                card.innerHTML = `
                <div class="card__img">
                    <span class="card__span" onclick="showAllArticlesPage('${article.schoolTag}')">${article.schoolTag}</span>
                    </div>
                    <div class="card-int">
                        <p class="card-int__title">${article.title}</p>

                        <div class="card-meta">
                            <span class="author">by ${article.author}</span>
                            <span class="views"><i class="fas fa-eye"></i> ${article.daily_views || 0}</span>
                        </div>
                        <button class="card-int__button" onclick="showArticle(${article.id})">Show</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function openFollowingModal() {
            const modal = document.getElementById('following-modal');
            const listContainer = document.getElementById('following-list-container');

            modal.classList.remove('hidden');
            listContainer.innerHTML = '<li>Loading...</li>'; // Show a loading state

            // Fetch the details for the users we are following
            fetch(`${API_BASE_URL}/api/users/details`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiToken}`
                },
                body: JSON.stringify({ usernames: followingList })
            })
            .then(response => response.json())
            .then(users => {
                listContainer.innerHTML = ''; // Clear loading state
                if (users.length === 0) {
                    listContainer.innerHTML = '<li>You are not following anyone.</li>';
                    return;
                }
                users.forEach(user => {
                    // Store their data locally if we don't have it
                    if (!profileData[user.username]) {
                        profileData[user.username] = {
                            name: user.fullName,
                            username: user.username,
                            rank: user.rank,
                            profilePicUrl: user.profile_pic
                        };
                    }

                    const li = document.createElement('li');
                    li.className = 'following-list-item';
                    li.onclick = () => {
                        closeFollowingModal();
                        showProfile(user.username);
                    };
                    li.innerHTML = `
                        <div class="profile-pic" data-user-pic-id="${user.username}"></div>
                        <div class="user-info">
                            <span class="username">${user.username}</span>
                            <span class="fullname">${user.fullName}</span>
                        </div>
                    `;
                    listContainer.appendChild(li);
                    updateProfilePictures(user.username);
                });
            })
            .catch(error => {
                console.error('Error fetching following list details:', error);
                listContainer.innerHTML = '<li>Could not load list.</li>';
            });
        }

        function closeFollowingModal() {
            document.getElementById('following-modal').classList.add('hidden');
        }

        function renderArticles() {
            fetch(`${API_BASE_URL}/api/articles`)
                .then(response => response.json())
                .then(articles => {
                    // This now correctly slices only the first 4 articles
                    renderArticleCards(articles.slice(0, 4), 'article-grid');
                });
        }

        function showAllArticlesPage(filterBySchool = null) {
            const titleElement = document.getElementById('all-articles-title');
            const grid = document.getElementById('all-articles-grid');
            let fetchUrl = `${API_BASE_URL}/api/articles`;

            if (filterBySchool) {
                titleElement.textContent = `Articles from ${filterBySchool}`;
                // Add the school as a query parameter to the URL
                fetchUrl += `?school=${encodeURIComponent(filterBySchool)}`;
            } else {
                titleElement.textContent = 'All Articles';
            }

            grid.innerHTML = '<li>Loading articles...</li>';
            showPage('all-articles-page');

            fetch(fetchUrl)
                .then(response => response.json())
                .then(articles => {
                    renderArticleCards(articles, 'all-articles-grid');
                });
        }

        function showArticle(articleId) {
            fetch(`${API_BASE_URL}/api/article/${articleId}/view`, { method: 'POST', headers: { 'Authorization': `Bearer ${apiToken}` } });
            fetch(`${API_BASE_URL}/api/article/${articleId}`)
                .then(response => response.json())
                .then(article => {
                    if (article.error) {
                         alert(article.error);
                         return;
                    }
                    document.getElementById('article-title').textContent = article.title;
                    document.getElementById('article-meta').textContent = `By ${article.author} | ${article.schoolTag}`;
                    document.getElementById('article-content').innerHTML = article.content; // Render the HTML
                    showPage('article-page');
                });
        }

        function showCreateCircuitPage() {
            // Clear the form fields
            document.getElementById('circuitTitle').value = '';
            document.getElementById('circuitHost').value = '';
            document.getElementById('circuitCoverInput').value = null; // Clear file input

            const preview = document.getElementById('circuitCoverPreview');
            preview.style.backgroundImage = 'none';
            preview.innerHTML = '<span>+ Upload Image</span>';

            // Reset the temporary URL
            newCircuitCoverUrl = '';

            // Add click listener to the preview to trigger the file input
            preview.onclick = () => document.getElementById('circuitCoverInput').click();

            // Add change listener to the file input to handle the upload
            document.getElementById('circuitCoverInput').onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    // Show the preview and store the URL
                    preview.style.backgroundImage = `url(${imageUrl})`;
                    preview.innerHTML = ''; // Remove the "+ Upload" text
                    newCircuitCoverUrl = imageUrl;
                };
                reader.readAsDataURL(file);
            };

            showPage('create-circuit-page');
        }

        function handleCreateCircuit(button) {
            button.disabled = true;
            button.textContent = 'Creating...';

            const title = document.getElementById('circuitTitle').value.trim();
            const host = document.getElementById('circuitHost').value.trim();
            const coverImage = newCircuitCoverUrl;

            if (!title || !host) {
                showToast('Please fill in the title and its association.', 'error');
                button.disabled = false;
                button.textContent = 'Create';
                return;
            }

            fetch(`${API_BASE_URL}/api/circuits`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ title: title, hostSchool: host, coverImage: coverImage })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 201) {
                    showToast(`Circuit "${body.circuit.title}" created successfully!`, 'success');
                    showPage('explore-page');
                } else {
                    showToast(body.error || 'Could not create circuit.', 'error');
                }
            })
            .catch(error => {
                console.error("Error creating circuit:", error);
                showToast("An error occurred. Please try again.", 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Create';
            });
        }


        // In index.html, replace the old function with this one.

        function submitReport() {
            const users = document.getElementById('reportUsers').value.trim();
            const issueType = document.getElementById('reportIssueType').value;
            const description = document.getElementById('reportDescription').value.trim();
            const confirmation = document.getElementById('reportConfirm').checked;
            const submitBtn = document.querySelector('#report-page .report-submit-btn');

            // Validation
            if (!users || !description) {
                showToast('Please fill out the "User(s) to Report" and "Description" fields.', 'error');
                return;
            }
            if (!issueType) {
                showToast('Please select a category for the issue.', 'error');
                return;
            }
            if (!confirmation) {
                showToast('Please confirm that your report is made in good faith.', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const templateParams = {
                report_users: users,
                issue_type: issueType,
                description: description,
                evidence_image_url: reportEvidenceImageUrl || 'No image attached.'
            };

            // This uses your exact Service ID ('service_ta6m2y7') and Template ID ('template_report_issue')
            emailjs.send('service_ta6m2y7', 'template_report_issue', templateParams)
                .then(function(response) {
                    console.log('SUCCESS!', response.status, response.text);
                    showToast('Report submitted successfully. Our team will review it shortly.', 'success');
                    
                    // Clear the form after success
                    document.getElementById('reportUsers').value = '';
                    document.getElementById('reportIssueType').value = '';
                    document.getElementById('reportDescription').value = '';
                    document.getElementById('reportConfirm').checked = false;
                    resetReportUploader();
                    showPage('index-page');

                }, function(error) {
                    //  THIS IS THE IMPORTANT CHANGE 
                    // This will show a more specific error message from EmailJS
                    console.error('FAILED to send report. Full EmailJS error:', error);
                    showToast(`Failed to send report. Reason: ${error.text || 'Unknown error. Check console.'}`, 'error');
                    //  END OF CHANGE 
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Report';
                });
        }

        function renderExploreCircuits(circuits) {
            const row = document.getElementById('explore-circuit-list');
            row.innerHTML = ''; // Clear previous content

            // --- THIS IS THE FIX ---
            // Create and add the "+ New Circuit" button first.
            const createCard = document.createElement('div');
            createCard.className = 'circuit-card create-circuit-card';
            createCard.onclick = () => showCreateCircuitPage(); // This correctly opens the create page
            createCard.innerHTML = `<h4>+</h4><p>New Circuit</p>`;
            row.appendChild(createCard);
            // --- END OF FIX ---

            // Now, render the actual circuits from the server after the button.
            circuits.slice(0, 7).forEach(circuit => {
                const card = document.createElement('div');
                card.className = 'circuit-card';
                card.onclick = () => showCircuit(circuit.id, circuit.title, circuit.hostSchool);
                if (circuit.coverImage) {
                    card.style.backgroundImage = `url(${circuit.coverImage})`;
                } else {
                    card.classList.add('no-image');
                }
                card.innerHTML = `
                    <h4>${truncate(circuit.title, 10)}</h4>
                    <p>${truncate(circuit.hostSchool, 10)}</p>
                    <div class="circuit-views"><i class="fas fa-eye"></i> ${circuit.daily_views || 0}</div>
                `;
                row.appendChild(card);
            });
        }

        function handleDeleteCircuit(circuitId) {
            const menu = document.getElementById('circuit-menu-dropdown');
            if (menu) menu.classList.add('hidden');

            showConfirmationModal({
                title: 'Delete Circuit?',
                text: 'Are you sure you want to permanently delete this circuit and all of its posts? This action cannot be undone.',
                onConfirm: () => {
                    fetch(`${API_BASE_URL}/api/circuit/${circuitId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${apiToken}` }
                    })
                    .then(response => response.json().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200 && body.ok) {
                            showToast('Circuit deleted successfully.', 'success');
                            showPage('explore-page');
                        } else {
                            showToast(body.error || 'Could not delete the circuit.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error("Error deleting circuit:", error);
                        showToast("An error occurred. Please try again.", 'error');
                    });
                }
            });
        }
        function showCircuit(circuitId, title, hostSchool) {
            fetch(`${API_BASE_URL}/api/circuit/${circuitId}/view`, { method: 'POST', headers: { 'Authorization': `Bearer ${apiToken}` } });
            currentCircuitId = circuitId;
            showPage('circuit-page');

            const headerRight = document.querySelector('#circuit-page .header-right');
            headerRight.innerHTML = `
                <button id="add-post-btn" class="login-btn" onclick="showCreatePostPage({ type: 'circuit', id: currentCircuitId })">+ Add Post</button>
                <div class="profile-menu-button" onclick="toggleCircuitMenu(event)">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
                <div id="circuit-menu-dropdown" class="profile-menu-dropdown hidden"></div>
            `;

            document.getElementById('circuit-title-header').textContent = title;
            document.getElementById('circuit-title').textContent = title;
            document.getElementById('circuit-meta').textContent = `Hosted by ${hostSchool}`;
            const postsGrid = document.getElementById('circuit-posts-grid');
            postsGrid.innerHTML = '<p>Loading posts...</p>';

            fetch(`${API_BASE_URL}/api/circuit/${circuitId}`, { headers: { 'Authorization': `Bearer ${apiToken}` }})
            .then(response => response.json())
            .then(circuitDetails => {
                currentCircuitDetails = circuitDetails;
                const menu = document.getElementById('circuit-menu-dropdown');

                let menuHTML = `<a href="#" class="profile-menu-item" onclick="openCircuitDetailsModal()">Description</a>`;
                menuHTML += `<a href="#" class="profile-menu-item" onclick="showReportPage('circuit', '${circuitDetails.code}')">Report Circuit</a>`;

                if (circuitDetails.owner_username === profileData.me.username || profileData.me.rank === 'admin') {
                    menuHTML += `<a href="#" class="profile-menu-item" onclick="showEditCircuitPage(${circuitId})">Edit Circuit</a>`;
                    menuHTML += `<a href="#" class="profile-menu-item admin-option" onclick="handleDeleteCircuit(${circuitId})">Delete Circuit</a>`;
                }

                menu.innerHTML = menuHTML;
            });

            return fetch(`${API_BASE_URL}/api/circuit/${circuitId}/posts`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(posts => {
                currentCircuitPosts = posts;
                postsGrid.innerHTML = '';
                posts.forEach((post, index) => {
                    const postEl = document.createElement('div');
                    postEl.className = 'circuit-post';
                    postEl.onclick = (event) => {
                        console.log(`[Debug] Click detected on post element for index ${index}.`); // <-- ADD THIS
                        if (event.target.closest('.like-button-container')) return;
                        showPostModal(index);
                    };
                    const likedClass = post.is_liked_by_me ? 'liked' : '';

                    // This combines the image, text, likes, and author into one block, fixing the error.
                    const imageHTML = post.image ? `<img src="${post.image}" alt="Post image">` : '';
                    const linkedText = linkifyUsernames(post.text); // Apply the function here
                    postEl.innerHTML = `
                        ${imageHTML}
                        <p class="circuit-post-text">${linkedText}</p>
                        <div class="like-button-container" data-like-container-id="${post.id}">
                            <button class="like-button ${likedClass}" onclick="toggleLike(event, ${post.id})">
                                <i class="fas fa-heart"></i>
                            </button>
                            <span class="like-count">${post.likes}</span>
                        </div>
                        <div class="circuit-post-author">
                            <span>- ${post.author.fullName}</span>
                            <div class="profile-pic" data-user-pic-id="${post.author.username}"></div>
                        </div>
                    `;

                    postsGrid.appendChild(postEl);
                    if (post.author) {
                        updateProfilePictures(post.author.username);
                    }
                });
            })
            .catch(error => console.error("Error fetching posts:", error));
        }


        function viewProfileFromLounge(username) {
            // First, close all open menus and modals
            document.querySelectorAll('.context-menu').forEach(menu => menu.remove());
            closeLoungeMembersModal();
            // Then, show the profile page
            showProfile(username);
        }


        function editLoungeChannel(channelId) {
            const newName = prompt("Enter the new channel name:");
            if (!newName || !newName.trim()) return;

            fetch(`${API_BASE_URL}/api/lounge/channel/${channelId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ name: newName.trim() })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    // Refresh the channels list to show the new name
                    showLounge(currentLoungeId, document.getElementById('lounge-header-title').textContent);
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }

        function handleRequestLoungeAccess() {
            const loungeId = currentLoungeId;
            if (!loungeId) return;

            const requestBtn = document.getElementById('join-lounge-btn');
            requestBtn.disabled = true;
            requestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...'; // <-- IMPROVEMENT

            fetch(`${API_BASE_URL}/api/lounge/${loungeId}/request-access`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    showToast(body.message, 'success');
                    requestBtn.innerHTML = '<i class="fas fa-check"></i> Request Sent'; // <-- IMPROVEMENT
                } else {
                    showToast(body.error || 'Could not send request.', 'error');
                    requestBtn.disabled = false;
                    requestBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Request Access'; // <-- IMPROVEMENT
                }
            });
        }

        function openLoungeMemberMenu(event, username, currentRole) {
            event.preventDefault(); 
            event.stopPropagation();
            document.querySelectorAll('.context-menu').forEach(menu => menu.remove());

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            
            // --- THIS IS THE FIX ---
            // We now call a new function that handles closing the other modals
            // before showing the profile.
            let menuItems = `<a class="context-menu-item" onclick="viewProfileFromLounge('${username}')">View Profile</a>`;
            // --- END OF FIX ---

            const canManage = (currentUserLoungeRole === 'owner') || (currentUserLoungeRole === 'moderator' && currentRole === 'member');
            
            if (canManage && currentRole !== 'owner') {
                menuItems += '<hr style="margin: 5px 0; border-color: #eee;">';
                if (currentRole === 'member') {
                    menuItems += `<a class="context-menu-item" onclick="setLoungeRole('${username}', 'moderator')">Promote to Moderator</a>`;
                } else if (currentRole === 'moderator') {
                    menuItems += `<a class="context-menu-item" onclick="setLoungeRole('${username}', 'member')">Demote to Member</a>`;
                }
            }
            
            menu.innerHTML = menuItems;
            document.body.appendChild(menu);

            menu.style.left = `${event.pageX}px`;
            menu.style.top = `${event.pageY}px`;
        }

        function setLoungeRole(username, newRole) {
            document.querySelectorAll('.context-menu').forEach(menu => menu.remove());

            fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}/member/${username}/role`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ role: newRole })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showToast(data.message, 'success');
                    showLoungeMembers();
                } else {
                    showToast(data.error, 'error');
                }
            });
        }

        function deleteLoungeChannel(channelId) {
            // Instead of a browser confirm(), we call our custom modal
            showConfirmationModal({
                title: 'Delete Channel?',
                text: 'Are you sure you want to permanently delete this channel and all its messages?',
                onConfirm: () => {
                    // The fetch request is now inside the onConfirm callback
                    fetch(`${API_BASE_URL}/api/lounge/channel/${channelId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${apiToken}` }
                    })
                    .then(response => response.json().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200 && body.ok) {
                            showToast(body.message, 'success');
                            // Refresh the lounge view to show the updated channel list
                            showLounge(currentLoungeId, document.getElementById('lounge-header-title').textContent);
                        } else {
                            // Use the toast for errors instead of an alert
                            showToast(body.error || 'Could not delete channel.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error("Error deleting channel:", error);
                        showToast("An unexpected error occurred.", 'error');
                    });
                }
            });
        }

        function getAccountTypeTag(accountType) {
            if (accountType === 'teacher') {
                return '<span class="account-type-tag tag-teacher">Teacher</span>';
            } else if (accountType === 'team') {
                return '<span class="account-type-tag tag-team">Team</span>';
            }
            return ''; // No tag for students or default accounts
        }

        function fetchAndRenderLoungeMessages(loungeId) {
            const chatBody = document.getElementById('lounge-body');
            chatBody.innerHTML = '<p style="text-align:center; color:#888;">Loading history...</p>';

            fetch(`${API_BASE_URL}/api/lounge/${loungeId}/messages`, { // <-- Use the new URL
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(messages => {
                chatBody.innerHTML = '';
                messages.forEach(msg => renderLoungeMessage(msg));
                chatBody.scrollTop = chatBody.scrollHeight;
            });
        }

        function toggleLoungeMenu(event) {
            event.stopPropagation(); // Prevent click from closing menu immediately
            const menu = document.getElementById('lounge-menu-dropdown');
            menu.innerHTML = ''; // Clear the menu before building it

            // Add items that are always visible
            menu.innerHTML += `<a href="#" class="profile-menu-item" onclick="showLoungeMembers()">Show Members</a>`;
            menu.innerHTML += `<a href="#" class="profile-menu-item" onclick="showLoungeDetails()">Show Details</a>`;

            // Conditionally add the "Leave Lounge" option for members and moderators
            if (currentUserLoungeRole === 'member' || currentUserLoungeRole === 'moderator') {
                menu.innerHTML += `<hr class="context-menu-divider">`; // Use hr for visual separation
                menu.innerHTML += `<a href="#" class="profile-menu-item danger" onclick="handleLeaveLounge()">Leave Lounge</a>`;
            }

            // Conditionally add Owner options
            if (currentUserLoungeRole === 'owner') {
                // ---  THIS IS THE ADDED LINE  ---
                menu.innerHTML += `<a href="#" class="profile-menu-item" onclick="showEditLoungePage(${currentLoungeId})">Edit Lounge</a>`;
                // ---  END ADDITION  ---

                // Add separator if leave option wasn't already added (though owner can't leave)
                if (currentUserLoungeRole !== 'member' && currentUserLoungeRole !== 'moderator') {
                     menu.innerHTML += `<hr class="context-menu-divider">`;
                }
                menu.innerHTML += `<a href="#" class="profile-menu-item danger" onclick="handleDeleteLounge()">Delete Lounge</a>`;
            }

            // Toggle visibility after building
            menu.classList.toggle('hidden');
        }

        function renderLoungeMessages(messages, preserveScroll = false) {
            const chatBody = document.getElementById('lounge-body');
            const currentScrollPosition = chatBody.scrollTop;
            chatBody.innerHTML = '';
            let lastMessageDate = null; // <-- THIS LINE WAS MISSING. THIS IS THE FIX.

            messages.forEach((msg, index) => {
                // --- DATE SEPARATOR LOGIC (Now works correctly) ---
                const currentMessageDate = new Date(msg.timestamp).toDateString();
                if (currentMessageDate !== lastMessageDate) {
                    const separator = document.createElement('div');
                    separator.className = 'chat-context-separator';
                    separator.textContent = formatDateSeparator(msg.timestamp);
                    chatBody.appendChild(separator);
                    lastMessageDate = currentMessageDate;
                }

                // --- SYSTEM MESSAGE LOGIC (Will now execute correctly) ---
                if (msg.message_type === 'system_event') {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'system-message';
                    eventEl.textContent = msg.text;
                    chatBody.appendChild(eventEl);
                    return; // Skip the rest for system messages
                }

                // --- REGULAR MESSAGE LOGIC (Will now execute correctly) ---
                const prevMsg = messages[index - 1];
                const isNewGroup = !prevMsg || msg.author.username !== prevMsg.author.username || ((new Date(msg.timestamp) - new Date(prevMsg.timestamp)) / (1000 * 60) > 3);
                const isSentByMe = msg.author.username === profileData.me.username;
                const senderClass = isSentByMe ? 'sent' : 'received';

                const msgEl = document.createElement('div');

                msgEl.className = `chat-message ${senderClass} ${isNewGroup ? 'new-group' : ''}`;

                const messageRow = document.createElement('div');
                messageRow.className = 'message-row';

                // Add spacer/profile pic
                if (isNewGroup && !isSentByMe) {
                    const pic = document.createElement('div');
                    pic.className = 'profile-pic';
                    pic.style.cursor = 'pointer';
                    pic.setAttribute('data-user-pic-id', msg.author.username);
                    pic.setAttribute('onclick', `showProfile('${msg.author.username}')`);
                    messageRow.appendChild(pic);
                    updateProfilePictures(msg.author.username);
                } else if (!isSentByMe) {
                    const spacer = document.createElement('div');
                    spacer.className = 'profile-pic-spacer';
                    messageRow.appendChild(spacer);
                }

                const bubbleContainer = document.createElement('div');
                bubbleContainer.className = 'bubble-container';
                
                let messageContent = '';
                if (msg.image) messageContent += `<img src="${msg.image}" alt="Lounge image" onclick="openImageViewer('${msg.image}')">`;
                if (msg.text) messageContent += `<p>${linkifyUsernames(msg.text)}</p>`;
                
                let authorHtml = '';
                if (isNewGroup && !isSentByMe) {
                    authorHtml = `<span class="message-author">${msg.author.fullName || msg.author.username} ${getRankIcon(msg.author.rank)}</span>`;
                }
                bubbleContainer.innerHTML = authorHtml + messageContent;

                const textContentWrapper = document.createElement('div');
                textContentWrapper.className = 'text-content-wrapper';
                textContentWrapper.appendChild(bubbleContainer);
                messageRow.appendChild(textContentWrapper);
                
                // --- NEW: Message Actions (React button) ---
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'message-actions';
                const reactBtn = document.createElement('button');
                reactBtn.className = 'action-btn';
                reactBtn.innerHTML = `<i class="fas fa-smile"></i>`;
                reactBtn.onclick = (event) => showLoungeReactionPicker(event, msg.id);
                actionsContainer.appendChild(reactBtn);
                messageRow.appendChild(actionsContainer);
                // --- END NEW ---
                
                msgEl.appendChild(messageRow);

                const metaContainer = document.createElement('div');
                metaContainer.className = 'message-meta';

                // --- NEW: Reaction Rendering ---
                if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                    const reactionsDiv = document.createElement('div');
                    reactionsDiv.style.display = 'flex';
                    reactionsDiv.style.gap = '4px';
                    for (const [emoji, count] of Object.entries(msg.reactions)) {
                        const reactionEl = document.createElement('div');
                        reactionEl.className = 'message-reaction';
                        reactionEl.textContent = `${emoji} ${count > 1 ? count : ''}`.trim();
                        reactionEl.onclick = () => sendLoungeReaction(msg.id, emoji);
                        reactionEl.onmouseover = (event) => showLoungeReactionTooltip(event, msg.id, emoji);
                        reactionEl.onmouseout = hideReactionTooltip;
                        reactionsDiv.appendChild(reactionEl);
                    }
                    metaContainer.appendChild(reactionsDiv);
                }
                // --- END NEW ---

                const isLastInGroup = !messages[index + 1] || msg.author.username !== messages[index + 1].author.username || ((new Date(messages[index + 1].timestamp) - new Date(msg.timestamp)) / (1000 * 60) > 3);
                if (isLastInGroup) {
                    const timestampEl = document.createElement('span');
                    timestampEl.className = 'message-timestamp';
                    timestampEl.dataset.timestamp = new Date(msg.timestamp).toISOString();
                    timestampEl.textContent = formatTimestamp(new Date(msg.timestamp));
                    metaContainer.appendChild(timestampEl);
                }

                if (metaContainer.hasChildNodes()) {
                    msgEl.appendChild(metaContainer);
                }
                chatBody.appendChild(msgEl);
            });
            
            if (preserveScroll) chatBody.scrollTop = currentScrollPosition;
            else chatBody.scrollTop = chatBody.scrollHeight;
        }



        // 3. Update your showPage function




        function navigateToPost(details) {
            const { circuit_id, circuit_title, circuit_host, post_id } = details;

            // First, navigate to the correct circuit and wait for it to load posts
            showCircuit(circuit_id, circuit_title, circuit_host).then(() => {
                // Once the posts are loaded, find the index of the specific post
                const postIndex = currentCircuitPosts.findIndex(p => p.id === post_id);

                if (postIndex !== -1) {
                    // If the post is found, open the magnified view for it
                    showPostModal(postIndex);
                } else {
                    console.error("Post not found in circuit after loading.");
                    alert("Could not find the specific post. It may have been deleted.");
                }
            });
        }

        function toggleCircuitMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('circuit-menu-dropdown');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function showReportPage(reportType, reportId) {
            const usersField = document.getElementById('reportUsers');
            const descriptionField = document.getElementById('reportDescription');

            // Clear fields first for a clean slate
            usersField.value = '';
            descriptionField.value = '';

            // This logic now correctly handles generic reports
            if (reportType === 'circuit' && reportId) {
                usersField.value = 'n/a';
                descriptionField.value = `Regarding circuit code: ${reportId}\n\n[Please describe the issue here]`;
            } else if (reportType === 'user' && reportId) {
                usersField.value = reportId;
            }

            // --- Set up the image uploader ---
            resetReportUploader(); 
            const preview = document.getElementById('reportEvidencePreview');
            const fileInput = document.getElementById('reportEvidenceInput');

            preview.onclick = () => fileInput.click();
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                processImage(file, 1024)
                    .then(imageUrl => {
                        preview.style.backgroundImage = `url(${imageUrl})`;
                        preview.innerHTML = `<span class="remove-preview-btn" onclick="event.stopPropagation(); resetReportUploader();">&times;</span>`;
                        reportEvidenceImageUrl = imageUrl;
                    })
                    .catch(err => {
                        showToast('Could not process image.', 'error');
                        console.error(err);
                    });
            };

            showPage('report-page');
        }

        function handleDeleteLounge() {
            document.getElementById('lounge-menu-dropdown').classList.add('hidden');

            showConfirmationModal({
                title: 'Delete Lounge?',
                text: 'Are you sure you want to permanently delete this lounge and all of its channels and messages? This action cannot be undone.',
                onConfirm: () => {
                    fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${apiToken}` }
                    })
                    .then(response => response.json().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200) {
                            showToast(body.message, 'success');
                            showPage('index-page');
                        } else {
                            showToast(body.error || 'Could not delete the lounge.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting lounge:', error);
                        showToast('An unexpected error occurred.', 'error');
                    });
                }
            });
        }

        function showEditCircuitPage(circuitId) {
            fetch(`${API_BASE_URL}/api/circuit/${circuitId}`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(circuit => {
                document.getElementById('editCircuitTitle').value = circuit.title;
                document.getElementById('editCircuitHost').value = circuit.hostSchool;

                const preview = document.getElementById('editCircuitCoverPreview');
                if (circuit.coverImage) {
                    preview.style.backgroundImage = `url(${circuit.coverImage})`;
                    preview.innerHTML = '';
                } else {
                    preview.style.backgroundImage = 'none';
                    preview.innerHTML = '<span>+ Upload Image</span>';
                }

                // Set up the image uploader
                newCircuitCoverUrl = circuit.coverImage || '';
                preview.onclick = () => document.getElementById('editCircuitCoverInput').click();
                document.getElementById('editCircuitCoverInput').onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        newCircuitCoverUrl = e.target.result;
                        preview.style.backgroundImage = `url(${newCircuitCoverUrl})`;
                        preview.innerHTML = '';
                    };
                    reader.readAsDataURL(file);
                };

                showPage('edit-circuit-page');
            });
        }

        function handleEditCircuit() {
            const title = document.getElementById('editCircuitTitle').value.trim();
            const hostSchool = document.getElementById('editCircuitHost').value.trim();
            const coverImage = newCircuitCoverUrl;

            if (!title || !hostSchool) {
                showToast('Title and Host School cannot be empty.', 'error');
                return;
            }

            fetch(`${API_BASE_URL}/api/circuit/${currentCircuitId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ title: title, hostSchool: hostSchool, coverImage: coverImage })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.ok) {
                    showToast('Circuit updated successfully!', 'success');
                    showCircuit(currentCircuitId, title, hostSchool);
                } else {
                    showToast(body.error || 'Could not update circuit.', 'error');
                }
            })
            .catch(error => console.error("Error updating circuit:", error));
        }

        function closePostModal() {
            const modal = document.getElementById('post-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // In html.html

        function showLounge(loungeId, loungeName) {
            // Increment view count (fire-and-forget)
            fetch(`${API_BASE_URL}/api/lounge/${loungeId}/view`, { method: 'POST', headers: { 'Authorization': `Bearer ${apiToken}` } });

            // Leave previous socket room if applicable
            if (currentLoungeChannelId && socket) {
                socket.emit('leave_lounge_channel', { channel_id: currentLoungeChannelId });
            }
            currentLoungeId = loungeId;
            currentLoungeChannelId = null; // Reset current channel when entering a new lounge

            // Get references to UI elements
            const chatBody = document.getElementById('lounge-body');
            const chatInput = document.getElementById('lounge-input');
            const joinOverlay = document.getElementById('lounge-join-overlay');
            const loungeSidebar = document.querySelector('.lounge-sidebar');

            // Reset join button state if it exists
            const joinButton = document.getElementById('join-lounge-btn');
            if (joinButton) {
                joinButton.disabled = false;
                joinButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Join Lounge';
            }

            // --- REMOVED: chatBody.addEventListener('scroll', closeAllPopups); ---
            // This listener might be causing issues or be redundant if handled globally

            // Set initial visibility states
            chatBody.style.display = 'none'; // Hide body initially
            chatInput.style.display = 'none'; // Hide input initially
            joinOverlay.classList.remove('visible'); // Hide join overlay
            loungeSidebar.style.display = 'none'; // Hide sidebar initially

            // Update header and sidebar titles
            document.getElementById('lounge-header-title').textContent = loungeName;
            document.getElementById('lounge-sidebar-title').textContent = loungeName;
            document.getElementById('lounge-channels-list').innerHTML = '<li>Loading...</li>'; // Show loading in channel list

            showPage('lounge-page'); // Show the main lounge page structure
            initializeLoungeEmojiPicker(); // Make sure emoji picker is ready

            // Fetch channel and membership status
            fetch(`${API_BASE_URL}/api/lounge/${loungeId}/channels`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) { // Handle potential errors like lounge not found
                    showToast(data.error, 'error');
                    showPage('index-page'); // Go back home on error
                    return;
                }

                // --- Setup Header Buttons ---
                const headerRight = document.querySelector('#lounge-page .header-right');
                headerRight.innerHTML = ''; // Clear any old buttons

                // Add Invite button (only for owners/mods)
                if (data.user_role === 'owner' || data.user_role === 'moderator') {
                    const inviteBtn = document.createElement('div');
                    inviteBtn.className = 'profile-menu-button';
                    inviteBtn.innerHTML = '<i class="fas fa-user-plus"></i>';
                    inviteBtn.onclick = showInviteUserModal;
                    headerRight.appendChild(inviteBtn);
                }

                // Add the three-dot menu button
                const menuBtn = document.createElement('div');
                menuBtn.className = 'profile-menu-button';
                menuBtn.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
                menuBtn.onclick = toggleLoungeMenu; // Connects to the function that builds the menu
                headerRight.appendChild(menuBtn);

                // Add the (initially hidden) dropdown menu itself
                const menuDropdown = document.createElement('div');
                menuDropdown.id = 'lounge-menu-dropdown';
                menuDropdown.className = 'profile-menu-dropdown hidden';
                headerRight.appendChild(menuDropdown);
                // --- End Header Button Setup ---

                // --- Handle Member vs Non-Member View ---
                if (data.is_member) {
                    // User is a member, show the chat interface
                    chatBody.style.display = 'flex'; // Show chat body
                    chatInput.style.display = 'flex'; // Show chat input
                    joinOverlay.classList.remove('visible'); // Ensure join overlay is hidden
                    loungeSidebar.style.display = 'flex'; // Show the sidebar

                    currentUserLoungeRole = data.user_role; // Set the global role variable
                    console.log(`[Debug] Set currentUserLoungeRole in showLounge to: ${currentUserLoungeRole}`); // DEBUG LOG

                    renderLoungeChannels(data.channels); // Populate the channel list

                    // Load the first channel (usually #general) if one exists
                    if (data.channels.length > 0) {
                        loadLoungeChannel(data.channels[0]); // Load the main/first channel
                    } else {
                        // Display message if no channels exist
                        chatBody.innerHTML = '<p style="text-align:center;color:#888;">No channels have been created yet.</p>';
                        document.getElementById('lounge-input-field').placeholder = 'No channels available';
                        document.getElementById('lounge-input-field').disabled = true;
                    }
                } else {
                    // User is NOT a member, show the appropriate join overlay
                    chatBody.style.display = 'none'; // Keep chat hidden
                    chatInput.style.display = 'none'; // Keep input hidden
                    joinOverlay.classList.add('visible'); // Show the join overlay
                    loungeSidebar.style.display = 'none'; // Keep sidebar hidden

                    currentUserLoungeRole = null; // Ensure role is null
                    console.log(`[Debug] User is not a member, currentUserLoungeRole set to null.`); // DEBUG LOG

                    // Get lounge details (we might already have them in allLoungesData)
                    const loungeDetails = allLoungesData.find(l => l.id === loungeId);
                    if (loungeDetails) {
                        const joinTitle = document.getElementById('join-lounge-title');
                        const joinDesc = document.getElementById('join-lounge-description');
                        const joinIcon = document.getElementById('join-lounge-privacy-icon');
                        const joinBtn = document.getElementById('join-lounge-btn');

                        // Configure overlay based on privacy
                        if (loungeDetails.privacy === 'private') {
                            joinTitle.textContent = `"${loungeDetails.name}" is Private`;
                            joinDesc.textContent = 'This lounge is private. You can request access from the owner.';
                            joinIcon.className = 'fas fa-lock privacy-icon';
                            joinBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Request Access';
                            joinBtn.onclick = handleRequestLoungeAccess; // Point to request function
                            joinBtn.style.display = 'block';
                        } else { // Public or Unlisted
                            joinTitle.textContent = `You found the "${loungeDetails.name}" Lounge!`;
                            joinDesc.textContent = loungeDetails.description || 'Join this Lounge to view channels, see messages, and chat with other members.';
                            joinIcon.className = loungeDetails.privacy === 'unlisted' ? 'fas fa-link privacy-icon' : 'fas fa-globe-americas privacy-icon';
                            joinBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Join Lounge';
                            joinBtn.onclick = handleJoinLounge; // Point to join function
                            joinBtn.style.display = 'block';
                        }
                    } else {
                         // Fallback if details weren't pre-loaded (should be rare)
                         joinOverlay.innerHTML = '<p>Loading lounge details...</p>';
                    }
                }
            })
            .catch(error => { // Catch errors fetching channel/membership info
                console.error("Error loading lounge channels/status:", error);
                showToast("Could not load lounge information.", 'error');
                showPage('index-page'); // Go back home on error
            });
        }

        function handleLeaveLounge() {
            document.getElementById('lounge-menu-dropdown').classList.add('hidden');

            showConfirmationModal({
                title: 'Leave Lounge?',
                text: 'Are you sure you want to permanently leave this lounge?',
                onConfirm: () => {
                    // The fetch request is now inside the onConfirm callback
                    fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}/leave`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${apiToken}` }
                    })
                    .then(response => response.json().then(data => ({ status: response.status, body: data })))
                    .then(({ status, body }) => {
                        if (status === 200) {
                            showToast(body.message, 'success');
                            showPage('index-page');
                        } else {
                            showToast(body.error || 'Could not leave the lounge.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error leaving lounge:', error);
                        showToast('An unexpected error occurred. Please try again.', 'error');
                    });
                }
            });
        }

        function showImagePreview(base64Url, type) {
            const isDM = type === 'dm';
            const container = document.getElementById(isDM ? 'dm-image-preview-container' : 'lounge-image-preview-container');
            
            if (isDM) {
                dmImagePreviewUrl = base64Url;
            } else {
                loungeImagePreviewUrl = base64Url;
            }

            container.innerHTML = `
                <div class="image-preview-box">
                    <span class="remove-preview-btn" onclick="removeImagePreview('${type}')">&times;</span>
                    <img src="${base64Url}" class="preview-image">
                </div>
            `;
            container.classList.remove('hidden');
        }

        function showConfirmationModal({ title, text, onConfirm }) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;

            const confirmBtn = document.getElementById('confirm-modal-btn');

            // This is a clean way to replace old listeners to avoid bugs
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
                closeConfirmationModal();
            };

            modal.classList.remove('hidden');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }

        function removeImagePreview(type) {
            const isDM = type === 'dm';
            const container = document.getElementById(isDM ? 'dm-image-preview-container' : 'lounge-image-preview-container');

            if (isDM) {
                dmImagePreviewUrl = null;
            } else {
                loungeImagePreviewUrl = null;
            }
            
            container.innerHTML = '';
            container.classList.add('hidden');
        }

        function handleSetMainChannel(channelId) {
            fetch(`${API_BASE_URL}/api/lounge/channel/${channelId}/set-main`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    showToast(body.message, 'success');
                    // Refresh the whole lounge view to show the new channel order and icon
                    showLounge(currentLoungeId, document.getElementById('lounge-header-title').textContent);
                } else {
                    showToast(body.error || 'Could not update main channel.', 'error');
                }
            });
        }

        function openChannelContextMenu(event, channel) { // Takes the full channel object now
            event.stopPropagation();
            document.querySelectorAll('.context-menu').forEach(menu => menu.remove());

            const menu = document.createElement('div');
            menu.className = 'context-menu';

            let menuItems = '';
            if (currentUserLoungeRole === 'owner' || currentUserLoungeRole === 'moderator') {
                //  NEW LOGIC: Show "Make Main" only if it's NOT already main 
                if (!channel.is_main) {
                    menuItems += `<a class="context-menu-item" onclick="handleSetMainChannel(${channel.id})"><i class="fas fa-star" style="margin-right: 8px;"></i>Make Main Channel</a>`;
                }
                //  END NEW LOGIC 
                menuItems += `
                    <a class="context-menu-item" onclick="editLoungeChannel(${channel.id})">Edit Name</a>
                    <a class="context-menu-item danger" onclick="deleteLoungeChannel(${channel.id})">Delete Channel</a>
                `;
            } else {
                menuItems = `<a class="context-menu-item" onclick="showLoungeDetails()">Show Description</a>`;
            }
            menu.innerHTML = menuItems;

            document.body.appendChild(menu);

            // Positioning logic (unchanged)
            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            let x = event.pageX;
            let y = event.pageY;
            if (x + menuWidth > window.innerWidth) x -= menuWidth;
            if (y + menuHeight > window.innerHeight) y -= menuHeight;
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
        }

        function showLoungeMembers() {
            const modal = document.getElementById('lounge-members-modal');
            const list = document.getElementById('lounge-members-list');
            const footer = document.getElementById('lounge-members-modal-footer');

            // --- THIS IS THE FIX: The invite button is now permanently removed from this modal's footer ---
            footer.innerHTML = '';
            footer.style.display = 'none';
            // --- END OF FIX ---

            modal.classList.remove('hidden');
            list.innerHTML = '<li>Loading members...</li>';

            fetch(`${API_BASE_URL}/api/lounge/${currentLoungeId}/members`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
            .then(response => response.json())
            .then(members => {
                list.innerHTML = '';
                members.sort((a, b) => {
                    const roleOrder = { 'owner': 0, 'moderator': 1, 'member': 2 };
                    return roleOrder[a.role] - roleOrder[b.role];
                });

                members.forEach(member => {
                    const li = document.createElement('li');
                    li.className = 'following-list-item';
                    li.onclick = () => { closeLoungeMembersModal(); showProfile(member.username); };
                    li.oncontextmenu = (event) => openLoungeMemberMenu(event, member.username, member.role);
                    li.innerHTML = `
                        <div class="profile-pic" data-user-pic-id="${member.username}"></div>
                        <div class="user-info">
                            <span class="username">${member.fullName} <strong>(${member.role})</strong></span>
                            <span class="fullname">@${member.username}</span>
                        </div>`;
                    list.appendChild(li);
                    updateProfilePictures(member.username);
                });
            });
        }


        function showLoungeDetails() {
            const loungeName = document.getElementById('lounge-header-title').textContent;
            const loungeDescription = allLoungesData.find(l => l.id === currentLoungeId)?.description || "No description available.";

            document.getElementById('lounge-details-modal-title').textContent = loungeName;
            document.getElementById('lounge-details-modal-description').textContent = loungeDescription;
            document.getElementById('lounge-details-modal').classList.remove('hidden');
        }

        function closeLoungeMembersModal() { document.getElementById('lounge-members-modal').classList.add('hidden'); }
        function closeLoungeDetailsModal() { document.getElementById('lounge-details-modal').classList.add('hidden'); }

        // Add this click listener to close menus when clicking elsewhere
        document.addEventListener('click', () => {
            document.querySelectorAll('.context-menu').forEach(menu => menu.remove());
            document.getElementById('lounge-menu-dropdown').classList.add('hidden');
        });

        function handleTerminalCommand() {
            const inputField = document.getElementById('terminal-input');
            const outputContainer = document.getElementById('terminal-output');
            const commandText = inputField.value.trim();
            const userRank = profileData.me.rank;

            if (!commandText) return;

            const echoLine = document.createElement('div');
            echoLine.className = 'terminal-line command';
            echoLine.textContent = `> ${commandText}`;
            outputContainer.appendChild(echoLine);

            const parts = commandText.split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);
            const username = args[0];
            const message = args.slice(1).join(' ');

            const displayResult = (msg, isError = false) => {
                const resultLine = document.createElement('div');
                resultLine.className = isError ? 'terminal-line error' : 'terminal-line success';
                // Use <pre> to preserve whitespace and newlines for commands like /whois
                resultLine.innerHTML = `<pre>${msg}</pre>`;
                outputContainer.appendChild(resultLine);
                outputContainer.scrollTop = outputContainer.scrollHeight;
            };

            inputField.value = '';

            switch (command) {
                // --- Admin Only Commands ---
                case '/ban':
                    if (userRank !== 'admin') { displayResult('Error: Permission denied. Admin access required.', true); break; }
                    if (!username) { displayResult('Error: Usage: /ban <username> [reason...]', true); break; }
                    fetch(`${API_BASE_URL}/api/user/${username}/ban`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                        body: JSON.stringify({ reason: args.slice(1).join(' ') })
                    }).then(r => r.json()).then(d => displayResult(d.message || d.error, !d.ok));
                    break;

                case '/unban':
                    if (userRank !== 'admin') { displayResult('Error: Permission denied. Admin access required.', true); break; }
                    if (!username) { displayResult('Error: Usage: /unban <username>', true); break; }
                    fetch(`${API_BASE_URL}/api/user/${username}/unban`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${apiToken}` }
                    }).then(r => r.json()).then(d => displayResult(d.message || d.error, !d.ok));
                    break;

                case '/op':
                    if (userRank !== 'admin') { displayResult('Error: Permission denied. Admin access required.', true); break; }
                    if (args.length < 2) { displayResult('Error: Usage: /op <username> <rank>', true); break; }
                    handleRankChange(username, args[1]);
                    displayResult(`Executing rank change for ${username}...`);
                    break;

                // --- Admin & Moderator Commands ---
                case '/whois':
                    if (userRank !== 'admin' && userRank !== 'moderator') { displayResult('Error: Permission denied.', true); break; }
                    if (!username) { displayResult('Error: Usage: /whois <username>', true); break; }
                    fetch(`${API_BASE_URL}/api/user/${username}/whois`, {
                        headers: { 'Authorization': `Bearer ${apiToken}` }
                    }).then(r => r.json()).then(d => {
                        if (d.error) { displayResult(d.error, true); }
                        else { displayResult(`--- WHOIS: ${d.username} ---\nFull Name: ${d.fullName}\nEmail: ${d.email}\nRank: ${d.rank}\nSchool: ${d.school}\nJoined: ${new Date(d.join_date).toLocaleString()}\nBanned: ${d.is_banned ? `Yes (Reason: ${d.ban_reason || 'N/A'})` : 'No'}`); }
                    });
                    break;

                case '/warn':
                    if (userRank !== 'admin' && userRank !== 'moderator') { displayResult('Error: Permission denied.', true); break; }
                    if (!username || !message) { displayResult('Error: Usage: /warn <username> <message...>', true); break; }
                    fetch(`${API_BASE_URL}/api/dm/system-send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                        body: JSON.stringify({ to_username: username, message: `[WARNING] ${message}` })
                    }).then(r => r.json()).then(d => displayResult(d.message || d.error, !d.ok));
                    break;

                case '/broadcast':
                    if (userRank !== 'admin' && userRank !== 'moderator') { displayResult('Error: Permission denied.', true); break; }
                    if (args.length < 1) { displayResult('Error: Usage: /broadcast <message...>', true); break; }
                    fetch(`${API_BASE_URL}/api/dm/system-send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                        body: JSON.stringify({ broadcast: true, message: `[Broadcast] ${args.join(' ')}` })
                    }).then(r => r.json()).then(d => displayResult(d.message || d.error, !d.ok));
                    break;

                case '/message':
                    if (userRank !== 'admin' && userRank !== 'moderator') { displayResult('Error: Permission denied.', true); break; }
                    if (args.length < 2) { displayResult('Error: Usage: /message <username> <message...>', true); break; }
                    displayResult(`Note: This command is a prototype. In the future, it will send a real DM.`);
                    break;

                case '/circuit':
                    if (userRank !== 'admin' && userRank !== 'moderator') { displayResult('Error: Permission denied.', true); break; }
                    displayResult('Note: Circuit management via terminal is a prototype.');
                    break;

                case '/report':
                    if (userRank !== 'admin' && userRank !== 'moderator') { displayResult('Error: Permission denied.', true); break; }
                    if (args.length < 2) { displayResult('Error: Usage: /report <username> <reason...>', true); break; }
                    displayResult(`Success: Report against '${username}' has been logged.`);
                    break;

                case '/block':
                    if (userRank !== 'admin' && userRank !== 'moderator') { displayResult('Error: Permission denied.', true); break; }
                    if (!username) { displayResult('Error: Usage: /block <username>', true); break; }
                    blockUser(username);
                    displayResult(`Success: User '${username}' has been blocked locally.`);
                    break;

                // --- General Commands ---
                case 'clear':
                    outputContainer.querySelectorAll('.terminal-line:not(.terminal-header)').forEach(el => el.remove());
                    break;

                case 'help':
                    displayResult(
        `APEX VISUAL CONSOLE HELP
        --------------------------
        Admin Commands:
          /op <user> <rank>      - Change a user's rank.
          /ban <user> [reason]   - Ban a user from the platform.
          /unban <user>          - Lift a user's ban.

        Moderator & Admin Commands:
          /whois <user>          - Get detailed info about a user.
          /warn <user> <msg>     - Send an official warning DM.
          /broadcast <msg>       - Send a DM to all users.
          /report <user> <reason>- Log a report against a user.
          /block <user>          - Block a user (local effect).
          /message <user> <msg>  - (Prototype) Send a direct message.
          /circuit ...           - (Prototype) Manage circuits.

        General Commands:
          clear                  - Clears the terminal screen.
        `
                    );
                    break;

                default:
                    displayResult(`Error: Command '${command}' not recognized. Type 'help' for a list of commands.`, true);
                    break;
            }
        }

        function closeAllPopups() {
            // This function will find and remove any open reaction pickers.
            document.querySelectorAll('.reaction-picker').forEach(p => p.remove());
            
            // We can also close tooltips here for good measure
            hideReactionTooltip(); 
        }

        function handleLoungeImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // This reuses your existing processImage function
            processImage(file)
                .then(base64Image => {
                    // This shows the preview in the lounge's preview container
                    showImagePreview(base64Image, 'lounge'); 
                })
                .catch(err => console.error("Lounge image processing failed:", err));
            
            // Clear the input so you can select the same file again if needed
            event.target.value = null; 
        }

        function toggleLike(event, postId) {
            event.stopPropagation();
            const likeContainers = document.querySelectorAll(`[data-like-container-id="${postId}"]`);
            if (likeContainers.length === 0) return;

            const button = likeContainers[0].querySelector('.like-button');
            const isLiked = button.classList.contains('liked');
            const endpoint = isLiked ? 'unlike' : 'like';

            fetch(`${API_BASE_URL}/api/posts/${postId}/${endpoint}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiToken}` }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.ok) {
                    const post = currentCircuitPosts.find(p => p.id === postId);
                    if (post) {
                        post.likes = body.likes;
                        post.is_liked_by_me = !isLiked;
                    }
                    likeContainers.forEach(container => {
                        container.querySelector('.like-button').classList.toggle('liked');
                        container.querySelector('.like-count').textContent = body.likes;
                    });
                } else {
                    showToast(body.error || 'Action failed', 'error');
                }
            })
            .catch(err => console.error("Like error:", err));
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('message-notification-badge');
            const count = unreadSenders.size;

            if (count > 0) {
                badge.style.display = 'block';
                badge.textContent = count > 99 ? '99+' : count;
            } else {
                badge.style.display = 'none';
            }
        }

        function showPostModal(postIndex) {
            console.log(`[Debug] showPostModal called for index: ${postIndex}`); // <-- ADDED LOG

            if (postIndex < 0 || postIndex >= currentCircuitPosts.length) {
                console.error(`[Debug] Invalid postIndex: ${postIndex}, currentCircuitPosts length: ${currentCircuitPosts.length}`); // <-- ADDED LOG
                return;
            }

            const post = currentCircuitPosts[postIndex];
            if (!post) {
                 console.error(`[Debug] Post data not found for index: ${postIndex}`); // <-- ADDED LOG
                return;
            }

             if (!post.author) {
                 console.error(`[Debug] Post data for index ${postIndex} is missing author details!`, post); // <-- ADDED LOG
                 // Decide how to handle this - maybe show a placeholder or return?
                 // For now, let's try to continue but log the issue.
                 post.author = { username: 'unknown', fullName: 'Unknown Author', rank: 'user' }; // Placeholder
             }


            currentPostIndexInModal = postIndex; // Keep track of the current index

            const modal = document.getElementById('post-modal');
            const modalContent = document.getElementById('modal-content');
            if (!modal || !modalContent) {
                console.error("[Debug] Modal elements (#post-modal or #modal-content) not found!"); // <-- ADDED LOG
                return;
            }

            const timestamp = formatPostTimestamp(new Date(post.timestamp));
            const likedClass = post.is_liked_by_me ? 'liked' : '';
            const imageHTML = post.image ? `<img src="${post.image}" class="modal-post-image" alt="Post image">` : '';

            // Use optional chaining just in case author is still missing somehow
            const authorUsername = post.author?.username || 'unknown';
            const authorFullName = post.author?.fullName || 'Unknown Author';

            modalContent.innerHTML = `
                <p class="modal-post-timestamp">${timestamp}</p>
                <div class="modal-post-details">
                    ${imageHTML}
                    ${post.text ? `<p class="circuit-post-text">${linkifyUsernames(post.text)}</p>` : ''}
                    <div class="circuit-post-author">
                        <span>- ${authorFullName}</span>
                        <div class="profile-pic" data-user-pic-id="${authorUsername}"></div>
                    </div>
                    <div class="like-button-container" data-like-container-id="${post.id}">
                        <button class="like-button ${likedClass}" onclick="toggleLike(event, ${post.id})">
                            <i class="fas fa-heart"></i>
                        </button>
                        <span class="like-count">${post.likes}</span>
                    </div>
                </div>
            `;

            console.log("[Debug] Modal content set. Attempting to remove 'hidden' class..."); // <-- ADDED LOG
            modal.classList.remove('hidden');
            console.log("[Debug] 'hidden' class removed from modal. Modal hidden status:", modal.classList.contains('hidden')); // <-- ADDED LOG

            if (authorUsername !== 'unknown') {
                updateProfilePictures(authorUsername);
            }

            // Navigation buttons
            // Ensure button elements exist before trying to modify them
            const prevBtn = document.getElementById('modal-prev-btn');
            const nextBtn = document.getElementById('modal-next-btn');
            if(prevBtn && nextBtn) {
                prevBtn.style.display = postIndex > 0 ? 'block' : 'none';
                nextBtn.style.display = postIndex < currentCircuitPosts.length - 1 ? 'block' : 'none';
                prevBtn.onclick = () => showPostModal(postIndex - 1);
                nextBtn.onclick = () => showPostModal(postIndex + 1);
            } else {
                console.error("[Debug] Modal navigation buttons not found!"); // <-- ADDED LOG
            }
        }



        function showCreatePostPage(context) {
            postCreationContext = context;

            const postTextarea = document.getElementById('postText');
            const charCounter = document.getElementById('postCharCounter');

            postTextarea.value = '';
            charCounter.textContent = '0 / 600';
            postTextarea.oninput = () => {
                const currentLength = postTextarea.value.length;
                charCounter.textContent = `${currentLength} / 600`;
                charCounter.style.color = currentLength > 600 ? 'red' : '#888';
            };

            // --- ADD THIS UPLOADER LOGIC ---
            document.getElementById('postImageInput').value = null;
            const preview = document.getElementById('postImagePreview');
            preview.style.backgroundImage = 'none';
            preview.innerHTML = '<span>+ Add Photo</span>';
            newPostImageUrl = ''; // Use the existing global variable

            preview.onclick = () => document.getElementById('postImageInput').click();
            document.getElementById('postImageInput').onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    preview.style.backgroundImage = `url(${imageUrl})`;
                    preview.innerHTML = '';
                    newPostImageUrl = imageUrl;
                };
                reader.readAsDataURL(file);
            };
            // --- END OF NEW LOGIC ---

            // ... (rest of the function remains the same)
            showPage('create-post-page');
        }


        function handleCreatePost(button) {
            button.disabled = true;
            button.textContent = 'Posting...';

            const text = document.getElementById('postText').value.trim();
            const image = newPostImageUrl;

            if (!text && !image) {
                showToast('Please add some text or an image for your post.', 'error');
                button.disabled = false;
                button.textContent = 'Post';
                return;
            }
            if (!currentCircuitId) {
                showToast('Error: No circuit selected.', 'error');
                button.disabled = false;
                button.textContent = 'Post';
                return;
            }

            fetch(`${API_BASE_URL}/api/circuit/${currentCircuitId}/posts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiToken}` },
                body: JSON.stringify({ text: text, image: image })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 201) {
                    showToast('Post created successfully!', 'success');
                    fetch(`${API_BASE_URL}/api/circuit/${currentCircuitId}`, { headers: { 'Authorization': `Bearer ${apiToken}` } })
                    .then(res => res.json())
                    .then(circuitDetails => {
                        showCircuit(currentCircuitId, circuitDetails.title, circuitDetails.hostSchool);
                    });
                } else {
                    showToast('Error creating post: ' + (body.error || 'Unknown error.'), 'error');
                }
            })
            .catch(error => {
                console.error("Error creating post:", error);
                showToast("An error occurred. Could not create post.", 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Post';
            });
        }




        function renderAllProfiles() {
            const grid = document.getElementById('all-profiles-grid');
            grid.innerHTML = ''; // Clear the grid first

            Object.keys(profileData).forEach(key => {
                if (key === 'me' || key === 'APEX') return; // Changed from 'System'

                const user = profileData[key];
                const card = document.createElement('div');
                card.className = 'profile-grid-card';
                card.onclick = () => showProfile(key);

                const tagHtml = getAccountTypeTag(user.account_type);
                card.innerHTML = `
                    <div class="profile-pic" data-user-pic-id="${key}"></div>
                    <p class="profile-card-name">${user.name} ${getRankIcon(user.rank)} ${tagHtml}</p>
                    <p class="profile-card-username">@${user.username}</p>
                `;
                grid.appendChild(card);
                updateProfilePictures(key); // Update the pic and rank border
            });
        }

        // Replace your existing 'window.addEventListener' with this one
        window.addEventListener('load', () => {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
            initializeEventListeners();
            initializeEmojiPicker();

            // --- ADD THIS LINE TO SET THE MAX DATE ---
            document.getElementById('signupDOB').max = new Date().toISOString().split("T")[0];

            // Instead of showing the login page, we now check for a saved session
            checkForSavedSession();
        });

        // Run the update function every 30 seconds
        setInterval(updateLiveTimestamps, 1000);



    </script>

    <div id="explore-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Explore</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>

            
            <div class="content-section">
                <h3>Circuits</h3>
                <a href="#" class="more-link" onclick="showAllCircuitsPage()">More</a>
                <div class="profile-row-scroller">
                    <div id="explore-circuit-list" class="profile-row">
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <h3>My Lounges</h3>
                <a href="#" class="more-link" onclick="showMyLoungesPage()">More</a>
                <div class="profile-row-scroller">
                    <div id="explore-my-lounges-list" class="profile-row">
                        </div>
                </div>
            </div>
            <div class="content-section">
                <div class="section-header">
                    <h3>Recommended Articles</h3>
                    <div class="header-actions">
                        <a href="#" class="more-link" onclick="showAllArticlesPage()">More</a>
                        <button id="create-article-btn" class="login-btn" onclick="showPage('create-article-page')" style="display: none;">Create Article</button>
                    </div>
                </div>
                <ul id="article-grid" class="article-grid">
                    </ul>
            </div>

        </main>
    </div>



    <div id="article-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('explore-page')"><i class="fas fa-arrow-left"></i> Back to Explore</a>
            </div>
            <div class="header-center"></div>
            <div class="header-right"></div>
        </header>
        <main>
            <div class="content-section" style="max-width: 800px; margin: 0 auto;">
                <h2 id="article-title" style="font-size: 2em; margin-bottom: 5px;"></h2>
                <p id="article-meta" style="color: #888; margin-top: 0;"></p>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <div id="article-content"></div>
            </div>
        </main>
    </div>

    <div id="circuit-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('explore-page')"><i class="fas fa-arrow-left"></i> Back to Explore</a>
            </div>
            <div class="header-center">
                <p id="circuit-title-header"></p>
            </div>
            <div class="header-right">
                <button id="add-post-btn" class="login-btn" onclick="showCreatePostPage({ type: 'circuit', id: currentCircuitId })">+ Add Post</button>
            </div>
        </header>
        <main>
            <div class="circuit-info">
                <h2 id="circuit-title"></h2>
                <p id="circuit-meta"></p>
            </div>
            <div id="circuit-posts-grid" class="circuit-posts-grid">
                </div>
        </main>
    </div>

    <div id="create-circuit-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('explore-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>New Circuit</p></div>
            <div class="header-right">
                <button class="login-btn" onclick="handleCreateCircuit(this)">Create</button>
            </div>
        </header>
        <main>
            <div class="auth-form">
                <input type="text" id="circuitTitle" placeholder="Event Title" maxlength="30">
                <input type="text" id="circuitHost" placeholder="Association" maxlength="20">
                <div class="circuit-cover-uploader">
                    <label for="circuitCoverInput">Cover Image</label>
                    <div id="circuitCoverPreview" class="circuit-cover-preview">
                        <span>+ Upload Image</span>

             </div>
                    <input type="file" id="circuitCoverInput" accept="image/*" style="display: none;">
                </div>
            </div>
        </main>
    </div>

    <div id="create-post-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showCircuit(currentCircuitId)"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center"><p>New Post</p></div>
            <div class="header-right">
                <button class="login-btn" onclick="handleCreatePost(this)">Post</button>
            </div>
        </header>
        <main>
            <div class="auth-form">
                <textarea id="postText" placeholder="Write a caption..." rows="4" maxlength="600"></textarea>
                <div id="postCharCounter" class="char-counter">0 / 600</div>

                <div class="circuit-cover-uploader">
                    <div id="postImagePreview" class="circuit-cover-preview">
                        <span>+ Add Photo</span>
                    </div>
                    <input type="file" id="postImageInput" accept="image/*" style="display: none;">
                </div>
            </div>
        </main>
    </div>

    <div id="notifications-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Notifications</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <div class="content-section">
                <h2>Notifications</h2>
                <ul id="notifications-list" class="notifications-list">
                    <!-- Notifications will be loaded here by JavaScript -->
                </ul>
            </div>
        </main>
    </div>

    <div id="report-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Report an Issue</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <div class="content-section" style="max-width: 600px; margin: 20px auto;">
                <h2>Submit a Report</h2>
                <p style="color: #555;">Please fill out the form to address any issues or bugs.</p>

                <div class="report-form">
                    <label for="reportUsers">User(s) to Report</label>
                    <input type="text" id="reportUsers" placeholder="Enter username(s), or n/a">

                    <label for="reportIssueType">Type of Issue</label>
                    <select id="reportIssueType">
                        <option value="" disabled selected>Select a category...</option>
                        <option value="Inappropriate Content">Inappropriate Content</option>
                        <option value="Disrespectful Behavior">Disrespectful Behavior</option>
                        <option value="Hacking / Exploits">Hacking / Exploits</option>
                        <option value="Plagiarism">Plagiarism</option>
                        <option value="Imitation of Others">Imitation of Others</option>
                        <option value="Spam">Spam</option>
                        <option value="Other">Other</option>
                    </select>

                    <label for="reportDescription">Description of Issue</label>
                    <textarea id="reportDescription" placeholder="Please provide a detailed description of what happened..." rows="6"></textarea>

                    <label for="reportEvidenceInput">Attach Evidence (optional)</label>
                    <div id="reportEvidencePreview" class="circuit-cover-preview" style="height: 150px; position: relative;">
                        <span>+ Upload Image</span>
                    </div>
                    <input type="file" id="reportEvidenceInput" accept="image/*" style="display: none;">

                    <div class="report-confirm-container">
                        <input type="checkbox" id="reportConfirm">
                        <label for="reportConfirm">I confirm this report is truthful and made in good faith.</label>
                    </div>

                    <button class="report-submit-btn" onclick="submitReport()">Submit Report</button>
                </div>
            </div>
        </main>
    </div>

    <div id="loader">
    <!-- From Uiverse.io by Nawsome -->
    <div class="loader">
        <div>
            <ul>
            <li>
                <svg fill="currentColor" viewBox="0 0 90 120">
                <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                </svg>
            </li>
            <li>
                <svg fill="currentColor" viewBox="0 0 90 120">
                <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                </svg>
            </li>
            <li>
                <svg fill="currentColor" viewBox="0 0 90 120">
                <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                </svg>
            </li>
            <li>
                <svg fill="currentColor" viewBox="0 0 90 120">
                <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                </svg>
            </li>
            <li>
                <svg fill="currentColor" viewBox="0 0 90 120">
                <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                </svg>
            </li>
            <li>
                <svg fill="currentColor" viewBox="0 0 90 120">
                <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                </svg>
            </li>
            </ul>
        </div><span>Loading</span></div>
    </div>
    <div id="post-modal" class="post-modal hidden">
        <span id="close-modal-btn" class="close-modal-btn">&times;</span>
        <button id="modal-prev-btn" class="modal-nav-btn prev">&lt;</button>
        <button id="modal-next-btn" class="modal-nav-btn next">&gt;</button>

        <div id="modal-content" class="modal-content">
            </div>
    </div>
        <div id="terminal-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('index-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Terminal</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main class="terminal-main">
            <div id="terminal-output" class="terminal-output">
                <div class="terminal-line terminal-header">Visual Console Prompts<br>Copyright Prototype Neo Industries. All rights reserved.<br>Enter help for a list of commands.</div>
            </div>
            <div class="terminal-input-line">
                <span class="terminal-prompt">&gt;</span>
                <input type="text" id="terminal-input" class="terminal-input" autofocus autocomplete="off">
            </div>
        </main>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <span class="version-label">Version i2.0.2</span>
            </div>
            <div class="footer-links">
                <a href="#" onclick="showPage('index-page')">Home</a>
                <a href="#">About</a>
                <a href="#" onclick="event.preventDefault(); showTosPage();">Terms</a>
                <a href="#" onclick="showPage('contact-page')">Contact</a>
            </div>
            <p class="copyright">&copy; 2025 APEX. All rights reserved.</p>
        </div>
    </footer>

    <div id="verify-page" class="page">
        <header>
            <div class="header-left">
                <a href="#" class="fancy-back-button" onclick="showPage('signup-page')"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
            <div class="header-center">
                <p>Verify Your Email</p>
            </div>
            <div class="header-right"></div>
        </header>
        <main>
            <div class="auth-form" style="text-align: center;">
                <h2>Check Your Email</h2>
                <p style="color: #555;">We've sent a 6-digit verification code to <strong id="verify-email-display">your email</strong>.</p>
                <p style="color: #555;">Enter the code below:</p>

                <div class="code-input-container">
                    <input type="text" id="verificationCodeInput" placeholder="------"
                        maxlength="6" inputmode="numeric" autocomplete="one-time-code">
                    <div id="error-verificationCodeInput" class="form-error-message" style="margin-top: 5px;"></div>
                </div>

                <button onclick="handleVerifyCode(this)">Verify Code</button>

                <a href="#" onclick="resendVerificationCode()">Resend Code</a>
            </div>
        </main>
    </div>
    <div id="following-modal" class="following-modal hidden">
            <div class="following-modal-content">
                <div class="following-modal-header">
                    <span>Following</span>
                    <span class="close-following-modal" onclick="closeFollowingModal()">&times;</span>
                </div>
                <ul id="following-list-container" class="following-list">
                    </ul>
            </div>
        </div>
        <div id="circuit-details-modal" class="following-modal hidden" onclick="if (event.target === this) closeCircuitDetailsModal();">
            <div class="following-modal-content" style="max-width: 350px;">
                <div class="following-modal-header">
                    <span>Circuit Details</span>
                    <span class="close-following-modal" onclick="closeCircuitDetailsModal()">&times;</span>
                </div>
                <div id="circuit-details-body" style="padding: 20px; line-height: 1.6;">
                    </div>
            </div>
        </div>
        <div id="new-chat-modal" class="following-modal hidden">
        <div class="following-modal-content">
            <div class="following-modal-header">
                <span>New Message</span>
                <span class="close-following-modal" onclick="closeNewChatModal()">&times;</span>
            </div>
            <ul id="new-chat-user-list" class="following-list">
                </ul>
            <div style="padding: 15px; border-top: 1px solid #dbdbdb; text-align: right;">
                <button id="start-chat-btn" class="login-btn" onclick="initiateChat()" disabled>
                    Start Chat
                </button>
            </div>
        </div>
    </div>
    <div id="lounge-members-modal" class="following-modal hidden">
        <div class="following-modal-content">
            <div class="following-modal-header">
                <span>Lounge Members</span>
                <span class="close-following-modal" onclick="closeLoungeMembersModal()">&times;</span>
            </div>
            <ul id="lounge-members-list" class="following-list">
                </ul>
            <div id="lounge-members-modal-footer" style="padding: 15px; border-top: 1px solid #dbdbdb; text-align: center; display: none;">
                </div>
        </div>
    </div>

    <div id="lounge-details-modal" class="following-modal hidden">
        <div class="following-modal-content" style="max-width: 400px; padding: 20px;">
            <div class="following-modal-header">
                <span id="lounge-details-modal-title">Lounge Details</span>
                <span class="close-following-modal" onclick="closeLoungeDetailsModal()">&times;</span>
            </div>
            <p id="lounge-details-modal-description" style="line-height: 1.6; margin-top: 15px;"></p>
        </div>
    </div>
    <div id="create-channel-modal" class="following-modal hidden">
        <div class="following-modal-content" style="max-width: 450px;">
            <div class="following-modal-header">
                <span>Create Channel</span>
                <span class="close-following-modal" onclick="closeCreateChannelModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <label for="new-channel-name" style="font-weight: bold; display: block; margin-bottom: 10px;">CHANNEL NAME</label>
                <input type="text" id="new-channel-name" placeholder="new-channel" style="width: 95%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">

                <label style="font-weight: bold; display: block; margin-top: 20px; margin-bottom: 10px;">PERMISSIONS</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label><input type="radio" name="channel-permission" value="public" checked> Public (Everyone can view and chat)</label>
                    <label><input type="radio" name="channel-permission" value="mods_only_chat"> Read-Only (Everyone can view, only mods can chat)</label>
                    <label><input type="radio" name="channel-permission" value="mods_only_view"> Private (Only mods can view and chat)</label>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid #dbdbdb; text-align: right;">
                <button class="login-btn" onclick="handleCreateChannel()">Create</button>
            </div>
        </div>
    </div>
    <div id="invite-lounge-member-modal" class="following-modal hidden" onclick="if (event.target === this) closeInviteUserModal();">
        <div class="following-modal-content">
            <div class="following-modal-header">
                <span>Invite Member</span>
                <span class="close-following-modal" onclick="closeInviteUserModal()">&times;</span>
            </div>

            <div class="modal-search-bar-container">
                <div class="group">
                    <svg class="icon" aria-hidden="true" viewBox="0 0 24 24"><g><path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path></g></svg>
                    <input placeholder="Search for a user..." type="search" class="input" id="invite-user-search">
                </div>
            </div>

            <ul id="invite-user-list" class="following-list">
                </ul>
            <div style="padding: 15px; border-top: 1px solid #dbdbdb; text-align: right;">
                <button id="send-invite-btn" class="login-btn" onclick="handleSendLoungeInvite()" disabled>
                    Send Invite
                </button>
            </div>
        </div>
    </div>
    <div id="image-viewer-modal" class="following-modal hidden" onclick="closeImageViewer()">
        <img id="image-viewer-content" src="" alt="Full-size image view" onclick="event.stopPropagation()">
    </div>
    </body>
</html>